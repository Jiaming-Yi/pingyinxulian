<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>桐桐汉语拼音智能训练系统</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft YaHei", "SimHei", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* 导航标签 */
        .nav-tabs {
            max-width: 1200px;
            margin: 0 auto 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            background: rgba(255,255,255,0.9);
            padding: 15px 30px;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .nav-tab.active {
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-tab:hover {
            background: white;
        }
        
        /* 屏幕容器 */
        .screen {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 0 20px 20px 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .screen.active {
            display: block;
        }
        
        /* 选择界面 */
        .title {
            text-align: center;
            color: #2c3e50;
            font-size: 36px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            font-size: 16px;
            margin-bottom: 30px;
        }
        
        .mode-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .mode-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 30px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .mode-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .mode-btn.random {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            grid-column: span 3;
        }
        
        .stats {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .stats h3 {
            color: #34495e;
            margin-bottom: 10px;
        }
        
        .stats ul {
            list-style: none;
            padding: 0;
        }
        
        .stats li {
            padding: 5px 0;
            color: #555;
            font-size: 14px;
        }
        
        /* 训练表单 */
        .training-container {
            max-width: 100%;
        }
        
        .training-header {
            text-align: center;
            margin-bottom: 20px;
            page-break-after: avoid;
        }
        
        .training-header h2 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .training-info {
            font-size: 14px;
            color: #666;
            margin: 10px 0;
        }
        
        .training-id {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .training-type {
            display: inline-block;
            background: #e74c3c;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .training-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .training-item {
            border: 2px solid #bdc3c7;
            padding: 10px;
            border-radius: 8px;
            background: #f8f9fa;
            min-height: 85px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .pinyin {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            color: #2c3e50;
            margin-bottom: 8px;
            font-family: "Arial", "Microsoft YaHei", sans-serif;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .checkboxes {
            display: flex;
            justify-content: center;
            gap: 12px;
            font-size: 13px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .correct {
            color: #27ae60;
            font-weight: bold;
        }
        
        .wrong {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .action-buttons {
            text-align: center;
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .action-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .action-btn.success {
            background: #27ae60;
        }
        
        .action-btn.success:hover {
            background: #229954;
        }
        
        .action-btn.warning {
            background: #e67e22;
        }
        
        .action-btn.warning:hover {
            background: #d35400;
        }
        
        .action-btn.secondary {
            background: #95a5a6;
        }
        
        .action-btn.secondary:hover {
            background: #7f8c8d;
        }
        
        /* 录入界面 */
        .input-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .input-item {
            border: 3px solid #bdc3c7;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
            cursor: default;
            transition: all 0.3s;
        }
        
        .input-item:hover {
            border-color: #3498db;
            transform: translateY(-1px);
        }
        
        .input-item.correct {
            border-color: #27ae60;
            background: #d5f4e6;
        }
        
        .input-item.wrong {
            border-color: #e74c3c;
            background: #fadbd8;
        }
        
        .input-item .pinyin {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .input-status {
            text-align: center;
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 8px;
        }
        
        .input-item.correct .input-status {
            color: #27ae60;
            font-weight: bold;
        }
        
        .input-item.wrong .input-status {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .mark-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .mark-btn {
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
        }
        .mark-btn.correct { background: #27ae60; color: #fff; }
        .mark-btn.wrong { background: #e74c3c; color: #fff; }
        
        /* 历史记录 */
        .history-list {
            margin: 20px 0;
        }
        
        .history-item {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 5px solid #3498db;
        }
        
        .history-item h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-meta {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .history-stats {
            display: flex;
            gap: 20px;
            margin: 10px 0;
        }
        
        .stat-box {
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .stat-box.correct {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .stat-box.wrong {
            background: #fadbd8;
            color: #e74c3c;
        }
        
        .stat-box.rate {
            background: #dfe6e9;
            color: #2c3e50;
        }
        
        .history-details {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        
        .history-details.show {
            display: block;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
        }
        
        .detail-item {
            padding: 5px;
            text-align: center;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .detail-item.correct {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .detail-item.wrong {
            background: #fadbd8;
            color: #e74c3c;
        }
        
        /* 拼音库 */
        .library-section {
            margin-bottom: 40px;
        }
        
        .library-section h2 {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
        }
        
        .library-section h3 {
            color: #555;
            font-size: 18px;
            margin: 20px 0 10px;
        }
        
        .pinyin-showcase {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .showcase-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .showcase-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .showcase-item.shengmu {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .showcase-item.danyunmu {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .showcase-item.shuangyunmu {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .showcase-item.biyunmu {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .showcase-item.zhengti {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        .library-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 30px;
        }
        
        .library-stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #3498db;
        }
        
        .library-stat-card h4 {
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .library-stat-card .count {
            font-size: 36px;
            font-weight: bold;
            color: #3498db;
        }
        
        /* OCR上传 */
        .upload-area {
            border: 3px dashed #bdc3c7;
            padding: 40px;
            text-align: center;
            border-radius: 10px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: #3498db;
            background: #ecf0f1;
        }
        
        .upload-area.dragover {
            border-color: #27ae60;
            background: #d5f4e6;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .preview-image {
            max-width: 100%;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .ocr-progress {
            display: none;
            margin: 20px 0;
        }
        
        .ocr-progress.show {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #ecf0f1;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        /* 统计分析 */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        
        .analytics-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }
        
        .analytics-card h3 {
            font-size: 16px;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .analytics-card .number {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        /* 驾驶舱样式 */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        
        .panel {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            padding: 16px;
        }
        
        .panel h3 {
            color: #2c3e50;
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .top-list {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 8px 12px;
            align-items: center;
        }
        
        .top-list .item {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .muted {
            color: #7f8c8d;
            font-size: 12px;
        }
        
        /* 打印样式 */
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .nav-tabs, .action-buttons {
                display: none !important;
            }
            
            .screen {
                box-shadow: none;
                margin: 0;
                padding: 10mm;
                max-width: 100%;
            }
            
            .training-grid {
                gap: 8px;
            }
            
            .training-item {
                padding: 8px;
                min-height: 70px;
            }
            
            .pinyin {
                font-size: 20px;
            }
        }
        
        @page {
            size: A4;
            margin: 10mm;
        }

        /* 设置界面 */
        .settings-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .setting-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .setting-card h3 {
            color: #2c3e50;
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .setting-item {
            margin: 20px 0;
        }
        
        .setting-item label {
            display: block;
            color: #555;
            font-size: 16px;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .setting-item input[type="text"],
        .setting-item input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .setting-item input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .setting-item .hint {
            color: #7f8c8d;
            font-size: 13px;
            margin-top: 5px;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .sync-status.success {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .sync-status.error {
            background: #fadbd8;
            color: #e74c3c;
        }
        
        .sync-status.info {
            background: #dfe6e9;
            color: #2c3e50;
        }
        
        .sync-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .sync-button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .sync-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .sync-button.success {
            background: #27ae60;
        }
        
        .sync-button.warning {
            background: #e67e22;
        }
        
        /* 逐项统计表 */
        .table-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin: 10px 0 6px 0;
        }
        .table-controls input, .table-controls select {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .table-wrap {
            overflow: auto;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        table.elem-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
        }
        .elem-table th, .elem-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #f2f2f2;
            white-space: nowrap;
            text-align: left;
            font-size: 14px;
        }
        .elem-table th { background: #fafafa; color:#2c3e50; }
    </style>
</head>
<body>
    <!-- 导航标签 -->
    <div class="nav-tabs">
        <div class="nav-tab active" onclick="switchScreen('training')">🎓 开始训练</div>
        <div class="nav-tab" onclick="switchScreen('input')">📝 录入结果</div>
        <div class="nav-tab" onclick="switchScreen('ocr')">📷 拍照识别</div>
        <div class="nav-tab" onclick="switchScreen('history')">📊 历史记录</div>
        <div class="nav-tab" onclick="switchScreen('library')">📚 拼音库</div>
        <div class="nav-tab" onclick="switchScreen('dashboard')">📈 驾驶舱</div>
        <div class="nav-tab" onclick="switchScreen('settings')">⚙️ 设置</div>
    </div>

    <!-- 1. 训练模式选择 -->
    <div class="screen active" id="trainingScreen">
        <div id="selectionView">
            <h1 class="title">🎓 桐桐拼音训练系统</h1>
            <p class="subtitle">选择训练模式，系统将自动生成一页训练表单（8行×4列=32个）</p>
            
            <div class="mode-buttons">
                <button class="mode-btn" onclick="startTraining('shengmu')">
                    📝 声母训练<br>
                    <span style="font-size: 16px; opacity: 0.9;">23个声母</span>
                </button>
                
                <button class="mode-btn" onclick="startTraining('danyunmu')">
                    📝 单韵母训练<br>
                    <span style="font-size: 16px; opacity: 0.9;">24个（6×4声调）</span>
                </button>
                
                <button class="mode-btn" onclick="startTraining('shuangyunmu')">
                    📝 复韵母训练<br>
                    <span style="font-size: 16px; opacity: 0.9;">36个（9×4声调）</span>
                </button>
                
                <button class="mode-btn" onclick="startTraining('biyunmu')">
                    📝 鼻韵母训练<br>
                    <span style="font-size: 16px; opacity: 0.9;">36个（9×4声调）</span>
                </button>
                
                <button class="mode-btn" onclick="startTraining('zhengti')">
                    📝 整体认读<br>
                    <span style="font-size: 16px; opacity: 0.9;">64个（16×4声调）</span>
                </button>
                
                <button class="mode-btn random" onclick="startTraining('random')">
                    🎲 随机训练<br>
                    <span style="font-size: 16px; opacity: 0.9;">混合所有内容</span>
                </button>
            </div>
            
            <div class="stats">
                <h3>📊 训练库统计</h3>
                <ul>
                    <li>✓ 声母：23个</li>
                    <li>✓ 单韵母（含声调）：24个（6个 × 4声调）</li>
                    <li>✓ 复韵母（含声调）：36个（9个 × 4声调）</li>
                    <li>✓ 鼻韵母（含声调）：36个（9个 × 4声调）</li>
                    <li>✓ 整体认读音节（含声调）：64个（16个 × 4声调）</li>
                    <li>✓ 总计：183个训练项</li>
                    <li>✓ 每页显示：32个训练项（8行×4列）</li>
                </ul>
            </div>
        </div>
        
        <div id="trainingView" style="display: none;">
            <div class="training-header">
                <h2>桐桐拼音训练记录表</h2>
                <div class="training-info">
                    训练日期：________年____月____日　　训练者：__________
                </div>
                <div class="training-id" id="trainingId"></div>
                <div class="training-type" id="trainingType"></div>
            </div>
            
            <div class="training-grid" id="trainingGrid"></div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="window.print()">🖨️ 打印表单</button>
                <button class="action-btn success" onclick="goToInput()">✍️ 开始录入结果</button>
                <button class="action-btn" onclick="regenerate()">🔄 重新生成</button>
                <button class="action-btn secondary" onclick="backToSelection()">← 返回选择</button>
            </div>
        </div>
    </div>

    <!-- 2. 手动录入界面 -->
    <div class="screen" id="inputScreen">
        <h1 class="title">📝 手动录入训练结果</h1>
        <p class="subtitle">点击拼音框选择"对"或"错"，完成后保存到结果库</p>
        
        <div id="inputContent">
            <p style="text-align: center; color: #7f8c8d; font-size: 16px; padding: 40px;">
                请先在"开始训练"标签中生成训练表单
            </p>
        </div>
        
        <div class="action-buttons" id="inputActions" style="display: none;">
            <button class="action-btn success" onclick="saveResults()">💾 保存结果</button>
            <button class="action-btn secondary" onclick="clearInput()">🔄 清除选择</button>
        </div>
    </div>

    <!-- 3. 拍照OCR识别 -->
    <div class="screen" id="ocrScreen">
        <h1 class="title">📷 拍照识别训练结果</h1>
        <p class="subtitle">上传训练表单照片，系统将自动识别勾选结果</p>
        
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon">📸</div>
            <h3>点击或拖拽上传照片</h3>
            <p style="color: #7f8c8d; margin-top: 10px;">支持 JPG、PNG 格式</p>
            <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
        </div>
        
        <img id="previewImage" class="preview-image" style="display: none;">
        
        <div class="ocr-progress" id="ocrProgress">
            <h3 style="text-align: center; color: #2c3e50; margin-bottom: 10px;">正在识别...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <p id="ocrStatus" style="text-align: center; color: #7f8c8d; margin-top: 10px;"></p>
        </div>
        
        <div id="ocrResults" style="display: none;">
            <h3 style="color: #2c3e50; margin: 20px 0;">识别结果（请核对并修正）</h3>
            <div id="ocrResultGrid"></div>
            <div class="action-buttons">
                <button class="action-btn success" onclick="saveOCRResults()">💾 确认并保存</button>
                <button class="action-btn warning" onclick="resetOCR()">🔄 重新上传</button>
            </div>
        </div>
        
        <div class="stats" style="margin-top: 30px;">
            <h3>💡 使用提示</h3>
            <ul>
                <li>1. 确保照片清晰，光线充足</li>
                <li>2. 尽量保持表单平整，避免倾斜</li>
                <li>3. 训练表单ID要清晰可见</li>
                <li>4. 识别后请仔细核对结果</li>
                <li>5. OCR识别可能不完全准确，建议人工复核</li>
            </ul>
        </div>
    </div>

    <!-- 4. 历史记录 -->
    <div class="screen" id="historyScreen">
        <h1 class="title">📊 训练历史记录</h1>
        
        <div class="analytics-grid" id="analyticsGrid">
            <div class="analytics-card">
                <h3>总训练次数</h3>
                <div class="number" id="totalTrainings">0</div>
            </div>
            <div class="analytics-card">
                <h3>总训练项数</h3>
                <div class="number" id="totalItems">0</div>
            </div>
            <div class="analytics-card">
                <h3>平均正确率</h3>
                <div class="number" id="avgAccuracy">0%</div>
            </div>
        </div>
        
        <h2 style="color: #2c3e50; margin: 30px 0 20px;">训练记录列表</h2>
        <div class="history-list" id="historyList">
            <p style="text-align: center; color: #7f8c8d; padding: 40px;">暂无训练记录</p>
        </div>
    </div>

    <!-- 5. 拼音库 -->
    <div class="screen" id="libraryScreen">
        <h1 class="title">📚 完整拼音库</h1>
        <p class="subtitle">汉语拼音全部内容一览</p>
        
        <!-- 声母 -->
        <div class="library-section">
            <h2>📝 声母（23个）</h2>
            <div class="pinyin-showcase" id="shengmuShowcase"></div>
        </div>
        
        <!-- 单韵母 -->
        <div class="library-section">
            <h2>📝 单韵母（6个基础 × 4声调 = 24个）</h2>
            <h3>ā - a的四个声调</h3>
            <div class="pinyin-showcase">
                <div class="showcase-item danyunmu">ā</div>
                <div class="showcase-item danyunmu">á</div>
                <div class="showcase-item danyunmu">ǎ</div>
                <div class="showcase-item danyunmu">à</div>
            </div>
            <h3>ō - o的四个声调</h3>
            <div class="pinyin-showcase">
                <div class="showcase-item danyunmu">ō</div>
                <div class="showcase-item danyunmu">ó</div>
                <div class="showcase-item danyunmu">ǒ</div>
                <div class="showcase-item danyunmu">ò</div>
            </div>
            <h3>ē - e的四个声调</h3>
            <div class="pinyin-showcase">
                <div class="showcase-item danyunmu">ē</div>
                <div class="showcase-item danyunmu">é</div>
                <div class="showcase-item danyunmu">ě</div>
                <div class="showcase-item danyunmu">è</div>
            </div>
            <h3>ī - i的四个声调</h3>
            <div class="pinyin-showcase">
                <div class="showcase-item danyunmu">ī</div>
                <div class="showcase-item danyunmu">í</div>
                <div class="showcase-item danyunmu">ǐ</div>
                <div class="showcase-item danyunmu">ì</div>
            </div>
            <h3>ū - u的四个声调</h3>
            <div class="pinyin-showcase">
                <div class="showcase-item danyunmu">ū</div>
                <div class="showcase-item danyunmu">ú</div>
                <div class="showcase-item danyunmu">ǔ</div>
                <div class="showcase-item danyunmu">ù</div>
            </div>
            <h3>ǖ - ü的四个声调</h3>
            <div class="pinyin-showcase">
                <div class="showcase-item danyunmu">ǖ</div>
                <div class="showcase-item danyunmu">ǘ</div>
                <div class="showcase-item danyunmu">ǚ</div>
                <div class="showcase-item danyunmu">ǜ</div>
            </div>
        </div>
        
        <!-- 复韵母 -->
        <div class="library-section">
            <h2>📝 复韵母（9个基础 × 4声调 = 36个）</h2>
            <div class="pinyin-showcase" id="shuangyunmuShowcase"></div>
        </div>
        
        <!-- 鼻韵母 -->
        <div class="library-section">
            <h2>📝 鼻韵母（9个基础 × 4声调 = 36个）</h2>
            <h3>前鼻韵母（5个）</h3>
            <div class="pinyin-showcase" id="qianbiyunmuShowcase"></div>
            <h3 style="margin-top: 20px;">后鼻韵母（4个）</h3>
            <div class="pinyin-showcase" id="houbiyunmuShowcase"></div>
        </div>
        
        <!-- 整体认读音节 -->
        <div class="library-section">
            <h2>📝 整体认读音节（16个基础 × 4声调 = 64个）</h2>
            <div class="pinyin-showcase" id="zhengtiShowcase"></div>
        </div>
        
        <!-- 统计汇总 -->
        <div class="library-stats">
            <div class="library-stat-card">
                <h4>📊 拼音库总览</h4>
                <div class="count">183</div>
                <p style="color: #7f8c8d; margin-top: 10px;">个训练项</p>
            </div>
            <div class="library-stat-card">
                <h4>🎯 训练组合</h4>
                <ul style="list-style: none; padding: 0; color: #555; font-size: 14px; line-height: 1.8;">
                    <li>✓ 声母：23个</li>
                    <li>✓ 单韵母：24个</li>
                    <li>✓ 复韵母：36个</li>
                    <li>✓ 鼻韵母：36个</li>
                    <li>✓ 整体认读：64个</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 6. 设置界面 -->
    <div class="screen" id="settingsScreen">
        <h1 class="title">⚙️ 系统设置</h1>
        <p class="subtitle">配置GitHub同步，实现多设备数据共享</p>
        
        <div class="settings-container">
            <!-- GitHub同步设置 -->
            <div class="setting-card">
                <h3>🔗 GitHub数据同步</h3>
                <p style="color: #7f8c8d; margin-bottom: 20px; line-height: 1.6;">
                    配置GitHub Personal Access Token后，您的训练数据将自动同步到GitHub仓库，
                    在任何设备上都能访问相同的训练记录。
                </p>
                
                <div class="setting-item">
                    <label>GitHub Personal Access Token</label>
                    <input type="password" id="githubToken" placeholder="输入您的GitHub Token">
                    <div class="hint">
                        <a href="https://github.com/settings/tokens/new" target="_blank" style="color: #3498db;">点击这里创建Token</a>
                        （需要勾选 repo 权限）
                    </div>
                </div>
                
                <div class="setting-item">
                    <label>GitHub用户名</label>
                    <input type="text" id="githubUsername" placeholder="例如: Jiaming-Yi" value="Jiaming-Yi">
                </div>
                
                <div class="setting-item">
                    <label>仓库名称</label>
                    <input type="text" id="githubRepo" placeholder="例如: pingyinxulian" value="pingyinxulian">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="sync-button" onclick="saveGitHubConfig()">💾 保存配置</button>
                    <button class="sync-button success" onclick="syncToGitHub()">☁️ 上传数据到GitHub</button>
                    <button class="sync-button warning" onclick="syncFromGitHub()">⬇️ 从GitHub下载数据</button>
                </div>
                
                <div id="syncStatus" style="display: none;" class="sync-status"></div>
            </div>
            
            <!-- 数据管理 -->
            <div class="setting-card">
                <h3>📦 数据管理</h3>
                
                <div class="setting-item">
                    <label>本地数据</label>
                    <div id="localDataInfo" style="color: #7f8c8d; margin: 10px 0;"></div>
                    <button class="sync-button" onclick="exportLocalData()">📥 导出本地数据</button>
                    <button class="sync-button warning" onclick="clearLocalData()">🗑️ 清除本地数据</button>
                </div>
            </div>
            
            <!-- 使用说明 -->
            <div class="setting-card">
                <h3>💡 使用说明</h3>
                <ol style="color: #555; line-height: 2; padding-left: 20px;">
                    <li>访问 <a href="https://github.com/settings/tokens/new" target="_blank" style="color: #3498db;">GitHub Token页面</a> 创建新Token</li>
                    <li>Token名称随意，有效期建议选择90天或更长</li>
                    <li>勾选 <strong>repo</strong> 权限（完整的仓库访问权限）</li>
                    <li>点击生成Token，复制Token（注意：只显示一次！）</li>
                    <li>回到本页面，粘贴Token并保存配置</li>
                    <li>首次使用点击"上传数据到GitHub"</li>
                    <li>在其他设备使用时，点击"从GitHub下载数据"即可同步</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- 驾驶舱 -->
    <div class="screen" id="dashboardScreen">
        <h1 class="title">📈 学习驾驶舱</h1>
        <p class="subtitle">实时查看训练进展、趋势与易错项</p>
        
        <div class="analytics-grid" id="dashboardKpis">
            <div class="analytics-card">
                <h3>累计训练次数</h3>
                <div class="number" id="kpiTotalTimes">0</div>
            </div>
            <div class="analytics-card">
                <h3>累计训练项数</h3>
                <div class="number" id="kpiTotalItems">0</div>
            </div>
            <div class="analytics-card">
                <h3>平均正确率</h3>
                <div class="number" id="kpiAvgRate">0%</div>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <div class="panel">
                <h3>近7天训练趋势</h3>
                <canvas id="trendChart" width="800" height="300"></canvas>
                <div class="muted" id="trendHint">显示每日训练项数与正确率（%）</div>
            </div>
            <div class="panel">
                <h3>易错Top 10</h3>
                <div class="top-list" id="topMistakes">
                    <!-- 动态填充：拼音 | 错误次数 | 正确率 -->
                </div>
            </div>
        </div>
        
        <div class="panel" style="margin-top: 16px;">
            <h3>按训练类型统计</h3>
            <canvas id="typeChart" width="1000" height="260"></canvas>
            <div class="muted">显示各训练类型的训练项数与正确率</div>
        </div>
        
        <div class="panel" style="margin-top: 16px;">
            <h3>逐项统计（每个拼音）</h3>
            <div class="table-controls">
                <input type="text" id="elemSearch" placeholder="搜索拼音..." oninput="renderElementTable()">
                <select id="elemTypeFilter" onchange="renderElementTable()">
                    <option value="">全部类型</option>
                    <option value="声母">声母</option>
                    <option value="单韵母">单韵母</option>
                    <option value="复韵母">复韵母</option>
                    <option value="鼻韵母">鼻韵母</option>
                    <option value="整体认读">整体认读</option>
                </select>
                <select id="elemSort" onchange="renderElementTable()">
                    <option value="tries_desc">按尝试数(多→少)</option>
                    <option value="acc_desc">按正确率(高→低)</option>
                    <option value="wrong_desc">按错误数(多→少)</option>
                    <option value="latest_desc">按最近训练(新→旧)</option>
                    <option value="pinyin_asc">按拼音(A→Z)</option>
                </select>
                <button class="action-btn" onclick="exportElementCsv()">📤 导出CSV</button>
            </div>
            <div class="table-wrap">
                <table class="elem-table">
                    <thead>
                        <tr>
                            <th>拼音</th>
                            <th>类型</th>
                            <th>尝试</th>
                            <th>正确</th>
                            <th>错误</th>
                            <th>正确率</th>
                            <th>最近训练</th>
                        </tr>
                    </thead>
                    <tbody id="elemTableBody"></tbody>
                </table>
            </div>
            <div class="muted" id="elemSummary" style="margin-top:6px;"></div>
        </div>
        
        <div class="action-buttons" style="margin-top: 16px;">
            <button class="action-btn" onclick="refreshDashboard()">🔄 刷新驾驶舱</button>
            <button class="action-btn" onclick="syncFromGitHubAndRefresh()">☁️ 从GitHub同步并刷新</button>
        </div>
    </div>

    <script>
        // 完整拼音库
        const pinyinDatabase = {
            shengmu: ['b', 'p', 'm', 'f', 'd', 't', 'n', 'l', 'g', 'k', 'h', 'j', 'q', 'x', 'zh', 'ch', 'sh', 'r', 'z', 'c', 's', 'y', 'w'],
            
            // 单韵母（6个 × 4声调 = 24个）
            danyunmu: [
                'ā', 'á', 'ǎ', 'à',
                'ō', 'ó', 'ǒ', 'ò',
                'ē', 'é', 'ě', 'è',
                'ī', 'í', 'ǐ', 'ì',
                'ū', 'ú', 'ǔ', 'ù',
                'ǖ', 'ǘ', 'ǚ', 'ǜ'
            ],
            
            // 复韵母（9个 × 4声调 = 36个）
            shuangyunmu: [
                'āi', 'ái', 'ǎi', 'ài',
                'ēi', 'éi', 'ěi', 'èi',
                'uī', 'uí', 'uǐ', 'uì',
                'āo', 'áo', 'ǎo', 'ào',
                'ōu', 'óu', 'ǒu', 'òu',
                'iū', 'iú', 'iǔ', 'iù',
                'iē', 'ié', 'iě', 'iè',
                'üē', 'üé', 'üě', 'üè',
                'ēr', 'ér', 'ěr', 'èr'
            ],
            
            // 鼻韵母（9个 × 4声调 = 36个）
            biyunmu: [
                'ān', 'án', 'ǎn', 'àn',
                'ēn', 'én', 'ěn', 'èn',
                'īn', 'ín', 'ǐn', 'ìn',
                'ūn', 'ún', 'ǔn', 'ùn',
                'ǖn', 'ǘn', 'ǚn', 'ǜn',
                'āng', 'áng', 'ǎng', 'àng',
                'ēng', 'éng', 'ěng', 'èng',
                'īng', 'íng', 'ǐng', 'ìng',
                'ōng', 'óng', 'ǒng', 'òng'
            ],
            
            // 所有韵母（向后兼容）
            yunmuWithTones: [],
            
            zhengtiWithTones: [
                'zhī', 'zhí', 'zhǐ', 'zhì', 'chī', 'chí', 'chǐ', 'chì', 'shī', 'shí', 'shǐ', 'shì', 'rī', 'rí', 'rǐ', 'rì',
                'zī', 'zí', 'zǐ', 'zì', 'cī', 'cí', 'cǐ', 'cì', 'sī', 'sí', 'sǐ', 'sì', 'yī', 'yí', 'yǐ', 'yì',
                'wū', 'wú', 'wǔ', 'wù', 'yū', 'yú', 'yǔ', 'yù', 'yē', 'yé', 'yě', 'yè', 'yuē', 'yué', 'yuě', 'yuè',
                'yuān', 'yuán', 'yuǎn', 'yuàn', 'yīn', 'yín', 'yǐn', 'yìn', 'yūn', 'yún', 'yǔn', 'yùn', 'yīng', 'yíng', 'yǐng', 'yìng'
            ]
        };
        
        // 合并所有韵母（向后兼容）
        pinyinDatabase.yunmuWithTones = [
            ...pinyinDatabase.danyunmu,
            ...pinyinDatabase.shuangyunmu,
            ...pinyinDatabase.biyunmu
        ];
        
        let currentTraining = null;
        let inputResults = {};
        const itemsPerPage = 32; // 8行×4列
        
        // 切换屏幕
        function switchScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            const screenMap = {
                'training': 'trainingScreen',
                'input': 'inputScreen',
                'ocr': 'ocrScreen',
                'history': 'historyScreen',
                'library': 'libraryScreen',
                'dashboard': 'dashboardScreen',
                'settings': 'settingsScreen'
            };
            
            document.getElementById(screenMap[screen]).classList.add('active');
            event.target.classList.add('active');
            
            if (screen === 'history') {
                loadHistory();
            } else if (screen === 'library') {
                loadLibrary();
            } else if (screen === 'settings') {
                loadGitHubConfig();
            } else if (screen === 'dashboard') {
                refreshDashboard();
                startDashboardAutoRefresh();
            } else {
                stopDashboardAutoRefresh();
            }
        }
        
        // 加载拼音库
        function loadLibrary() {
            // 显示声母
            const shengmuContainer = document.getElementById('shengmuShowcase');
            shengmuContainer.innerHTML = '';
            pinyinDatabase.shengmu.forEach(item => {
                const div = document.createElement('div');
                div.className = 'showcase-item shengmu';
                div.textContent = item;
                shengmuContainer.appendChild(div);
            });
            
            // 显示复韵母
            const shuangyunmuContainer = document.getElementById('shuangyunmuShowcase');
            shuangyunmuContainer.innerHTML = '';
            pinyinDatabase.shuangyunmu.forEach(item => {
                const div = document.createElement('div');
                div.className = 'showcase-item shuangyunmu';
                div.textContent = item;
                shuangyunmuContainer.appendChild(div);
            });
            
            // 显示前鼻韵母
            const qianbiContainer = document.getElementById('qianbiyunmuShowcase');
            qianbiContainer.innerHTML = '';
            const qianbiYunmu = [
                'ān', 'án', 'ǎn', 'àn',
                'ēn', 'én', 'ěn', 'èn',
                'īn', 'ín', 'ǐn', 'ìn',
                'ūn', 'ún', 'ǔn', 'ùn',
                'ǖn', 'ǘn', 'ǚn', 'ǜn'
            ];
            qianbiYunmu.forEach(item => {
                const div = document.createElement('div');
                div.className = 'showcase-item biyunmu';
                div.textContent = item;
                qianbiContainer.appendChild(div);
            });
            
            // 显示后鼻韵母
            const houbiContainer = document.getElementById('houbiyunmuShowcase');
            houbiContainer.innerHTML = '';
            const houbiYunmu = [
                'āng', 'áng', 'ǎng', 'àng',
                'ēng', 'éng', 'ěng', 'èng',
                'īng', 'íng', 'ǐng', 'ìng',
                'ōng', 'óng', 'ǒng', 'òng'
            ];
            houbiYunmu.forEach(item => {
                const div = document.createElement('div');
                div.className = 'showcase-item biyunmu';
                div.textContent = item;
                houbiContainer.appendChild(div);
            });
            
            // 显示整体认读音节
            const zhengtiContainer = document.getElementById('zhengtiShowcase');
            zhengtiContainer.innerHTML = '';
            pinyinDatabase.zhengtiWithTones.forEach(item => {
                const div = document.createElement('div');
                div.className = 'showcase-item zhengti';
                div.textContent = item;
                zhengtiContainer.appendChild(div);
            });
        }
        
        // 开始训练
        function startTraining(mode) {
            let items = [];
            let typeName = '';
            
            switch(mode) {
                case 'shengmu':
                    items = [...pinyinDatabase.shengmu];
                    typeName = '声母训练';
                    break;
                case 'danyunmu':
                    items = [...pinyinDatabase.danyunmu];
                    typeName = '单韵母训练（带声调）';
                    break;
                case 'shuangyunmu':
                    items = [...pinyinDatabase.shuangyunmu];
                    typeName = '复韵母训练（带声调）';
                    break;
                case 'biyunmu':
                    items = [...pinyinDatabase.biyunmu];
                    typeName = '鼻韵母训练（带声调）';
                    break;
                case 'yunmu':
                    items = [...pinyinDatabase.yunmuWithTones];
                    typeName = '韵母训练（带声调）';
                    break;
                case 'zhengti':
                    items = [...pinyinDatabase.zhengtiWithTones];
                    typeName = '整体认读音节训练';
                    break;
                case 'random':
                    items = [...pinyinDatabase.shengmu, ...pinyinDatabase.yunmuWithTones, ...pinyinDatabase.zhengtiWithTones];
                    typeName = '随机混合训练';
                    break;
            }
            
            items = shuffleArray(items).slice(0, itemsPerPage);
            
            currentTraining = {
                id: 'T' + Date.now(),
                mode: mode,
                typeName: typeName,
                items: items,
                date: new Date().toISOString()
            };
            
            generateTrainingSheet();
            document.getElementById('selectionView').style.display = 'none';
            document.getElementById('trainingView').style.display = 'block';
        }
        
        // 生成训练表单
        function generateTrainingSheet() {
            document.getElementById('trainingId').textContent = '训练编号：' + currentTraining.id;
            document.getElementById('trainingType').textContent = currentTraining.typeName;
            const grid = document.getElementById('trainingGrid');
            grid.innerHTML = '';
            
            currentTraining.items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'training-item';
                div.innerHTML = `
                    <div class="pinyin">${item}</div>
                    <div class="checkboxes">
                        <label class="checkbox-item correct">
                            <input type="checkbox"> ✓
                        </label>
                        <label class="checkbox-item wrong">
                            <input type="checkbox"> ✗
                        </label>
                    </div>
                `;
                grid.appendChild(div);
            });
        }
        
        // 前往录入界面
        function goToInput() {
            if (!currentTraining) {
                alert('请先生成训练表单');
                return;
            }
            
            inputResults = {};
            const content = document.getElementById('inputContent');
            content.innerHTML = '';
            
            const header = document.createElement('div');
            header.style.cssText = 'text-align: center; margin-bottom: 20px;';
            header.innerHTML = `
                <div style="color: #3498db; font-weight: bold; font-size: 14px;">${currentTraining.id}</div>
                <div style="color: #2c3e50; font-size: 18px; margin-top: 5px;">${currentTraining.typeName}</div>
            `;
            content.appendChild(header);
            
            const grid = document.createElement('div');
            grid.className = 'input-grid';
            
            currentTraining.items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'input-item';
                div.dataset.index = index;
                div.innerHTML = `
                    <div class="pinyin">${item}</div>
                    <div class="input-status">未选择</div>
                    <div class="mark-buttons">
                        <button type="button" class="mark-btn correct" onclick="markResult(${index}, true)">✓ 正确</button>
                        <button type="button" class="mark-btn wrong" onclick="markResult(${index}, false)">✗ 错误</button>
                    </div>
                `;
                grid.appendChild(div);
            });
            
            content.appendChild(grid);
            document.getElementById('inputActions').style.display = 'flex';
            switchScreen('input');
        }
        
        // 设置某项为正确/错误（显式选择）
        function markResult(index, isCorrect) {
            const item = document.querySelector(`.input-item[data-index="${index}"]`);
            if (!item) return;
            item.classList.remove('correct', 'wrong');
            item.classList.add(isCorrect ? 'correct' : 'wrong');
            item.querySelector('.input-status').textContent = isCorrect ? '✓ 正确' : '✗ 错误';
            inputResults[index] = !!isCorrect;
        }
        
        // 清除录入
        function clearInput() {
            inputResults = {};
            document.querySelectorAll('.input-item').forEach(item => {
                item.classList.remove('correct', 'wrong');
                const st = item.querySelector('.input-status');
                if (st) st.textContent = '未选择';
            });
        }
        
        // 保存结果
        function saveResults() {
            if (Object.keys(inputResults).length !== currentTraining.items.length) {
                if (!confirm('还有未录入的项目，确定要保存吗？')) {
                    return;
                }
            }
            
            const results = currentTraining.items.map((item, index) => ({
                pinyin: item,
                result: inputResults[index] === undefined ? null : inputResults[index]
            }));
            
            const record = {
                ...currentTraining,
                results: results,
                completedDate: new Date().toISOString()
            };
            
            saveToDatabase(record);
            if (isDashboardActive()) refreshDashboard();
            alert('✅ 保存成功！');
            
            if (githubConfig.token) {
                if (confirm('是否立即同步到GitHub？')) {
                    syncToGitHub().then(()=>{ if (isDashboardActive()) refreshDashboard(); });
                }
            }
            
            clearInput();
            switchScreen('history');
        }
        
        // 保存到数据库
        function saveToDatabase(record) {
            let database = JSON.parse(localStorage.getItem('pinyinTrainingDB') || '[]');
            database.push(record);
            localStorage.setItem('pinyinTrainingDB', JSON.stringify(database));
        }
        
        // 加载历史记录
        function loadHistory() {
            const database = JSON.parse(localStorage.getItem('pinyinTrainingDB') || '[]');
            
            // 统计数据
            let totalTrainings = database.length;
            let totalItems = 0;
            let totalCorrect = 0;
            
            database.forEach(record => {
                if (record.results) {
                    record.results.forEach(r => {
                        if (r.result !== null) {
                            totalItems++;
                            if (r.result) totalCorrect++;
                        }
                    });
                }
            });
            
            document.getElementById('totalTrainings').textContent = totalTrainings;
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('avgAccuracy').textContent = totalItems > 0 ? Math.round(totalCorrect / totalItems * 100) + '%' : '0%';
            
            // 历史列表
            const list = document.getElementById('historyList');
            if (database.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 40px;">暂无训练记录</p>';
                return;
            }
            
            list.innerHTML = '';
            database.reverse().forEach((record, index) => {
                const correctCount = record.results ? record.results.filter(r => r.result === true).length : 0;
                const wrongCount = record.results ? record.results.filter(r => r.result === false).length : 0;
                const total = correctCount + wrongCount;
                const rate = total > 0 ? Math.round(correctCount / total * 100) : 0;
                
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <h3>
                        <span>${record.typeName}</span>
                        <button class="action-btn" style="padding: 5px 15px; font-size: 14px;" onclick="toggleDetails(${database.length - 1 - index})">查看详情</button>
                    </h3>
                    <div class="history-meta">
                        训练编号：${record.id} | 日期：${new Date(record.completedDate || record.date).toLocaleString('zh-CN')}
                    </div>
                    <div class="history-stats">
                        <div class="stat-box correct">✓ 正确：${correctCount}</div>
                        <div class="stat-box wrong">✗ 错误：${wrongCount}</div>
                        <div class="stat-box rate">正确率：${rate}%</div>
                    </div>
                    <div class="history-details" id="details-${database.length - 1 - index}">
                        <div class="detail-grid">
                            ${record.results ? record.results.map(r => `
                                <div class="detail-item ${r.result === true ? 'correct' : (r.result === false ? 'wrong' : '')}">${r.pinyin}</div>
                            `).join('') : ''}
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        // 切换详情显示
        function toggleDetails(index) {
            const details = document.getElementById(`details-${index}`);
            details.classList.toggle('show');
        }
        
        // 文件上传处理
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) processImage(file);
        });
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) processImage(file);
        }
        
        // 处理图像
        function processImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById('previewImage');
                img.src = e.target.result;
                img.style.display = 'block';
                
                document.getElementById('uploadArea').style.display = 'none';
                performOCR(e.target.result);
            };
            reader.readAsDataURL(file);
        }
        
        // 执行OCR识别
        async function performOCR(imageData) {
            const progress = document.getElementById('ocrProgress');
            progress.classList.add('show');
            
            try {
                const worker = await Tesseract.createWorker({
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const percent = Math.round(m.progress * 100);
                            document.getElementById('progressFill').style.width = percent + '%';
                            document.getElementById('progressFill').textContent = percent + '%';
                            document.getElementById('ocrStatus').textContent = '正在识别文字...';
                        }
                    }
                });
                
                await worker.loadLanguage('chi_sim');
                await worker.initialize('chi_sim');
                const { data: { text } } = await worker.recognize(imageData);
                await worker.terminate();
                
                // 模拟结果（实际需要更复杂的解析逻辑）
                setTimeout(() => {
                    showOCRResults(text);
                }, 500);
                
            } catch (error) {
                alert('OCR识别失败：' + error.message + '\n\n建议：\n1. 确保照片清晰\n2. 尝试重新拍照\n3. 或使用手动录入功能');
                resetOCR();
            }
        }
        
        // 显示OCR结果
        function showOCRResults(text) {
            document.getElementById('ocrProgress').classList.remove('show');
            document.getElementById('ocrResults').style.display = 'block';
            
            // 这里需要实现复杂的解析逻辑
            // 暂时提示用户使用手动录入
            document.getElementById('ocrResultGrid').innerHTML = `
                <div style="padding: 40px; text-align: center; color: #7f8c8d;">
                    <h3 style="color: #e67e22; margin-bottom: 20px;">⚠️ OCR功能正在完善中</h3>
                    <p>由于训练表单格式的复杂性，OCR识别准确率可能不高。</p>
                    <p style="margin-top: 15px; color: #2c3e50; font-weight: bold;">建议使用"📝 录入结果"功能进行手动录入，准确率更高！</p>
                    <p style="margin-top: 20px; font-size: 14px;">识别到的文本（供参考）：</p>
                    <pre style="background: #ecf0f1; padding: 15px; border-radius: 5px; margin-top: 10px; text-align: left; max-height: 200px; overflow-y: auto;">${text}</pre>
                </div>
            `;
        }
        
        // 保存OCR结果
        function saveOCRResults() {
            alert('OCR功能正在完善中，请使用手动录入功能');
        }
        
        // 重置OCR
        function resetOCR() {
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('previewImage').style.display = 'none';
            document.getElementById('ocrProgress').classList.remove('show');
            document.getElementById('ocrResults').style.display = 'none';
            document.getElementById('fileInput').value = '';
        }
        
        // 工具函数
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        
        function regenerate() {
            startTraining(currentTraining.mode);
        }
        
        function backToSelection() {
            document.getElementById('trainingView').style.display = 'none';
            document.getElementById('selectionView').style.display = 'block';
        }

        // GitHub配置
        let githubConfig = {
            token: localStorage.getItem('github_token') || '',
            username: localStorage.getItem('github_username') || 'Jiaming-Yi',
            repo: localStorage.getItem('github_repo') || 'pingyinxulian'
        };

        // 统一构建GitHub Headers，清洗Token避免非ASCII字符
        function getSanitizedToken() {
            return (githubConfig.token || '').trim().replace(/[^\x00-\x7F]/g, '');
        }
        function getGitHubHeaders(includeJson = false) {
            const token = getSanitizedToken();
            const headers = {
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/vnd.github+json',
                'X-GitHub-Api-Version': '2022-11-28'
            };
            if (includeJson) headers['Content-Type'] = 'application/json';
            return headers;
        }

        // 加载配置
        function loadGitHubConfig() {
            document.getElementById('githubToken').value = githubConfig.token;
            document.getElementById('githubUsername').value = githubConfig.username;
            document.getElementById('githubRepo').value = githubConfig.repo;
            updateLocalDataInfo();
        }

        // 保存GitHub配置
        function saveGitHubConfig() {
            githubConfig.token = document.getElementById('githubToken').value.trim();
            githubConfig.username = document.getElementById('githubUsername').value.trim();
            githubConfig.repo = document.getElementById('githubRepo').value.trim();
            
            if (!githubConfig.token || !githubConfig.username || !githubConfig.repo) {
                showSyncStatus('error', '❌ 请填写完整的GitHub配置信息');
                return;
            }
            
            localStorage.setItem('github_token', githubConfig.token);
            localStorage.setItem('github_username', githubConfig.username);
            localStorage.setItem('github_repo', githubConfig.repo);
            
            showSyncStatus('success', '✅ GitHub配置已保存');
        }

        // 上传数据到GitHub
        async function syncToGitHub() {
            if (!githubConfig.token) {
                showSyncStatus('error', '❌ 请先配置GitHub Token');
                return;
            }
            
            showSyncStatus('info', '⏳ 正在上传数据到GitHub...');
            
            try {
                const database = JSON.parse(localStorage.getItem('pinyinTrainingDB') || '[]');
                const content = JSON.stringify(database, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(content)));
                
                let sha = null;
                try {
                    const getResponse = await fetch(
                        `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/data/training_records.json`,
                        {
                            headers: getGitHubHeaders(false)
                        }
                    );
                    if (getResponse.ok) {
                        const fileData = await getResponse.json();
                        sha = fileData.sha;
                    }
                } catch (e) {}
                
                const uploadData = {
                    message: `更新训练记录 - ${new Date().toLocaleString('zh-CN')}`,
                    content: encodedContent,
                    branch: 'main'
                };
                if (sha) uploadData.sha = sha;
                
                const response = await fetch(
                    `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/data/training_records.json`,
                    {
                        method: 'PUT',
                        headers: getGitHubHeaders(true),
                        body: JSON.stringify(uploadData)
                    }
                );
                
                if (response.ok) {
                    showSyncStatus('success', `✅ 数据已成功上传到GitHub（${database.length}条记录）`);
                    localStorage.setItem('last_sync_time', new Date().toISOString());
                    if (isDashboardActive()) refreshDashboard();
                } else {
                    const error = await response.json().catch(()=>({ message: response.statusText }));
                    showSyncStatus('error', `❌ 上传失败: ${error.message}`);
                }
            } catch (error) {
                const msg = (error && error.message) ? error.message : String(error);
                if (/non ISO-8859-1|ISO-8859-1|headers/i.test(msg)) {
                    showSyncStatus('error', '❌ 上传出错：Token或请求头包含非ASCII字符。请在设置中重新粘贴纯英文的Token，并去除空格或全角字符。');
                } else {
                    showSyncStatus('error', `❌ 上传出错: ${msg}`);
                }
            }
        }

        // 从GitHub下载数据
        async function syncFromGitHub() {
            if (!githubConfig.token) {
                showSyncStatus('error', '❌ 请先配置GitHub Token');
                return;
            }
            
            showSyncStatus('info', '⏳ 正在从GitHub下载数据...');
            
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/data/training_records.json`,
                    {
                        headers: getGitHubHeaders(false)
                    }
                );
                
                if (response.ok) {
                    const fileData = await response.json();
                    const content = decodeURIComponent(escape(atob(fileData.content)));
                    const database = JSON.parse(content);
                    
                    // 合并本地和云端数据（去重）
                    const localDB = JSON.parse(localStorage.getItem('pinyinTrainingDB') || '[]');
                    const mergedDB = mergeTrainingData(localDB, database);
                    
                    localStorage.setItem('pinyinTrainingDB', JSON.stringify(mergedDB));
                    localStorage.setItem('last_sync_time', new Date().toISOString());
                    
                    showSyncStatus('success', `✅ 数据已成功从GitHub下载（${database.length}条记录，合并后${mergedDB.length}条）`);
                    updateLocalDataInfo();
                    
                    if (document.getElementById('historyScreen').classList.contains('active')) {
                        loadHistory();
                    }
                } else if (response.status === 404) {
                    showSyncStatus('info', '⚠️ GitHub上还没有数据文件，请先上传数据');
                } else {
                    const error = await response.json().catch(()=>({ message: response.statusText }));
                    showSyncStatus('error', `❌ 下载失败: ${error.message}`);
                }
            } catch (error) {
                const msg = (error && error.message) ? error.message : String(error);
                if (/non ISO-8859-1|ISO-8859-1|headers/i.test(msg)) {
                    showSyncStatus('error', '❌ 下载出错：Token或请求头包含非ASCII字符。请在设置中重新粘贴纯英文的Token，并去除空格或全角字符。');
                } else {
                    showSyncStatus('error', `❌ 下载出错: ${msg}`);
                }
            }
        }

        // 合并训练数据（去重）
        function mergeTrainingData(local, remote) {
            const merged = [...local];
            const existingIds = new Set(local.map(r => r.id));
            
            remote.forEach(record => {
                if (!existingIds.has(record.id)) {
                    merged.push(record);
                    existingIds.add(record.id);
                }
            });
            
            // 按日期排序
            merged.sort((a, b) => new Date(a.date) - new Date(b.date));
            return merged;
        }

        // 显示同步状态
        function showSyncStatus(type, message) {
            const statusDiv = document.getElementById('syncStatus');
            statusDiv.className = `sync-status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'flex';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // 更新本地数据信息
        function updateLocalDataInfo() {
            const database = JSON.parse(localStorage.getItem('pinyinTrainingDB') || '[]');
            const lastSync = localStorage.getItem('last_sync_time');
            
            let info = `本地共有 ${database.length} 条训练记录`;
            if (lastSync) {
                info += `<br>上次同步: ${new Date(lastSync).toLocaleString('zh-CN')}`;
            }
            
            document.getElementById('localDataInfo').innerHTML = info;
        }

        // 导出本地数据
        function exportLocalData() {
            const database = JSON.parse(localStorage.getItem('pinyinTrainingDB') || '[]');
            const dataStr = JSON.stringify(database, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pinyin_training_data_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showSyncStatus('success', '✅ 数据已导出');
        }

        // 清除本地数据
        function clearLocalData() {
            if (confirm('确定要清除所有本地训练数据吗？\n\n建议先上传到GitHub或导出备份！')) {
                localStorage.removeItem('pinyinTrainingDB');
                updateLocalDataInfo();
                showSyncStatus('success', '✅ 本地数据已清除');
            }
        }

        function refreshDashboard() {
            const db = JSON.parse(localStorage.getItem('pinyinTrainingDB') || '[]');
            // KPI统计
            let totalTrainings = db.length;
            let totalItems = 0;
            let totalCorrect = 0;
            db.forEach(r => {
                if (r.results && Array.isArray(r.results)) {
                    r.results.forEach(x => {
                        if (x.result !== null) {
                            totalItems++;
                            if (x.result) totalCorrect++;
                        }
                    });
                }
            });
            document.getElementById('kpiTotalTimes').textContent = totalTrainings;
            document.getElementById('kpiTotalItems').textContent = totalItems;
            document.getElementById('kpiAvgRate').textContent = totalItems ? Math.round(totalCorrect * 100 / totalItems) + '%' : '0%';
            
            // 近7天趋势（按日期）
            const last7 = Array.from({length: 7}).map((_,i)=>{
                const d = new Date();
                d.setDate(d.getDate() - (6 - i));
                const key = d.toISOString().slice(0,10);
                return { key, items:0, correct:0 };
            });
            const map = new Map(last7.map(x=>[x.key,x]));
            db.forEach(r => {
                const key = (r.completedDate || r.date || '').slice(0,10);
                const bucket = map.get(key);
                if (!bucket) return;
                if (r.results) {
                    r.results.forEach(x=>{
                        if (x.result !== null) {
                            bucket.items++;
                            if (x.result) bucket.correct++;
                        }
                    });
                }
            });
            drawTrendChart(last7);
            
            // 易错Top10
            const mistakeMap = new Map(); // pinyin -> {wrong,total}
            db.forEach(r=>{
                if (!r.results) return;
                r.results.forEach(x=>{
                    if (x.result === null) return;
                    const rec = mistakeMap.get(x.pinyin) || {wrong:0,total:0};
                    rec.total++;
                    if (!x.result) rec.wrong++;
                    mistakeMap.set(x.pinyin, rec);
                });
            });
            const sorted = Array.from(mistakeMap.entries())
                .filter(([p,{total}])=>total>=2)
                .sort((a,b)=> b[1].wrong - a[1].wrong)
                .slice(0,10);
            const list = document.getElementById('topMistakes');
            list.innerHTML = '';
            sorted.forEach(([p,rec])=>{
                const rate = rec.total ? Math.round((rec.total - rec.wrong)*100/rec.total) : 0;
                const rowP = document.createElement('div'); rowP.className='item'; rowP.textContent = p; list.appendChild(rowP);
                const rowW = document.createElement('div'); rowW.className='item'; rowW.textContent = `错${rec.wrong}`; list.appendChild(rowW);
                const rowR = document.createElement('div'); rowR.className='item'; rowR.textContent = `${rate}%`; list.appendChild(rowR);
            });
            
            // 按类型统计
            const typeKeys = [
                { key:'shengmu', label:'声母' },
                { key:'danyunmu', label:'单韵母' },
                { key:'shuangyunmu', label:'复韵母' },
                { key:'biyunmu', label:'鼻韵母' },
                { key:'zhengti', label:'整体认读' },
                { key:'random', label:'随机' }
            ];
            const typeAgg = new Map(typeKeys.map(t=>[t.key,{ label:t.label, items:0, correct:0 }]));
            db.forEach(r=>{
                const k = r.mode || 'random';
                const bucket = typeAgg.get(k) || typeAgg.get('random');
                if (!bucket) return;
                if (Array.isArray(r.results)) {
                    r.results.forEach(x=>{
                        if (x.result !== null) {
                            bucket.items++;
                            if (x.result) bucket.correct++;
                        }
                    });
                }
            });
            const typePoints = typeKeys.map(t=>{
                const b = typeAgg.get(t.key) || { items:0, correct:0, label:t.label };
                return { label:t.label, items:b.items, rate: b.items? Math.round(b.correct*100/b.items):0 };
            });
            drawTypeChart(typePoints);
            
            // 逐项统计更新
            buildElementStatsCache(db);
            renderElementTable();
        }
        
        function drawTrendChart(points){
            const canvas = document.getElementById('trendChart');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0,0,canvas.width,canvas.height);
            const W=canvas.width,H=canvas.height, P=40;
            ctx.strokeStyle='#ccc'; ctx.lineWidth=1;
            ctx.beginPath(); ctx.moveTo(P,P); ctx.lineTo(P,H-P); ctx.lineTo(W-P,H-P); ctx.stroke();
            const labels = points.map(p=>p.key.slice(5));
            const maxItems = Math.max(1, ...points.map(p=>p.items));
            const itemsY = v => H-P - (v/maxItems)*(H-2*P);
            const xStep = (W-2*P)/(points.length-1 || 1);
            ctx.fillStyle='rgba(52,152,219,0.25)';
            points.forEach((p,i)=>{
                const x = P + i*xStep - 10;
                const y = itemsY(p.items);
                ctx.fillRect(x, y, 20, (H-P)-y);
            });
            ctx.strokeStyle='#e67e22'; ctx.lineWidth=2; ctx.beginPath();
            points.forEach((p,i)=>{
                const rate = p.items ? p.correct*100/p.items : 0;
                const y = H-P - (rate/100)*(H-2*P);
                const x = P + i*xStep;
                if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            });
            ctx.stroke();
            ctx.fillStyle='#7f8c8d'; ctx.font='12px Arial'; ctx.textAlign='center';
            labels.forEach((lb,i)=>{ const x=P+i*xStep; ctx.fillText(lb,x,H-P+14); });
        }
        
        function drawTypeChart(points){
            const canvas = document.getElementById('typeChart');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0,0,canvas.width,canvas.height);
            const W=canvas.width,H=canvas.height,P=40;
            ctx.strokeStyle='#ccc'; ctx.lineWidth=1;
            ctx.beginPath(); ctx.moveTo(P,P); ctx.lineTo(P,H-P); ctx.lineTo(W-P,H-P); ctx.stroke();
            const maxItems = Math.max(1, ...points.map(p=>p.items));
            const barW = 28;
            const xStep = (W-2*P)/points.length;
            points.forEach((p,i)=>{
                const x = P + i*xStep + (xStep-barW)/2;
                const y = H-P - (p.items/maxItems)*(H-2*P);
                ctx.fillStyle='rgba(46,204,113,0.35)';
                ctx.fillRect(x, y, barW, (H-P)-y);
                ctx.fillStyle='#e67e22'; ctx.font='12px Arial'; ctx.textAlign='center';
                ctx.fillText(p.rate + '%', x+barW/2, y-6);
                ctx.fillStyle='#7f8c8d';
                ctx.fillText(p.label, x+barW/2, H-P+14);
            });
        }
        
        let dashboardTimer = null;
        function startDashboardAutoRefresh(){
            stopDashboardAutoRefresh();
            dashboardTimer = setInterval(()=>{
                if (isDashboardActive()) refreshDashboard();
            }, 60000);
        }
        function stopDashboardAutoRefresh(){
            if (dashboardTimer) { clearInterval(dashboardTimer); dashboardTimer = null; }
        }
        function isDashboardActive(){
            const el = document.getElementById('dashboardScreen');
            return el && el.classList.contains('active');
        }
        
        async function syncFromGitHubAndRefresh(){
            if (typeof syncFromGitHub === 'function') {
                await syncFromGitHub();
                if (isDashboardActive()) refreshDashboard();
            } else {
                alert('当前版本不支持GitHub同步。');
            }
        }
        
        // —— 逐项统计逻辑 ——
        let elemStats = [];
        function detectPinyinType(p){
            if (pinyinDatabase && Array.isArray(pinyinDatabase.shengmu) && pinyinDatabase.shengmu.includes(p)) return '声母';
            if (pinyinDatabase && Array.isArray(pinyinDatabase.danyunmu) && pinyinDatabase.danyunmu.includes(p)) return '单韵母';
            if (pinyinDatabase && Array.isArray(pinyinDatabase.shuangyunmu) && pinyinDatabase.shuangyunmu.includes(p)) return '复韵母';
            if (pinyinDatabase && Array.isArray(pinyinDatabase.biyunmu) && pinyinDatabase.biyunmu.includes(p)) return '鼻韵母';
            if (pinyinDatabase && Array.isArray(pinyinDatabase.zhengtiWithTones) && pinyinDatabase.zhengtiWithTones.includes(p)) return '整体认读';
            return '';
        }
        function buildElementStatsCache(db){
            const map = new Map();
            db.forEach(r=>{
                const dt = new Date(r.completedDate || r.date || '').toISOString();
                (r.results||[]).forEach(x=>{
                    if (x.result === null) return;
                    const key = x.pinyin;
                    const rec = map.get(key) || { pinyin:key, type: detectPinyinType(key), tries:0, correct:0, wrong:0, latest:'' };
                    rec.tries++;
                    if (x.result) rec.correct++; else rec.wrong++;
                    if (!rec.latest || dt > rec.latest) rec.latest = dt;
                    map.set(key, rec);
                });
            });
            elemStats = Array.from(map.values()).map(r=>({
                ...r,
                acc: r.tries ? Math.round(r.correct*100/r.tries) : 0
            }));
        }
        function renderElementTable(){
            const body = document.getElementById('elemTableBody');
            const q = (document.getElementById('elemSearch')?.value || '').trim().toLowerCase();
            const t = document.getElementById('elemTypeFilter')?.value || '';
            const sort = document.getElementById('elemSort')?.value || 'tries_desc';
            let rows = elemStats.slice();
            if (q) rows = rows.filter(r=> r.pinyin.toLowerCase().includes(q));
            if (t) rows = rows.filter(r=> r.type === t);
            switch(sort){
                case 'tries_desc': rows.sort((a,b)=> b.tries-a.tries || a.pinyin.localeCompare(b.pinyin)); break;
                case 'acc_desc': rows.sort((a,b)=> b.acc-a.acc || b.tries-a.tries); break;
                case 'wrong_desc': rows.sort((a,b)=> b.wrong-a.wrong || b.tries-a.tries); break;
                case 'latest_desc': rows.sort((a,b)=> (b.latest||'').localeCompare(a.latest||'') || b.tries-a.tries); break;
                case 'pinyin_asc': rows.sort((a,b)=> a.pinyin.localeCompare(b.pinyin)); break;
            }
            body.innerHTML = rows.map(r=>
                `<tr>
                    <td>${r.pinyin}</td>
                    <td>${r.type||''}</td>
                    <td>${r.tries}</td>
                    <td>${r.correct}</td>
                    <td>${r.wrong}</td>
                    <td>${r.acc}%</td>
                    <td>${r.latest? new Date(r.latest).toLocaleString('zh-CN'):''}</td>
                </tr>`
            ).join('');
            document.getElementById('elemSummary').textContent = `共 ${rows.length} 个拼音条目`;
        }
        function exportElementCsv(){
            // 基于当前筛选渲染数据导出
            const q = (document.getElementById('elemSearch')?.value || '').trim().toLowerCase();
            const t = document.getElementById('elemTypeFilter')?.value || '';
            const sort = document.getElementById('elemSort')?.value || 'tries_desc';
            let rows = elemStats.slice();
            if (q) rows = rows.filter(r=> r.pinyin.toLowerCase().includes(q));
            if (t) rows = rows.filter(r=> r.type === t);
            switch(sort){
                case 'tries_desc': rows.sort((a,b)=> b.tries-a.tries || a.pinyin.localeCompare(b.pinyin)); break;
                case 'acc_desc': rows.sort((a,b)=> b.acc-a.acc || b.tries-a.tries); break;
                case 'wrong_desc': rows.sort((a,b)=> b.wrong-a.wrong || b.tries-a.tries); break;
                case 'latest_desc': rows.sort((a,b)=> (b.latest||'').localeCompare(a.latest||'') || b.tries-a.tries); break;
                case 'pinyin_asc': rows.sort((a,b)=> a.pinyin.localeCompare(b.pinyin)); break;
            }
            const header = ['拼音','类型','尝试','正确','错误','正确率','最近训练'];
            const lines = [header.join(',')].concat(rows.map(r=>[
                r.pinyin,
                r.type||'',
                r.tries,
                r.correct,
                r.wrong,
                r.acc+'%',
                r.latest? new Date(r.latest).toLocaleString('zh-CN'):''
            ].map(v=> `"${String(v).replace(/"/g,'""')}"`).join(',')));
            const blob = new Blob(["\uFEFF"+lines.join('\n')], {type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `pinyin_element_stats_${new Date().toISOString().slice(0,10)}.csv`;
            a.click(); URL.revokeObjectURL(url);
        }
    </script>
</body>
</html> 