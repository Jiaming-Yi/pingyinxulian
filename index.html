<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>桐桐汉语拼音智能训练系统</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft YaHei", "SimHei", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* 导航标签 */
        .nav-tabs {
            max-width: 1200px;
            margin: 0 auto 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            background: rgba(255,255,255,0.9);
            padding: 15px 30px;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .nav-tab.active {
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-tab:hover {
            background: white;
        }
        
        /* 屏幕容器 */
        .screen {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 0 20px 20px 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .screen.active {
            display: block;
        }
        
        /* 选择界面 */
        .title {
            text-align: center;
            color: #2c3e50;
            font-size: 36px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            font-size: 16px;
            margin-bottom: 30px;
        }
        
        .mode-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .mode-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 30px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .mode-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .mode-btn.random {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            grid-column: span 3;
        }
        
        .stats {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .stats h3 {
            color: #34495e;
            margin-bottom: 10px;
        }
        
        .stats ul {
            list-style: none;
            padding: 0;
        }
        
        .stats li {
            padding: 5px 0;
            color: #555;
            font-size: 14px;
        }
        
        /* 训练表单 */
        .training-container {
            max-width: 100%;
        }
        
        .training-header {
            text-align: center;
            margin-bottom: 20px;
            page-break-after: avoid;
        }
        
        .training-header h2 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .training-info {
            font-size: 14px;
            color: #666;
            margin: 10px 0;
        }
        
        .training-id {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .training-type {
            display: inline-block;
            background: #e74c3c;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .training-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .training-item {
            border: 2px solid #bdc3c7;
            padding: 10px;
            border-radius: 8px;
            background: #f8f9fa;
            min-height: 85px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .pinyin {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            color: #2c3e50;
            margin-bottom: 8px;
            font-family: "Arial", "Microsoft YaHei", sans-serif;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .checkboxes {
            display: flex;
            justify-content: center;
            gap: 12px;
            font-size: 13px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .correct {
            color: #27ae60;
            font-weight: bold;
        }
        
        .wrong {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .action-buttons {
            text-align: center;
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .action-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .action-btn.success {
            background: #27ae60;
        }
        
        .action-btn.success:hover {
            background: #229954;
        }
        
        .action-btn.warning {
            background: #e67e22;
        }
        
        .action-btn.warning:hover {
            background: #d35400;
        }
        
        .action-btn.secondary {
            background: #95a5a6;
        }
        
        .action-btn.secondary:hover {
            background: #7f8c8d;
        }
        
        /* 录入界面 */
        .input-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .input-item {
            border: 3px solid #bdc3c7;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
            cursor: default;
            transition: all 0.3s;
        }
        
        .input-item:hover {
            border-color: #3498db;
            transform: translateY(-1px);
        }
        
        .input-item.correct {
            border-color: #27ae60;
            background: #d5f4e6;
        }
        
        .input-item.wrong {
            border-color: #e74c3c;
            background: #fadbd8;
        }
        
        .input-item .pinyin {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .input-status {
            text-align: center;
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 8px;
        }
        
        .input-item.correct .input-status {
            color: #27ae60;
            font-weight: bold;
        }
        
        .input-item.wrong .input-status {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .mark-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .mark-btn {
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
        }
        .mark-btn.correct { background: #27ae60; color: #fff; }
        .mark-btn.wrong { background: #e74c3c; color: #fff; }
        
        /* 历史记录 */
        .history-list {
            margin: 20px 0;
        }
        
        .history-item {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 5px solid #3498db;
        }
        
        .history-item h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-meta {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .history-stats {
            display: flex;
            gap: 20px;
            margin: 10px 0;
        }
        
        .stat-box {
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .stat-box.correct {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .stat-box.wrong {
            background: #fadbd8;
            color: #e74c3c;
        }
        
        .stat-box.rate {
            background: #dfe6e9;
            color: #2c3e50;
        }
        
        .history-details {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        
        .history-details.show {
            display: block;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
        }
        
        .detail-item {
            padding: 5px;
            text-align: center;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .detail-item.correct {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .detail-item.wrong {
            background: #fadbd8;
            color: #e74c3c;
        }
        
        /* 拼音库 */
        .library-section {
            margin-bottom: 40px;
        }
        
        .library-section h2 {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
        }
        
        .library-section h3 {
            color: #555;
            font-size: 18px;
            margin: 20px 0 10px;
        }
        
        .pinyin-showcase {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .showcase-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .showcase-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .showcase-item.shengmu {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .showcase-item.danyunmu {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .showcase-item.shuangyunmu {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .showcase-item.biyunmu {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .showcase-item.zhengti {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        .showcase-item.qianziwen {
            background: linear-gradient(135deg, #fbc531 0%, #e55039 100%);
        }
        
        .library-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 30px;
        }
        
        .library-stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #3498db;
        }
        
        .library-stat-card h4 {
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .library-stat-card .count {
            font-size: 36px;
            font-weight: bold;
            color: #3498db;
        }
        
        /* OCR上传 */
        .upload-area {
            border: 3px dashed #bdc3c7;
            padding: 40px;
            text-align: center;
            border-radius: 10px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: #3498db;
            background: #ecf0f1;
        }
        
        .upload-area.dragover {
            border-color: #27ae60;
            background: #d5f4e6;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .preview-image {
            max-width: 100%;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .ocr-progress {
            display: none;
            margin: 20px 0;
        }
        
        .ocr-progress.show {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #ecf0f1;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        /* 统计分析 */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        
        .analytics-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }
        
        .analytics-card h3 {
            font-size: 16px;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .analytics-card .number {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        /* 驾驶舱样式 */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        
        .panel {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            padding: 16px;
        }
        
        .panel h3 {
            color: #2c3e50;
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .top-list {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 8px 12px;
            align-items: center;
        }
        
        .top-list .item {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .muted {
            color: #7f8c8d;
            font-size: 12px;
        }
        
        /* 批量打印选择器 */
        .batch-print-selector {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .batch-print-selector h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .batch-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .batch-option {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .batch-option:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .batch-option.selected {
            border-color: #27ae60;
            background: #d5f4e6;
        }
        
        .batch-option input[type="checkbox"] {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .batch-option .option-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .batch-option .option-desc {
            color: #7f8c8d;
            font-size: 13px;
        }
        
        .batch-count-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .batch-count-control label {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .batch-count-control input[type="number"] {
            width: 80px;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            text-align: center;
        }
        
        .batch-preview-area {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px dashed #ddd;
        }
        
        .batch-preview-item {
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .page-divider {
            page-break-after: always;
            margin: 0;
            padding: 0;
            height: 0;
            overflow: hidden;
        }
        
        /* 拼音库打印专用样式 */
        .library-print-mode {
            display: none;
        }
        
        /* 打印样式 */
        @media print {
            body {
                background: white !important;
                padding: 0;
                margin: 0;
            }
            
            .nav-tabs, .action-buttons, .batch-print-selector {
                display: none !important;
            }
            
            .screen {
                box-shadow: none;
                margin: 0;
                padding: 10mm;
                max-width: 100%;
                background: white !important;
            }
            
            /* 防止空白页和强制单页 */
            .training-container {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            .training-grid {
                gap: 6px;
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            .training-item {
                padding: 6px;
                min-height: 60px;
                font-size: 14px;
            }
            
            .pinyin {
                font-size: 18px;
            }
            
            .training-header h2 {
                font-size: 24px;
                margin-bottom: 8px;
            }
            
            .training-info {
                font-size: 14px;
                margin-bottom: 8px;
            }
            
            .page-divider {
                page-break-after: always;
                height: 0;
                margin: 0;
                padding: 0;
                border: none;
                overflow: hidden;
                visibility: hidden;
            }
            
            .training-header {
                page-break-after: avoid;
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            /* 确保整个训练表单不被分割 */
            #trainingView, #singleSheetContainer {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            /* 拼音库打印样式 */
            .library-section {
                page-break-inside: avoid;
                margin-bottom: 15mm;
            }
            
            .library-section h2 {
                color: #000 !important;
                border-bottom: 2px solid #000 !important;
                font-size: 18pt;
                margin-bottom: 8mm;
                padding-bottom: 3mm;
            }
            
            .library-section h3 {
                color: #333 !important;
                font-size: 14pt;
                margin: 5mm 0 3mm;
            }
            
            .pinyin-showcase {
                grid-template-columns: repeat(8, 1fr);
                gap: 3mm;
                margin-bottom: 5mm;
            }
            
            .showcase-item {
                background: white !important;
                color: #000 !important;
                border: 1px solid #333 !important;
                padding: 3mm;
                border-radius: 2mm;
                text-align: center;
                font-size: 14pt;
                font-weight: bold;
                min-height: 12mm;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: none !important;
                position: relative;
            }
            
            .showcase-item .pinyin-text {
                color: #000 !important;
                font-size: 14pt;
            }
            
            .showcase-item .pinyin-image {
                display: block;
                width: 10mm;
                height: 10mm;
                margin: 2mm auto;
                border: 1px solid #ccc;
            }
            
            .showcase-item .upload-icon,
            .showcase-item .audio-icon {
                display: none !important;
            }
            
            .library-stats {
                display: none !important;
            }
            
            .subtitle {
                display: none !important;
            }
            
            .title {
                color: #000 !important;
                font-size: 20pt;
                margin-bottom: 5mm;
                text-align: center;
            }
            
            /* 确保不打印图片时隐藏 */
            body.print-no-images .showcase-item .pinyin-image {
                display: none !important;
            }
            
            body.print-no-images .showcase-item {
                min-height: 8mm;
            }
        }
        
        @page {
            size: A4;
            margin: 10mm;
        }
        
        /* 移动端适配 */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            /* 导航标签 */
            .nav-tabs {
                gap: 5px;
                margin-bottom: 10px;
            }
            
            .nav-tab {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            /* 屏幕容器 */
            .screen {
                padding: 20px 15px;
                border-radius: 0 15px 15px 15px;
            }
            
            /* 标题 */
            .title {
                font-size: 24px;
                margin-bottom: 15px;
            }
            
            .subtitle {
                font-size: 14px;
                margin-bottom: 20px;
            }
            
            /* 训练模式按钮 */
            .mode-buttons {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .mode-btn {
                padding: 20px;
                font-size: 18px;
            }
            
            .mode-btn.random {
                grid-column: span 1;
            }
            
            /* 批量打印选择器 */
            .batch-print-selector {
                padding: 15px;
            }
            
            .batch-print-selector h3 {
                font-size: 18px;
            }
            
            .batch-options {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .batch-count-control {
                flex-wrap: wrap;
            }
            
            .batch-count-control span {
                width: 100%;
                margin-top: 5px;
            }
            
            /* 训练表单 */
            .training-header h2 {
                font-size: 20px;
            }
            
            .training-info {
                font-size: 12px;
            }
            
            .training-id,
            .training-type {
                font-size: 12px;
                padding: 4px 12px;
            }
            
            .training-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .training-item {
                padding: 8px;
                min-height: 70px;
            }
            
            .pinyin {
                font-size: 20px;
            }
            
            .checkboxes {
                gap: 8px;
                font-size: 11px;
            }
            
            .checkbox-item input[type="checkbox"] {
                width: 14px;
                height: 14px;
            }
            
            /* 操作按钮 */
            .action-buttons {
                flex-direction: column;
                gap: 8px;
            }
            
            .action-btn {
                width: 100%;
                padding: 12px;
                font-size: 14px;
            }
            
            /* 输入界面 */
            .input-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .input-item {
                padding: 10px;
            }
            
            .input-item .pinyin {
                font-size: 24px;
            }
            
            .mark-buttons {
                gap: 5px;
            }
            
            .mark-btn {
                padding: 6px 8px;
                font-size: 12px;
            }
            
            /* 拼音库 */
            .library-section h2 {
                font-size: 20px;
            }
            
            .library-section h3 {
                font-size: 16px;
            }
            
            .pinyin-showcase {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }
            
            .showcase-item {
                padding: 12px 8px;
                font-size: 18px;
                min-height: 70px;
            }
            
            .showcase-item .pinyin-text {
                font-size: 18px;
            }
            
            .showcase-item .pinyin-image {
                width: 40px;
                height: 40px;
            }
            
            .showcase-item .upload-icon {
                width: 20px;
                height: 20px;
                font-size: 12px;
            }
            
            .showcase-item .audio-icon {
                width: 24px;
                height: 24px;
                font-size: 14px;
            }
            
            .library-stats {
                grid-template-columns: 1fr;
            }
            
            /* 图片上传模态框 */
            .image-modal-content {
                width: 95%;
                padding: 20px;
            }
            
            .image-modal-header h3 {
                font-size: 16px;
            }
            
            .upload-area {
                padding: 30px 15px;
            }
            
            .upload-area-icon {
                font-size: 36px;
            }
            
            .upload-area h3 {
                font-size: 16px;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .modal-btn {
                width: 100%;
            }
            
            /* 历史记录 */
            .analytics-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .analytics-card {
                padding: 20px;
            }
            
            .analytics-card .number {
                font-size: 36px;
            }
            
            .history-stats {
                flex-direction: column;
                gap: 10px;
            }
            
            .stat-box {
                width: 100%;
            }
            
            .detail-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            /* 驾驶舱 */
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .panel {
                padding: 12px;
            }
            
            /* 设置界面 */
            .settings-container {
                padding: 0;
            }
            
            .setting-card {
                padding: 20px 15px;
            }
            
            .setting-card h3 {
                font-size: 18px;
            }
            
            .sync-button {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            /* 统计表格 */
            .table-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .table-controls input,
            .table-controls select {
                width: 100%;
            }
            
            .elem-table {
                font-size: 12px;
            }
            
            .elem-table th,
            .elem-table td {
                padding: 8px 6px;
            }
            
            /* 音频控制 */
            .audio-controls {
                flex-direction: column;
            }
            
            .audio-player {
                width: 100%;
            }
            
            .audio-upload-btn {
                width: 100%;
            }
        }
        
        /* 小屏手机适配（320px-480px）*/
        @media screen and (max-width: 480px) {
            .nav-tab {
                padding: 8px 10px;
                font-size: 12px;
            }
            
            .title {
                font-size: 20px;
            }
            
            .mode-btn {
                font-size: 16px;
                padding: 15px;
            }
            
            .training-grid {
                grid-template-columns: 1fr;
            }
            
            .pinyin-showcase {
                grid-template-columns: repeat(3, 1fr);
                gap: 5px;
            }
            
            .showcase-item {
                padding: 10px 5px;
                font-size: 16px;
            }
            
            .batch-preview-item {
                font-size: 13px;
                padding: 8px;
            }
        }
        
        /* 横屏模式优化 */
        @media screen and (max-width: 768px) and (orientation: landscape) {
            .training-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .input-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .pinyin-showcase {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        /* 用户登录界面 */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .login-header p {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .login-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .login-tab {
            flex: 1;
            padding: 12px;
            background: #ecf0f1;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #7f8c8d;
            transition: all 0.3s;
        }
        
        .login-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .login-form {
            display: none;
        }
        
        .login-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: #2c3e50;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-hint {
            color: #7f8c8d;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .login-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .current-user-info {
            background: #d5f4e6;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .current-user-info .user-name {
            color: #27ae60;
            font-weight: bold;
            font-size: 16px;
        }
        
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        
        .logout-btn:hover {
            background: #c0392b;
        }
        
        /* 设置界面 */
        .settings-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .setting-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .setting-card h3 {
            color: #2c3e50;
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .setting-item {
            margin: 20px 0;
        }
        
        .setting-item label {
            display: block;
            color: #555;
            font-size: 16px;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .setting-item input[type="text"],
        .setting-item input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .setting-item input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .setting-item .hint {
            color: #7f8c8d;
            font-size: 13px;
            margin-top: 5px;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .sync-status.success {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .sync-status.error {
            background: #fadbd8;
            color: #e74c3c;
        }
        
        .sync-status.info {
            background: #dfe6e9;
            color: #2c3e50;
        }
        
        .sync-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .sync-button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .sync-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .sync-button.success {
            background: #27ae60;
        }
        
        .sync-button.warning {
            background: #e67e22;
        }
        
        /* 逐项统计表 */
        .table-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin: 10px 0 6px 0;
        }
        .table-controls input, .table-controls select {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .table-wrap {
            overflow: auto;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        table.elem-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
        }
        .elem-table th, .elem-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #f2f2f2;
            white-space: nowrap;
            text-align: left;
            font-size: 14px;
        }
        .elem-table th { background: #fafafa; color:#2c3e50; }
        
        /* 图片上传相关样式 */
        .showcase-item {
            position: relative;
            cursor: pointer;
            min-height: 80px;
        }
        
        .showcase-item .pinyin-text {
            font-size: 22px;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        
        .showcase-item .pinyin-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 6px;
            margin: 5px auto;
            border: 2px solid rgba(255,255,255,0.3);
            display: block;
        }
        
        .showcase-item .upload-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .showcase-item:hover .upload-icon {
            display: flex;
        }
        
        .showcase-item .audio-icon {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(46, 204, 113, 0.9);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 16px;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            border: 2px solid white;
            z-index: 10;
        }
        
        .showcase-item .audio-icon:hover {
            background: rgba(39, 174, 96, 1);
            transform: scale(1.1);
        }
        
        .showcase-item.has-audio .audio-icon {
            display: flex;
        }
        
        .showcase-item .audio-icon.playing {
            background: rgba(231, 76, 60, 0.9);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* 图片上传模态框 */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        
        .image-modal.show {
            display: flex;
        }
        
        .image-modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .image-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .image-modal-header h3 {
            color: #2c3e50;
            margin: 0;
            font-size: 20px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #7f8c8d;
            line-height: 1;
        }
        
        .close-modal:hover {
            color: #e74c3c;
        }
        
        .modal-preview {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px dashed #ddd;
            display: none;
        }
        
        .modal-preview.show {
            display: block;
        }
        
        .upload-area {
            border: 3px dashed #bdc3c7;
            padding: 40px 20px;
            text-align: center;
            border-radius: 10px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: #3498db;
            background: #ecf0f1;
        }
        
        .upload-area.dragover {
            border-color: #27ae60;
            background: #d5f4e6;
        }
        
        .upload-area-icon {
            font-size: 48px;
            margin-bottom: 10px;
            color: #7f8c8d;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .modal-btn.primary {
            background: #3498db;
            color: white;
        }
        
        .modal-btn.primary:hover {
            background: #2980b9;
        }
        
        .modal-btn.danger {
            background: #e74c3c;
            color: white;
        }
        
        .modal-btn.danger:hover {
            background: #c0392b;
        }
        
        .modal-btn.secondary {
            background: #95a5a6;
            color: white;
        }
        
        .modal-btn.secondary:hover {
            background: #7f8c8d;
        }
        
        /* 音频上传区域 */
        .audio-upload-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #ecf0f1;
        }
        
        .audio-upload-section h4 {
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .audio-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }
        
        .audio-player {
            flex: 1;
            height: 40px;
            border-radius: 8px;
            display: none;
        }
        
        .audio-player.show {
            display: block;
        }
        
        .audio-upload-btn {
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .audio-upload-btn:hover {
            background: #229954;
        }
        
        .audio-status {
            color: #27ae60;
            font-size: 14px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- 用户登录/注册界面 -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-container">
            <div class="login-header">
                <h1>🎓 桐桐拼音训练系统</h1>
                <p>请登录或注册以继续</p>
                <p style="font-size: 12px; color: #95a5a6; margin-top: 8px;">
                    💡 首次使用？请先注册账户
                </p>
            </div>
            
            <div class="login-tabs">
                <button class="login-tab active" onclick="switchLoginTab('login')">登录</button>
                <button class="login-tab" onclick="switchLoginTab('register')">注册</button>
            </div>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="action-btn" style="padding: 8px 16px; font-size: 14px; background: #27ae60;" onclick="syncUsersAndReload()">
                    ☁️ 从云端同步账户
                </button>
                <p style="color: #7f8c8d; font-size: 12px; margin-top: 8px;">
                    已在其他设备注册？点击同步<br>
                    <span style="color: #e74c3c; font-weight: bold;">⚠️ 首次使用请先注册</span>
                </p>
            </div>
            
            <!-- 登录表单 -->
            <form class="login-form active" id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>用户名</label>
                    <input type="text" id="loginUsername" required minlength="3" 
                           placeholder="请输入用户名">
                </div>
                
                <div class="form-group">
                    <label>密码</label>
                    <input type="password" id="loginPassword" required minlength="6" 
                           placeholder="请输入密码">
                </div>
                
                <button type="submit" class="login-btn">登录</button>
            </form>
            
            <!-- 注册表单 -->
            <form class="login-form" id="registerForm" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label>用户名</label>
                    <input type="text" id="registerUsername" required minlength="3" maxlength="20" 
                           placeholder="3-20个字符">
                    <div class="form-hint">用户名将用于识别您的数据</div>
                </div>
                
                <div class="form-group">
                    <label>显示名称</label>
                    <input type="text" id="registerDisplayName" required 
                           placeholder="例如：桐桐">
                    <div class="form-hint">用于界面显示的昵称</div>
                </div>
                
                <div class="form-group">
                    <label>密码</label>
                    <input type="password" id="registerPassword" required minlength="6" 
                           placeholder="至少6个字符">
                </div>
                
                <div class="form-group">
                    <label>确认密码</label>
                    <input type="password" id="registerPasswordConfirm" required minlength="6" 
                           placeholder="请再次输入密码">
                </div>
                
                <button type="submit" class="login-btn">注册</button>
            </form>
        </div>
    </div>
    
    <!-- 导航标签 -->
    <div class="nav-tabs">
        <div class="nav-tab active" onclick="switchScreen('training')">🎓 开始训练</div>
        <div class="nav-tab" onclick="switchScreen('input')">📝 录入结果</div>
        <div class="nav-tab" onclick="switchScreen('ocr')">📷 拍照识别</div>
        <div class="nav-tab" onclick="switchScreen('history')">📊 历史记录</div>
        <div class="nav-tab" onclick="switchScreen('library')">📚 拼音库</div>
        <div class="nav-tab" onclick="switchScreen('dashboard')">📈 驾驶舱</div>
        <div class="nav-tab" onclick="switchScreen('settings')">⚙️ 设置</div>
    </div>

    <!-- 1. 训练模式选择 -->
    <div class="screen active" id="trainingScreen">
        <div id="selectionView">
            <h1 class="title">🎓 桐桐拼音训练系统</h1>
            <p class="subtitle">选择训练模式，系统将自动生成一页训练表单（7行×4列=28个）</p>
            
            <!-- 批量打印选择器 -->
            <div class="batch-print-selector">
                <h3>📄 批量打印多张表单</h3>
                <p style="color: #7f8c8d; margin-bottom: 15px;">选择需要打印的训练类型和数量，一次性生成多张不同的训练表单</p>
                
                <div class="batch-options">
                    <div class="batch-option" onclick="toggleBatchOption('shengmu', this)">
                        <input type="checkbox" id="batch-shengmu" onclick="event.stopPropagation(); toggleBatchOption('shengmu', this.parentElement)">
                        <div class="option-title">📝 声母训练</div>
                        <div class="option-desc">23个声母</div>
                    </div>
                    
                    <div class="batch-option" onclick="toggleBatchOption('danyunmu', this)">
                        <input type="checkbox" id="batch-danyunmu" onclick="event.stopPropagation(); toggleBatchOption('danyunmu', this.parentElement)">
                        <div class="option-title">📝 单韵母训练</div>
                        <div class="option-desc">24个（含声调）</div>
                    </div>
                    
                    <div class="batch-option" onclick="toggleBatchOption('shuangyunmu', this)">
                        <input type="checkbox" id="batch-shuangyunmu" onclick="event.stopPropagation(); toggleBatchOption('shuangyunmu', this.parentElement)">
                        <div class="option-title">📝 复韵母训练</div>
                        <div class="option-desc">36个（含声调）</div>
                    </div>
                    
                    <div class="batch-option" onclick="toggleBatchOption('biyunmu', this)">
                        <input type="checkbox" id="batch-biyunmu" onclick="event.stopPropagation(); toggleBatchOption('biyunmu', this.parentElement)">
                        <div class="option-title">📝 鼻韵母训练</div>
                        <div class="option-desc">36个（含声调）</div>
                    </div>
                    
                    <div class="batch-option" onclick="toggleBatchOption('zhengti', this)">
                        <input type="checkbox" id="batch-zhengti" onclick="event.stopPropagation(); toggleBatchOption('zhengti', this.parentElement)">
                        <div class="option-title">📝 整体认读</div>
                        <div class="option-desc">64个（含声调）</div>
                    </div>
                    
                    <div class="batch-option" onclick="toggleBatchOption('qianziwen', this)">
                        <input type="checkbox" id="batch-qianziwen" onclick="event.stopPropagation(); toggleBatchOption('qianziwen', this.parentElement)">
                        <div class="option-title">📖 千字文训练</div>
                        <div class="option-desc">250句（汉字+拼音）</div>
                    </div>
                    
                    <div class="batch-option" onclick="toggleBatchOption('random', this)">
                        <input type="checkbox" id="batch-random" onclick="event.stopPropagation(); toggleBatchOption('random', this.parentElement)">
                        <div class="option-title">🎲 随机混合</div>
                        <div class="option-desc">所有内容混合</div>
                    </div>
                </div>
                
                <div class="batch-count-control">
                    <label>每种类型打印份数：</label>
                    <input type="number" id="batchCount" value="1" min="1" max="10">
                    <span style="color: #7f8c8d;">（每份都是不同的随机组合）</span>
                </div>
                
                <div class="batch-preview-area" id="batchPreview" style="display: none;">
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">📋 将要生成的表单：</h4>
                    <div id="batchPreviewList"></div>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn success" onclick="generateBatchPrint()" id="batchPrintBtn" disabled>
                        🖨️ 生成并打印（<span id="totalPages">0</span> 页）
                    </button>
                    <button class="action-btn secondary" onclick="clearBatchSelection()">🔄 清除选择</button>
                </div>
            </div>
            
            <div style="text-align: center; margin: 20px 0; color: #7f8c8d;">
                —— 或者选择单个训练模式 ——
            </div>
            
            <div class="mode-buttons">
                <button class="mode-btn" onclick="startTraining('shengmu')">
                    📝 声母训练<br>
                    <span style="font-size: 16px; opacity: 0.9;">23个声母</span>
                </button>
                
                <button class="mode-btn" onclick="startTraining('danyunmu')">
                    📝 单韵母训练<br>
                    <span style="font-size: 16px; opacity: 0.9;">24个（6×4声调）</span>
                </button>
                
                <button class="mode-btn" onclick="startTraining('shuangyunmu')">
                    📝 复韵母训练<br>
                    <span style="font-size: 16px; opacity: 0.9;">36个（9×4声调）</span>
                </button>
                
                <button class="mode-btn" onclick="startTraining('biyunmu')">
                    📝 鼻韵母训练<br>
                    <span style="font-size: 16px; opacity: 0.9;">36个（9×4声调）</span>
                </button>
                
                <button class="mode-btn" onclick="startTraining('zhengti')">
                    📝 整体认读<br>
                    <span style="font-size: 16px; opacity: 0.9;">64个（16×4声调）</span>
                </button>
                
                <button class="mode-btn" onclick="startTraining('qianziwen')" style="background: linear-gradient(135deg, #fbc531 0%, #e55039 100%);">
                    📖 千字文训练<br>
                    <span style="font-size: 16px; opacity: 0.9;">250句（汉字+拼音）</span>
                </button>
                
                <button class="mode-btn random" onclick="startTraining('random')">
                    🎲 随机训练<br>
                    <span style="font-size: 16px; opacity: 0.9;">混合所有内容</span>
                </button>
            </div>
            
            <div class="stats">
                <h3>📊 训练库统计</h3>
                <ul>
                    <li>✓ 声母：23个</li>
                    <li>✓ 单韵母（含声调）：24个（6个 × 4声调）</li>
                    <li>✓ 复韵母（含声调）：36个（9个 × 4声调）</li>
                    <li>✓ 鼻韵母（含声调）：36个（9个 × 4声调）</li>
                    <li>✓ 整体认读音节（含声调）：64个（16个 × 4声调）</li>
                    <li>✓ 千字文四字句：250句（完整千字文，共1000字）</li>
                    <li>✓ 基础训练项总计：183个</li>
                    <li>✓ 每页显示：28个训练项（7行×4列）</li>
                </ul>
            </div>
        </div>
        
        <div id="trainingView" style="display: none;">
            <!-- 单张表单容器 -->
            <div id="singleSheetContainer">
                <div class="training-header">
                    <h2>桐桐拼音训练记录表</h2>
                    <div class="training-info">
                        训练日期：________年____月____日　　训练者：__________
                    </div>
                    <div class="training-id" id="trainingId"></div>
                    <div class="training-type" id="trainingType"></div>
                </div>
                
                <div class="training-grid" id="trainingGrid"></div>
                
                <div class="action-buttons">
                    <button class="action-btn" onclick="window.print()">🖨️ 打印表单</button>
                    <button class="action-btn success" onclick="goToInput()">✍️ 开始录入结果</button>
                    <button class="action-btn" onclick="regenerate()">🔄 重新生成</button>
                    <button class="action-btn secondary" onclick="backToSelection()">← 返回选择</button>
                </div>
            </div>
            
            <!-- 批量打印容器 -->
            <div id="batchSheetsContainer" style="display: none;"></div>
        </div>
    </div>

    <!-- 2. 手动录入界面 -->
    <div class="screen" id="inputScreen">
        <h1 class="title">📝 手动录入训练结果</h1>
        <p class="subtitle">点击拼音框选择"对"或"错"，完成后保存到结果库</p>
        
        <div id="inputContent">
            <p style="text-align: center; color: #7f8c8d; font-size: 16px; padding: 40px;">
                请先在"开始训练"标签中生成训练表单
            </p>
        </div>
        
        <div class="action-buttons" id="inputActions" style="display: none;">
            <button class="action-btn success" onclick="saveResults()">💾 保存结果</button>
            <button class="action-btn secondary" onclick="clearInput()">🔄 清除选择</button>
        </div>
    </div>

    <!-- 3. 拍照OCR识别 -->
    <div class="screen" id="ocrScreen">
        <h1 class="title">📷 拍照识别训练结果</h1>
        <p class="subtitle">上传训练表单照片，系统将自动识别勾选结果</p>
        
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon">📸</div>
            <h3>点击或拖拽上传照片</h3>
            <p style="color: #7f8c8d; margin-top: 10px;">支持 JPG、PNG 格式</p>
            <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
        </div>
        
        <img id="previewImage" class="preview-image" style="display: none;">
        
        <div class="ocr-progress" id="ocrProgress">
            <h3 style="text-align: center; color: #2c3e50; margin-bottom: 10px;">正在识别...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <p id="ocrStatus" style="text-align: center; color: #7f8c8d; margin-top: 10px;"></p>
        </div>
        
        <div id="ocrResults" style="display: none;">
            <h3 style="color: #2c3e50; margin: 20px 0;">识别结果（请核对并修正）</h3>
            <div id="ocrResultGrid"></div>
            <div class="action-buttons">
                <button class="action-btn" onclick="markAllOCRResults(true)" style="background: #27ae60;">✓ 全部标记为正确</button>
                <button class="action-btn" onclick="markAllOCRResults(false)" style="background: #e74c3c;">✗ 全部标记为错误</button>
                <button class="action-btn success" onclick="saveOCRResults()">💾 确认并保存</button>
                <button class="action-btn warning" onclick="resetOCR()">🔄 重新上传</button>
            </div>
        </div>
        
        <div class="stats" style="margin-top: 30px;">
            <h3>💡 使用提示</h3>
            <ul>
                <li>📸 <strong>拍照技巧：</strong>确保照片清晰，光线充足，避免阴影和反光</li>
                <li>📐 <strong>角度要求：</strong>尽量保持表单平整，正面拍摄，避免倾斜或变形</li>
                <li>🆔 <strong>训练编号：</strong>确保训练表单顶部的ID（T开头的数字）清晰可见</li>
                <li>✓ <strong>勾选标记：</strong>勾选的✓和✗要清楚，不要模糊</li>
                <li>🔍 <strong>识别范围：</strong>系统会自动识别训练ID、类型、拼音项和勾选状态</li>
                <li>✏️ <strong>人工确认：</strong>识别后请仔细核对每个项目，特别是标记为🔴的低置信度项</li>
                <li>💾 <strong>保存前检查：</strong>确认所有训练项都已正确标记后再保存</li>
                <li>🔄 <strong>重新识别：</strong>如果识别结果不理想，可以点击"重新上传"按钮重拍照片</li>
            </ul>
            
            <div style="background: #d5f4e6; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #27ae60;">
                <p style="color: #155724; margin: 0; line-height: 1.8;">
                    <strong>✨ 智能识别功能：</strong><br>
                    • 自动提取训练编号（T后面的数字）<br>
                    • 智能识别训练类型（声母、韵母、千字文等）<br>
                    • 批量识别所有拼音项<br>
                    • 自动检测勾选标记（✓正确 / ✗错误）<br>
                    • 图像自动增强处理，提高识别准确率<br>
                    • 置信度评分，帮助您快速定位需要确认的项目
                </p>
            </div>
        </div>
    </div>

    <!-- 4. 历史记录 -->
    <div class="screen" id="historyScreen">
        <h1 class="title">📊 训练历史记录</h1>
        
        <div class="analytics-grid" id="analyticsGrid">
            <div class="analytics-card">
                <h3>总训练次数</h3>
                <div class="number" id="totalTrainings">0</div>
            </div>
            <div class="analytics-card">
                <h3>总训练项数</h3>
                <div class="number" id="totalItems">0</div>
            </div>
            <div class="analytics-card">
                <h3>平均正确率</h3>
                <div class="number" id="avgAccuracy">0%</div>
            </div>
        </div>
        
        <h2 style="color: #2c3e50; margin: 30px 0 20px;">训练记录列表</h2>
        <div class="history-list" id="historyList">
            <p style="text-align: center; color: #7f8c8d; padding: 40px;">暂无训练记录</p>
        </div>
    </div>

    <!-- 5. 拼音库 -->
    <div class="screen" id="libraryScreen">
        <h1 class="title">📚 完整拼音库</h1>
        <p class="subtitle">汉语拼音全部内容一览</p>
        
        <div class="action-buttons" style="margin-bottom: 20px;">
            <button class="action-btn success" onclick="printLibrary()">🖨️ 打印拼音库（A4）</button>
            <button class="action-btn" onclick="printLibraryWithImages()">🖨️ 打印拼音库（含图片）</button>
        </div>
        
        <!-- 声母 -->
        <div class="library-section">
            <h2>📝 声母（23个）</h2>
            <div class="pinyin-showcase" id="shengmuShowcase"></div>
        </div>
        
        <!-- 单韵母 -->
        <div class="library-section">
            <h2>📝 单韵母（6个基础 × 4声调 = 24个）</h2>
            <h3>ā - a的四个声调</h3>
            <div class="pinyin-showcase">
                <div class="showcase-item danyunmu">ā</div>
                <div class="showcase-item danyunmu">á</div>
                <div class="showcase-item danyunmu">ǎ</div>
                <div class="showcase-item danyunmu">à</div>
            </div>
            <h3>ō - o的四个声调</h3>
            <div class="pinyin-showcase">
                <div class="showcase-item danyunmu">ō</div>
                <div class="showcase-item danyunmu">ó</div>
                <div class="showcase-item danyunmu">ǒ</div>
                <div class="showcase-item danyunmu">ò</div>
            </div>
            <h3>ē - e的四个声调</h3>
            <div class="pinyin-showcase">
                <div class="showcase-item danyunmu">ē</div>
                <div class="showcase-item danyunmu">é</div>
                <div class="showcase-item danyunmu">ě</div>
                <div class="showcase-item danyunmu">è</div>
            </div>
            <h3>ī - i的四个声调</h3>
            <div class="pinyin-showcase">
                <div class="showcase-item danyunmu">ī</div>
                <div class="showcase-item danyunmu">í</div>
                <div class="showcase-item danyunmu">ǐ</div>
                <div class="showcase-item danyunmu">ì</div>
            </div>
            <h3>ū - u的四个声调</h3>
            <div class="pinyin-showcase">
                <div class="showcase-item danyunmu">ū</div>
                <div class="showcase-item danyunmu">ú</div>
                <div class="showcase-item danyunmu">ǔ</div>
                <div class="showcase-item danyunmu">ù</div>
            </div>
            <h3>ǖ - ü的四个声调</h3>
            <div class="pinyin-showcase">
                <div class="showcase-item danyunmu">ǖ</div>
                <div class="showcase-item danyunmu">ǘ</div>
                <div class="showcase-item danyunmu">ǚ</div>
                <div class="showcase-item danyunmu">ǜ</div>
            </div>
        </div>
        
        <!-- 复韵母 -->
        <div class="library-section">
            <h2>📝 复韵母（9个基础 × 4声调 = 36个）</h2>
            <div class="pinyin-showcase" id="shuangyunmuShowcase"></div>
        </div>
        
        <!-- 鼻韵母 -->
        <div class="library-section">
            <h2>📝 鼻韵母（9个基础 × 4声调 = 36个）</h2>
            <h3>前鼻韵母（5个）</h3>
            <div class="pinyin-showcase" id="qianbiyunmuShowcase"></div>
            <h3 style="margin-top: 20px;">后鼻韵母（4个）</h3>
            <div class="pinyin-showcase" id="houbiyunmuShowcase"></div>
        </div>
        
        <!-- 整体认读音节 -->
        <div class="library-section">
            <h2>📝 整体认读音节（16个基础 × 4声调 = 64个）</h2>
            <div class="pinyin-showcase" id="zhengtiShowcase"></div>
        </div>
        
        <!-- 千字文四字句库 -->
        <div class="library-section">
            <h2>📖 千字文四字句库（250句，共1000字）</h2>
            <p style="color: #7f8c8d; margin-bottom: 15px;">
                千字文是中国古代经典蒙学教材，由南北朝梁武帝时周兴嗣编纂，全文由250句四字韵文组成，共1000个不重复的汉字。
                每句四个汉字配对应的四个拼音，既可以训练拼音，又能学习汉字和传统文化。
                本训练库按四字句为单位进行训练，每次随机抽取7句（28个字）。
            </p>
            <div class="pinyin-showcase" id="qianziwenShowcase"></div>
        </div>
        
        <!-- 统计汇总 -->
        <div class="library-stats">
            <div class="library-stat-card">
                <h4>📊 基础拼音库</h4>
                <div class="count">183</div>
                <p style="color: #7f8c8d; margin-top: 10px;">个基础训练项</p>
            </div>
            <div class="library-stat-card">
                <h4>🎯 训练组合</h4>
                <ul style="list-style: none; padding: 0; color: #555; font-size: 14px; line-height: 1.8;">
                    <li>✓ 声母：23个</li>
                    <li>✓ 单韵母：24个</li>
                    <li>✓ 复韵母：36个</li>
                    <li>✓ 鼻韵母：36个</li>
                    <li>✓ 整体认读：64个</li>
                    <li>✓ 千字文：250句（1000字）</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 6. 设置界面 -->
    <div class="screen" id="settingsScreen">
        <h1 class="title">⚙️ 系统设置</h1>
        <p class="subtitle">配置GitHub同步，实现多设备数据共享</p>
        
        <div class="settings-container">
            <!-- 当前用户信息 -->
            <div class="setting-card">
                <h3>👤 当前用户</h3>
                <div class="current-user-info">
                    <div>
                        <div class="user-name" id="currentUserDisplay">未登录</div>
                        <div style="color: #7f8c8d; font-size: 13px; margin-top: 5px;">用户名：<span id="currentUsernameDisplay">-</span></div>
                    </div>
                    <button class="logout-btn" onclick="handleLogout()">退出登录</button>
                </div>
                <p style="color: #7f8c8d; font-size: 13px; line-height: 1.6;">
                    您的所有训练数据和设置都与当前账户关联。切换账户后，将看到该账户的独立数据。
                </p>
            </div>
            <!-- GitHub同步设置 -->
            <div class="setting-card">
                <h3>🔗 GitHub数据同步</h3>
                <p style="color: #7f8c8d; margin-bottom: 20px; line-height: 1.6;">
                    配置GitHub Personal Access Token后，您的训练数据将自动同步到GitHub仓库，
                    在任何设备上都能访问相同的训练记录。
                </p>
                
                <div class="setting-item">
                    <label>GitHub Personal Access Token</label>
                    <input type="password" id="githubToken" placeholder="输入您的GitHub Token">
                    <div class="hint">
                        <a href="https://github.com/settings/tokens/new" target="_blank" style="color: #3498db;">点击这里创建Token</a>
                        （需要勾选 repo 权限）
                    </div>
                </div>
                
                <div class="setting-item">
                    <label>GitHub用户名</label>
                    <input type="text" id="githubUsername" placeholder="例如: Jiaming-Yi" value="Jiaming-Yi">
                </div>
                
                <div class="setting-item">
                    <label>仓库名称</label>
                    <input type="text" id="githubRepo" placeholder="例如: pingyinxulian" value="pingyinxulian">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                    <button class="sync-button" onclick="saveGitHubConfig()">💾 保存配置</button>
                    <button class="sync-button success" onclick="syncToGitHub()">☁️ 上传训练数据</button>
                    <button class="sync-button warning" onclick="syncFromGitHub()">⬇️ 下载训练数据</button>
                    <button class="sync-button" style="background: #9b59b6;" onclick="syncUsersManually()">👥 同步账户信息</button>
                </div>
                
                <div id="syncStatus" style="display: none;" class="sync-status"></div>
            </div>
            
            <!-- 数据管理 -->
            <div class="setting-card">
                <h3>📦 数据管理</h3>
                
                <div class="setting-item">
                    <label>本地数据</label>
                    <div id="localDataInfo" style="color: #7f8c8d; margin: 10px 0;"></div>
                    <button class="sync-button" onclick="exportLocalData()">📥 导出本地数据</button>
                    <button class="sync-button warning" onclick="clearLocalData()">🗑️ 清除本地数据</button>
                </div>
            </div>
            
            <!-- 使用说明 -->
            <div class="setting-card">
                <h3>💡 使用说明</h3>
                <ol style="color: #555; line-height: 2; padding-left: 20px;">
                    <li>访问 <a href="https://github.com/settings/tokens/new" target="_blank" style="color: #3498db;">GitHub Token页面</a> 创建新Token</li>
                    <li>Token名称随意，有效期建议选择90天或更长</li>
                    <li>勾选 <strong>repo</strong> 权限（完整的仓库访问权限）</li>
                    <li>点击生成Token，复制Token（注意：只显示一次！）</li>
                    <li>回到本页面，粘贴Token并保存配置</li>
                    <li>首次使用点击"上传数据到GitHub"</li>
                    <li>在其他设备使用时，点击"从GitHub下载数据"即可同步</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- 图片上传模态框 -->
    <div class="image-modal" id="imageModal">
        <div class="image-modal-content">
            <div class="image-modal-header">
                <h3>为 "<span id="modalPinyin"></span>" 上传图片</h3>
                <button class="close-modal" onclick="closeImageModal()">&times;</button>
            </div>
            
            <img id="modalPreview" class="modal-preview" alt="预览">
            
            <div class="upload-area" id="modalUploadArea" onclick="document.getElementById('modalFileInput').click()">
                <div class="upload-area-icon">📷</div>
                <h3 style="color: #2c3e50; margin: 10px 0;">点击或拖拽上传图片</h3>
                <p style="color: #7f8c8d; font-size: 14px;">支持 JPG、PNG、GIF 格式</p>
                <input type="file" id="modalFileInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
            </div>
            
            <!-- 音频上传区域 -->
            <div class="audio-upload-section">
                <h4>🔊 发音音频</h4>
                <div class="audio-controls">
                    <audio id="modalAudioPlayer" class="audio-player" controls></audio>
                    <button class="audio-upload-btn" onclick="document.getElementById('modalAudioInput').click()">
                        📁 选择音频
                    </button>
                    <input type="file" id="modalAudioInput" accept="audio/*" style="display: none;" onchange="handleAudioSelect(event)">
                    <span id="audioStatus" class="audio-status"></span>
                </div>
                <p style="color: #7f8c8d; font-size: 13px; margin-top: 5px;">支持 MP3、WAV、OGG 格式，文件不超过10MB</p>
            </div>
            
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeImageModal()">取消</button>
                <button class="modal-btn danger" onclick="deletePinyinImage()" id="deleteImageBtn" style="display: none;">删除图片</button>
                <button class="modal-btn danger" onclick="deletePinyinAudio()" id="deleteAudioBtn" style="display: none;">删除音频</button>
                <button class="modal-btn primary" onclick="savePinyinData()" id="saveDataBtn">保存</button>
            </div>
        </div>
    </div>

    <!-- 驾驶舱 -->
    <div class="screen" id="dashboardScreen">
        <h1 class="title">📈 学习驾驶舱</h1>
        <p class="subtitle">实时查看训练进展、趋势与易错项</p>
        
        <div class="analytics-grid" id="dashboardKpis">
            <div class="analytics-card">
                <h3>累计训练次数</h3>
                <div class="number" id="kpiTotalTimes">0</div>
            </div>
            <div class="analytics-card">
                <h3>累计训练项数</h3>
                <div class="number" id="kpiTotalItems">0</div>
            </div>
            <div class="analytics-card">
                <h3>平均正确率</h3>
                <div class="number" id="kpiAvgRate">0%</div>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <div class="panel">
                <h3>近7天训练趋势</h3>
                <canvas id="trendChart" width="800" height="300"></canvas>
                <div class="muted" id="trendHint">显示每日训练项数与正确率（%）</div>
            </div>
            <div class="panel">
                <h3>易错Top 10</h3>
                <div class="top-list" id="topMistakes">
                    <!-- 动态填充：拼音 | 错误次数 | 正确率 -->
                </div>
            </div>
        </div>
        
        <div class="panel" style="margin-top: 16px;">
            <h3>按训练类型统计</h3>
            <canvas id="typeChart" width="1000" height="260"></canvas>
            <div class="muted">显示各训练类型的训练项数与正确率</div>
        </div>
        
        <div class="panel" style="margin-top: 16px;">
            <h3>逐项统计（每个拼音）</h3>
            <div class="table-controls">
                <input type="text" id="elemSearch" placeholder="搜索拼音..." oninput="renderElementTable()">
                <select id="elemTypeFilter" onchange="renderElementTable()">
                    <option value="">全部类型</option>
                    <option value="声母">声母</option>
                    <option value="单韵母">单韵母</option>
                    <option value="复韵母">复韵母</option>
                    <option value="鼻韵母">鼻韵母</option>
                    <option value="整体认读">整体认读</option>
                    <option value="千字文">千字文</option>
                </select>
                <select id="elemSort" onchange="renderElementTable()">
                    <option value="tries_desc">按尝试数(多→少)</option>
                    <option value="acc_desc">按正确率(高→低)</option>
                    <option value="wrong_desc">按错误数(多→少)</option>
                    <option value="latest_desc">按最近训练(新→旧)</option>
                    <option value="pinyin_asc">按拼音(A→Z)</option>
                </select>
                <button class="action-btn" onclick="exportElementCsv()">📤 导出CSV</button>
            </div>
            <div class="table-wrap">
                <table class="elem-table">
                    <thead>
                        <tr>
                            <th>拼音</th>
                            <th>类型</th>
                            <th>尝试</th>
                            <th>正确</th>
                            <th>错误</th>
                            <th>正确率</th>
                            <th>最近训练</th>
                        </tr>
                    </thead>
                    <tbody id="elemTableBody"></tbody>
                </table>
            </div>
            <div class="muted" id="elemSummary" style="margin-top:6px;"></div>
        </div>
        
        <div class="action-buttons" style="margin-top: 16px;">
            <button class="action-btn" onclick="refreshDashboard()">🔄 刷新驾驶舱</button>
            <button class="action-btn" onclick="syncFromGitHubAndRefresh()">☁️ 从GitHub同步并刷新</button>
        </div>
    </div>

    <script>
        // ========== 用户认证系统 ==========
        
        // 用户数据结构
        let users = JSON.parse(localStorage.getItem('users') || '{}');
        let currentUser = null;
        
        // 初始化：检查是否有登录用户
        function initUserSystem() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                hideLoginOverlay();
                updateUserDisplay();
            } else {
                showLoginOverlay();
            }
        }
        
        // 同步账户并重新加载
        async function syncUsersAndReload() {
            // 先检查是否配置了GitHub
            if (!githubConfig.token) {
                const confirmConfig = confirm('📋 需要配置GitHub信息才能同步账户\n\n如果您在其他设备上注册过账户：\n\n1. 需要先获取GitHub Token\n2. 访问: github.com/settings/tokens/new\n3. 创建Token（勾选repo权限）\n\n点击"确定"继续配置\n点击"取消"先在本地注册账户');
                
                if (!confirmConfig) {
                    return;
                }
                
                // 显示临时输入框让用户配置
                const token = prompt('📝 步骤1/3：请粘贴您的GitHub Personal Access Token\n\n（从 github.com/settings/tokens/new 获取）\n（需要勾选 repo 权限）');
                if (!token || token.trim() === '') {
                    alert('❌ 未输入Token，操作取消');
                    return;
                }
                
                const username = prompt('📝 步骤2/3：请输入GitHub用户名', 'Jiaming-Yi');
                if (!username || username.trim() === '') {
                    alert('❌ 未输入用户名，操作取消');
                    return;
                }
                
                const repo = prompt('📝 步骤3/3：请输入仓库名', 'pingyinxulian');
                if (!repo || repo.trim() === '') {
                    alert('❌ 未输入仓库名，操作取消');
                    return;
                }
                
                // 保存配置
                githubConfig.token = token.trim();
                githubConfig.username = username.trim();
                githubConfig.repo = repo.trim();
                localStorage.setItem('github_token', githubConfig.token);
                localStorage.setItem('github_username', githubConfig.username);
                localStorage.setItem('github_repo', githubConfig.repo);
                
                alert('✅ GitHub配置已保存！\n\n现在开始同步账户...');
            }
            
            // 显示加载提示
            const syncBtn = event.target;
            const originalText = syncBtn.innerHTML;
            syncBtn.disabled = true;
            syncBtn.innerHTML = '⏳ 同步中...';
            
            try {
                const success = await syncUsersFromGitHub();
                
                if (success) {
                    const userCount = Object.keys(users).length;
                    alert(`✅ 账户同步成功！\n\n已同步 ${userCount} 个账户\n现在可以使用这些账户登录了。`);
                    // 刷新用户列表
                    users = JSON.parse(localStorage.getItem('users') || '{}');
                } else {
                    alert('❌ 同步失败\n\n可能的原因：\n\n1. GitHub上还没有用户数据\n   ➜ 请先在一台设备上注册账户\n   ➜ 然后在设置中点击"同步账户信息"\n\n2. Token权限不足\n   ➜ Token需要勾选 repo 权限\n\n3. 网络连接问题\n   ➜ 请检查网络连接\n\n💡 建议：如果这是第一次使用，请先注册新账户。');
                }
            } catch (error) {
                console.error('同步错误详情:', error);
                alert('❌ 同步出错\n\n错误信息：' + error.message + '\n\n请检查：\n1. GitHub Token是否正确\n2. 网络连接是否正常\n3. GitHub仓库是否存在');
            } finally {
                syncBtn.disabled = false;
                syncBtn.innerHTML = originalText;
            }
        }
        
        // 显示/隐藏登录界面
        function showLoginOverlay() {
            document.getElementById('loginOverlay').style.display = 'flex';
        }
        
        function hideLoginOverlay() {
            document.getElementById('loginOverlay').style.display = 'none';
        }
        
        // 切换登录/注册标签
        function switchLoginTab(tab) {
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelectorAll('.login-tab')[0].classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.querySelectorAll('.login-tab')[1].classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            }
        }
        
        // 处理注册
        function handleRegister(event) {
            event.preventDefault();
            
            const username = document.getElementById('registerUsername').value.trim();
            const displayName = document.getElementById('registerDisplayName').value.trim();
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            
            // 验证
            if (password !== passwordConfirm) {
                alert('两次输入的密码不一致！');
                return;
            }
            
            if (users[username]) {
                alert('该用户名已被注册，请选择其他用户名！');
                return;
            }
            
            // 创建新用户
            users[username] = {
                username: username,
                displayName: displayName,
                password: password, // 实际应用中应该加密
                createdAt: new Date().toISOString(),
                lastLoginAt: new Date().toISOString()
            };
            
            // 保存用户数据
            localStorage.setItem('users', JSON.stringify(users));
            
            // 自动登录
            currentUser = users[username];
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // 尝试同步用户信息到GitHub（如果已配置）
            syncUsersToGitHub().then(synced => {
                if (synced) {
                    console.log('用户信息已同步到GitHub');
                }
            });
            
            alert(`✅ 注册成功！欢迎，${displayName}！\n\n💡 提示：在"设置"中配置GitHub Token后，可以在多个设备上使用同一账户。`);
            
            hideLoginOverlay();
            updateUserDisplay();
            loadUserData();
        }
        
        // 处理登录
        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            // 验证
            if (!users[username]) {
                alert('用户名不存在！');
                return;
            }
            
            if (users[username].password !== password) {
                alert('密码错误！');
                return;
            }
            
            // 登录成功
            users[username].lastLoginAt = new Date().toISOString();
            localStorage.setItem('users', JSON.stringify(users));
            
            currentUser = users[username];
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            alert(`✅ 登录成功！欢迎回来，${currentUser.displayName}！`);
            
            hideLoginOverlay();
            updateUserDisplay();
            loadUserData();
        }
        
        // 处理登出
        function handleLogout() {
            if (confirm('确定要退出登录吗？\n\n您的数据已保存，下次登录可继续使用。')) {
                currentUser = null;
                localStorage.removeItem('currentUser');
                showLoginOverlay();
                
                // 清空当前显示的数据
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
            }
        }
        
        // 更新用户显示
        function updateUserDisplay() {
            if (currentUser) {
                document.getElementById('currentUserDisplay').textContent = currentUser.displayName;
                document.getElementById('currentUsernameDisplay').textContent = currentUser.username;
            }
        }
        
        // 获取用户专属的数据键名
        function getUserDataKey(key) {
            return currentUser ? `${currentUser.username}_${key}` : key;
        }
        
        // 加载用户数据
        function loadUserData() {
            if (!currentUser) return;
            
            // 重新加载用户的训练记录
            const userTrainingKey = getUserDataKey('pinyinTrainingDB');
            const userImagesKey = getUserDataKey('pinyinImages');
            const userAudiosKey = getUserDataKey('pinyinAudios');
            
            // 加载数据到全局变量
            pinyinImages = JSON.parse(localStorage.getItem(userImagesKey) || '{}');
            pinyinAudios = JSON.parse(localStorage.getItem(userAudiosKey) || '{}');
            
            // 刷新界面
            if (document.getElementById('libraryScreen').classList.contains('active')) {
                loadLibrary();
            }
        }
        
        // 保存用户数据（重写原有的保存函数）
        function saveToDatabase(record) {
            const userKey = getUserDataKey('pinyinTrainingDB');
            let database = JSON.parse(localStorage.getItem(userKey) || '[]');
            database.push(record);
            localStorage.setItem(userKey, JSON.stringify(database));
        }
        
        // 页面加载时初始化用户系统
        window.addEventListener('DOMContentLoaded', function() {
            initUserSystem();
        });
        
        // ========== 原有代码开始 ==========
        
        // 完整拼音库
        const pinyinDatabase = {
            shengmu: ['b', 'p', 'm', 'f', 'd', 't', 'n', 'l', 'g', 'k', 'h', 'j', 'q', 'x', 'zh', 'ch', 'sh', 'r', 'z', 'c', 's', 'y', 'w'],
            
            // 单韵母（6个 × 4声调 = 24个）
            danyunmu: [
                'ā', 'á', 'ǎ', 'à',
                'ō', 'ó', 'ǒ', 'ò',
                'ē', 'é', 'ě', 'è',
                'ī', 'í', 'ǐ', 'ì',
                'ū', 'ú', 'ǔ', 'ù',
                'ǖ', 'ǘ', 'ǚ', 'ǜ'
            ],
            
            // 复韵母（9个 × 4声调 = 36个）
            shuangyunmu: [
                'āi', 'ái', 'ǎi', 'ài',
                'ēi', 'éi', 'ěi', 'èi',
                'uī', 'uí', 'uǐ', 'uì',
                'āo', 'áo', 'ǎo', 'ào',
                'ōu', 'óu', 'ǒu', 'òu',
                'iū', 'iú', 'iǔ', 'iù',
                'iē', 'ié', 'iě', 'iè',
                'üē', 'üé', 'üě', 'üè',
                'ēr', 'ér', 'ěr', 'èr'
            ],
            
            // 鼻韵母（9个 × 4声调 = 36个）
            biyunmu: [
                'ān', 'án', 'ǎn', 'àn',
                'ēn', 'én', 'ěn', 'èn',
                'īn', 'ín', 'ǐn', 'ìn',
                'ūn', 'ún', 'ǔn', 'ùn',
                'ǖn', 'ǘn', 'ǚn', 'ǜn',
                'āng', 'áng', 'ǎng', 'àng',
                'ēng', 'éng', 'ěng', 'èng',
                'īng', 'íng', 'ǐng', 'ìng',
                'ōng', 'óng', 'ǒng', 'òng'
            ],
            
            // 所有韵母（向后兼容）
            yunmuWithTones: [],
            
            zhengtiWithTones: [
                'zhī', 'zhí', 'zhǐ', 'zhì', 'chī', 'chí', 'chǐ', 'chì', 'shī', 'shí', 'shǐ', 'shì', 'rī', 'rí', 'rǐ', 'rì',
                'zī', 'zí', 'zǐ', 'zì', 'cī', 'cí', 'cǐ', 'cì', 'sī', 'sí', 'sǐ', 'sì', 'yī', 'yí', 'yǐ', 'yì',
                'wū', 'wú', 'wǔ', 'wù', 'yū', 'yú', 'yǔ', 'yù', 'yē', 'yé', 'yě', 'yè', 'yuē', 'yué', 'yuě', 'yuè',
                'yuān', 'yuán', 'yuǎn', 'yuàn', 'yīn', 'yín', 'yǐn', 'yìn', 'yūn', 'yún', 'yǔn', 'yùn', 'yīng', 'yíng', 'yǐng', 'yìng'
            ],
            
            // 千字文四字句库（250句，每句4个汉字+4个拼音）
            qianziwen: [
                { hanzi: '天地玄黄', pinyin: ['Tiān', 'dì', 'xuán', 'huáng'] },
                { hanzi: '宇宙洪荒', pinyin: ['Yǔ', 'zhòu', 'hóng', 'huāng'] },
                { hanzi: '日月盈昃', pinyin: ['Rì', 'yuè', 'yíng', 'xǔ'] },
                { hanzi: '辰宿列张', pinyin: ['Chén', 'xiù', 'liè', 'zhāng'] },
                { hanzi: '寒来暑往', pinyin: ['Hán', 'lái', 'shǔ', 'wǎng'] },
                { hanzi: '秋收冬藏', pinyin: ['Qiū', 'shōu', 'dōng', 'cáng'] },
                { hanzi: '闰余成岁', pinyin: ['Rùn', 'yú', 'chéng', 'suì'] },
                { hanzi: '律吕调阳', pinyin: ['Lǜ', 'lǚ', 'tiáo', 'yáng'] },
                { hanzi: '云腾致雨', pinyin: ['Yún', 'téng', 'zhì', 'yǔ'] },
                { hanzi: '露结为霜', pinyin: ['Lù', 'jié', 'wéi', 'shuāng'] },
                { hanzi: '金生丽水', pinyin: ['Jīn', 'shēng', 'lí', 'shuǐ'] },
                { hanzi: '玉出昆冈', pinyin: ['Yù', 'chū', 'kūn', 'gāng'] },
                { hanzi: '剑号巨阙', pinyin: ['Jiàn', 'hào', 'jù', 'quē'] },
                { hanzi: '珠称夜光', pinyin: ['Zhū', 'chēng', 'yè', 'guāng'] },
                { hanzi: '果珍李柰', pinyin: ['Guǒ', 'zhēn', 'lǐ', 'nài'] },
                { hanzi: '菜重芥姜', pinyin: ['Cài', 'zhòng', 'jiè', 'jiāng'] },
                { hanzi: '海咸河淡', pinyin: ['Hǎi', 'xián', 'hé', 'dàn'] },
                { hanzi: '鳞潜羽翔', pinyin: ['Lín', 'qián', 'yǔ', 'xiáng'] },
                { hanzi: '龙师火帝', pinyin: ['Lóng', 'shī', 'huǒ', 'dì'] },
                { hanzi: '鸟官人皇', pinyin: ['Niǎo', 'guān', 'rén', 'huáng'] },
                { hanzi: '始制文字', pinyin: ['Shǐ', 'zhì', 'wén', 'zì'] },
                { hanzi: '乃服衣裳', pinyin: ['Nǎi', 'fú', 'yī', 'shāng'] },
                { hanzi: '推位让国', pinyin: ['Tuī', 'wèi', 'ràng', 'guó'] },
                { hanzi: '有虞陶唐', pinyin: ['Yǒu', 'yú', 'táo', 'táng'] },
                { hanzi: '吊民伐罪', pinyin: ['Diào', 'mín', 'fá', 'zuì'] },
                { hanzi: '周发殷汤', pinyin: ['Zhōu', 'fā', 'yīn', 'tāng'] },
                { hanzi: '坐朝问道', pinyin: ['Zuò', 'cháo', 'wèn', 'dào'] },
                { hanzi: '垂拱平章', pinyin: ['Chuí', 'gǒng', 'píng', 'zhāng'] },
                { hanzi: '爱育黎首', pinyin: ['Ài', 'yù', 'lí', 'shǒu'] },
                { hanzi: '臣伏戎羌', pinyin: ['Chén', 'fú', 'róng', 'qiāng'] },
                { hanzi: '遐迩一体', pinyin: ['Xiá', 'ěr', 'yī', 'tǐ'] },
                { hanzi: '率宾归王', pinyin: ['Shuài', 'bīn', 'guī', 'wáng'] },
                { hanzi: '鸣凤在竹', pinyin: ['Míng', 'fèng', 'zài', 'zhú'] },
                { hanzi: '白驹食场', pinyin: ['Bái', 'jū', 'shí', 'chǎng'] },
                { hanzi: '化被草木', pinyin: ['Huà', 'bèi', 'cǎo', 'mù'] },
                { hanzi: '赖及万方', pinyin: ['Lài', 'jí', 'wàn', 'fāng'] },
                { hanzi: '盖此身发', pinyin: ['Gài', 'cǐ', 'shēn', 'fà'] },
                { hanzi: '四大五常', pinyin: ['Sì', 'fù', 'wǔ', 'cháng'] },
                { hanzi: '恭惟鞠养', pinyin: ['Gōng', 'wéi', 'jū', 'yǎng'] },
                { hanzi: '岂敢毁伤', pinyin: ['Qǐ', 'gǎn', 'huǐ', 'shāng'] },
                { hanzi: '女慕贞洁', pinyin: ['Nǚ', 'mù', 'zhēn', 'jié'] },
                { hanzi: '男效才良', pinyin: ['Nán', 'xiào', 'cái', 'liáng'] },
                { hanzi: '知过必改', pinyin: ['Zhī', 'guò', 'bì', 'gǎi'] },
                { hanzi: '得能莫忘', pinyin: ['Dé', 'néng', 'mò', 'wàng'] },
                { hanzi: '罔谈彼短', pinyin: ['Wǎng', 'tán', 'bǐ', 'duǎn'] },
                { hanzi: '靡恃己长', pinyin: ['Mǐ', 'shì', 'jǐ', 'cháng'] },
                { hanzi: '信使可覆', pinyin: ['Xìn', 'shǐ', 'kě', 'fù'] },
                { hanzi: '器欲难量', pinyin: ['Qì', 'yù', 'nán', 'liáng'] },
                { hanzi: '墨悲丝染', pinyin: ['Mò', 'bēi', 'sī', 'rǎn'] },
                { hanzi: '诗赞羔羊', pinyin: ['Shī', 'zàn', 'gāo', 'yáng'] },
                { hanzi: '景行维贤', pinyin: ['Jǐng', 'xíng', 'wéi', 'xián'] },
                { hanzi: '克念作圣', pinyin: ['Kè', 'niàn', 'zuò', 'shèng'] },
                { hanzi: '德建名立', pinyin: ['Dé', 'jiàn', 'míng', 'lì'] },
                { hanzi: '形端表正', pinyin: ['Xíng', 'duān', 'biǎo', 'zhèng'] },
                { hanzi: '空谷传声', pinyin: ['Kōng', 'gǔ', 'chuán', 'shēng'] },
                { hanzi: '虚堂习听', pinyin: ['Xū', 'táng', 'xí', 'tīng'] },
                { hanzi: '祸因恶积', pinyin: ['Huò', 'yīn', 'è', 'jī'] },
                { hanzi: '福缘善庆', pinyin: ['Fú', 'yuán', 'shàn', 'qìng'] },
                { hanzi: '尺璧非宝', pinyin: ['Chǐ', 'bì', 'fēi', 'bǎo'] },
                { hanzi: '寸阴是竞', pinyin: ['Cùn', 'yīn', 'shì', 'jìng'] },
                { hanzi: '资父事君', pinyin: ['Zī', 'fù', 'shì', 'jūn'] },
                { hanzi: '曰严与敬', pinyin: ['Yuē', 'yán', 'yǔ', 'jìng'] },
                { hanzi: '孝当竭力', pinyin: ['Xiào', 'dāng', 'jié', 'lì'] },
                { hanzi: '忠则尽命', pinyin: ['Zhōng', 'zé', 'jìn', 'mìng'] },
                { hanzi: '临深履薄', pinyin: ['Lín', 'shēn', 'lǚ', 'bó'] },
                { hanzi: '夙兴温凊', pinyin: ['Sù', 'xīng', 'wēn', 'qìng'] },
                { hanzi: '似兰斯馨', pinyin: ['Sì', 'lán', 'sī', 'xīn'] },
                { hanzi: '如松之盛', pinyin: ['Rú', 'sǎng', 'zhī', 'xīng'] },
                { hanzi: '川流不息', pinyin: ['Chuān', 'liú', 'bù', 'xī'] },
                { hanzi: '渊澄取映', pinyin: ['Yuān', 'chéng', 'qǔ', 'yìng'] },
                { hanzi: '容止若思', pinyin: ['Róng', 'zhǐ', 'ruò', 'sī'] },
                { hanzi: '言辞安定', pinyin: ['Yán', 'cí', 'ān', 'dìng'] },
                { hanzi: '笃初诚美', pinyin: ['Dǔ', 'chū', 'chéng', 'měi'] },
                { hanzi: '慎终宜令', pinyin: ['Shèn', 'zhōng', 'yí', 'lìng'] },
                { hanzi: '荣业所基', pinyin: ['Róng', 'yè', 'suǒ', 'jī'] },
                { hanzi: '籍甚无竟', pinyin: ['Jí', 'shèn', 'wú', 'jìng'] },
                { hanzi: '学优登仕', pinyin: ['Xué', 'yōu', 'dēng', 'shì'] },
                { hanzi: '摄职从政', pinyin: ['Shè', 'zhí', 'cóng', 'zhèng'] },
                { hanzi: '存以甘棠', pinyin: ['Cún', 'yǐ', 'gān', 'táng'] },
                { hanzi: '去而益咏', pinyin: ['Qù', 'ér', 'yì', 'yǒng'] },
                { hanzi: '乐殊贵贱', pinyin: ['Lè', 'shū', 'guì', 'jiàn'] },
                { hanzi: '礼别尊卑', pinyin: ['Lǐ', 'bié', 'zūn', 'bēi'] },
                { hanzi: '上和下睦', pinyin: ['Shàng', 'hé', 'xià', 'mù'] },
                { hanzi: '夫唱妇随', pinyin: ['Fū', 'chàng', 'fù', 'suí'] },
                { hanzi: '外受傅训', pinyin: ['Wài', 'shòu', 'fù', 'xùn'] },
                { hanzi: '入奉母仪', pinyin: ['Rù', 'fèng', 'mǔ', 'yí'] },
                { hanzi: '诸姑伯叔', pinyin: ['Zhū', 'gū', 'bó', 'shū'] },
                { hanzi: '犹子比儿', pinyin: ['Yóu', 'zǐ', 'bǐ', 'ér'] },
                { hanzi: '孔怀兄弟', pinyin: ['Kǒng', 'huái', 'xiōng', 'dì'] },
                { hanzi: '同气连枝', pinyin: ['Tóng', 'qì', 'lián', 'zhī'] },
                { hanzi: '交友投分', pinyin: ['Jiāo', 'yǒu', 'tóu', 'fèn'] },
                { hanzi: '切磨箴规', pinyin: ['Qiē', 'mó', 'zhēn', 'guī'] },
                { hanzi: '仁慈隐恻', pinyin: ['Rén', 'cí', 'yǐn', 'cè'] },
                { hanzi: '造次弗离', pinyin: ['Zào', 'cì', 'fú', 'lí'] },
                { hanzi: '节义廉退', pinyin: ['Jié', 'yì', 'lián', 'tuì'] },
                { hanzi: '颠沛匪亏', pinyin: ['Diān', 'pèi', 'fěi', 'kuī'] },
                { hanzi: '性静情逸', pinyin: ['Xìng', 'jìng', 'qíng', 'yì'] },
                { hanzi: '心动神疲', pinyin: ['Xīn', 'dòng', 'shén', 'pí'] },
                { hanzi: '守真志满', pinyin: ['Shǒu', 'zhēn', 'zhì', 'mǎn'] },
                { hanzi: '逐物意移', pinyin: ['Zhú', 'wù', 'yì', 'yí'] },
                { hanzi: '坚持雅操', pinyin: ['Jiān', 'chí', 'yǎ', 'cāo'] },
                { hanzi: '好爵自縻', pinyin: ['Hǎo', 'jué', 'zì', 'mí'] },
                { hanzi: '都邑华夏', pinyin: ['Dū', 'yì', 'huá', 'xià'] },
                { hanzi: '东西二京', pinyin: ['Dōng', 'xī', 'èr', 'jīng'] },
                { hanzi: '背邙面洛', pinyin: ['Bèi', 'máng', 'miàn', 'luò'] },
                { hanzi: '浮渭据泾', pinyin: ['Fú', 'wèi', 'jù', 'jīng'] },
                { hanzi: '宫殿盘郁', pinyin: ['Gōng', 'diàn', 'pán', 'yù'] },
                { hanzi: '楼观飞惊', pinyin: ['Lóu', 'guān', 'fēi', 'jīng'] },
                { hanzi: '图写禽兽', pinyin: ['Tú', 'xiě', 'qín', 'shòu'] },
                { hanzi: '画彩仙灵', pinyin: ['Huà', 'cǎi', 'xiān', 'líng'] },
                { hanzi: '丙舍旁启', pinyin: ['Bǐng', 'shè', 'páng', 'qǐ'] },
                { hanzi: '甲帐对楹', pinyin: ['Jiǎ', 'zhàng', 'duì', 'yíng'] },
                { hanzi: '肆筵设席', pinyin: ['Sì', 'yán', 'shè', 'xí'] },
                { hanzi: '鼓瑟吹笙', pinyin: ['Gǔ', 'sè', 'chuī', 'shēng'] },
                { hanzi: '升阶纳陛', pinyin: ['Shēng', 'jiē', 'nà', 'bì'] },
                { hanzi: '弁转疑星', pinyin: ['Biàn', 'zhuàn', 'yí', 'xīng'] },
                { hanzi: '右通广内', pinyin: ['Yòu', 'tōng', 'guǎng', 'nèi'] },
                { hanzi: '左达承明', pinyin: ['Zuǒ', 'dá', 'chéng', 'míng'] },
                { hanzi: '既集坟典', pinyin: ['Jì', 'jí', 'fén', 'diǎn'] },
                { hanzi: '亦聚群英', pinyin: ['Yì', 'jù', 'qún', 'yīng'] },
                { hanzi: '杜稿钟隶', pinyin: ['Dù', 'gǎo', 'zhōng', 'lì'] },
                { hanzi: '漆书壁经', pinyin: ['Qī', 'shū', 'bì', 'jīng'] },
                { hanzi: '府罗将相', pinyin: ['Fǔ', 'luó', 'xiàng', 'lù'] },
                { hanzi: '路侠槐卿', pinyin: ['Lù', 'xiá', 'huái', 'qīng'] },
                { hanzi: '户封八县', pinyin: ['Hù', 'fēng', 'bā', 'xiàn'] },
                { hanzi: '家给千兵', pinyin: ['Jiā', 'jǐ', 'qiān', 'bīng'] },
                { hanzi: '高冠陪辇', pinyin: ['Gāo', 'guān', 'péi', 'niǎn'] },
                { hanzi: '驱毂振缨', pinyin: ['Qū', 'gǔ', 'zhèn', 'yīng'] },
                { hanzi: '世禄侈富', pinyin: ['Shì', 'lù', 'chǐ', 'fù'] },
                { hanzi: '车驾肥轻', pinyin: ['Chē', 'jià', 'féi', 'qīng'] },
                { hanzi: '策功茂实', pinyin: ['Cè', 'gōng', 'mào', 'shí'] },
                { hanzi: '勒碑刻铭', pinyin: ['Lè', 'bēi', 'kè', 'míng'] },
                { hanzi: '盘溪伊尹', pinyin: ['Pán', 'xī', 'yī', 'yǐn'] },
                { hanzi: '佐时阿衡', pinyin: ['Zuǒ', 'shí', 'ā', 'héng'] },
                { hanzi: '奄宅曲阜', pinyin: ['Yǎn', 'zhái', 'qū', 'fǔ'] },
                { hanzi: '微旦孰营', pinyin: ['Wēi', 'dàn', 'shú', 'yíng'] },
                { hanzi: '桓公匡合', pinyin: ['Huán', 'gōng', 'kuāng', 'hé'] },
                { hanzi: '济弱扶倾', pinyin: ['Jì', 'ruò', 'fú', 'qīng'] },
                { hanzi: '绮回汉惠', pinyin: ['Qǐ', 'huí', 'hàn', 'huì'] },
                { hanzi: '说感武丁', pinyin: ['Yuè', 'gǎn', 'wǔ', 'dīng'] },
                { hanzi: '俊乂密勿', pinyin: ['Jùn', 'yì', 'mì', 'wù'] },
                { hanzi: '多士实宁', pinyin: ['Duō', 'shì', 'shí', 'níng'] },
                { hanzi: '晋楚更霸', pinyin: ['Jìn', 'chǔ', 'gēng', 'bà'] },
                { hanzi: '赵魏困横', pinyin: ['Zhào', 'wèi', 'kùn', 'héng'] },
                { hanzi: '假途灭虢', pinyin: ['Jiǎ', 'tú', 'miè', 'guó'] },
                { hanzi: '践土会盟', pinyin: ['Jiàn', 'tǔ', 'huì', 'méng'] },
                { hanzi: '何遵约法', pinyin: ['Hé', 'zūn', 'yuē', 'fǎ'] },
                { hanzi: '韩弊烦刑', pinyin: ['Hán', 'bì', 'fán', 'xíng'] },
                { hanzi: '起翦颇牧', pinyin: ['Qǐ', 'jiǎn', 'pō', 'mù'] },
                { hanzi: '用军最精', pinyin: ['Yòng', 'jūn', 'zuì', 'jīng'] },
                { hanzi: '宣威沙漠', pinyin: ['Xuān', 'wēi', 'shā', 'mò'] },
                { hanzi: '驰誉丹青', pinyin: ['Chí', 'yù', 'dān', 'qīng'] },
                { hanzi: '九州禹迹', pinyin: ['Jǐu', 'zhōu', 'yǔ', 'jì'] },
                { hanzi: '百郡秦并', pinyin: ['Bǎi', 'jùn', 'qín', 'bīng'] },
                { hanzi: '岳宗泰岱', pinyin: ['Yuè', 'zōng', 'tài', 'dài'] },
                { hanzi: '禅主云亭', pinyin: ['Shàn', 'zhǔ', 'yún', 'tíng'] },
                { hanzi: '雁门紫塞', pinyin: ['Yàn', 'mén', 'zǐ', 'sài'] },
                { hanzi: '鸡田赤城', pinyin: ['Jī', 'tián', 'chì', 'chéng'] },
                { hanzi: '昆池碣石', pinyin: ['Kūn', 'chí', 'jié', 'shí'] },
                { hanzi: '钜野洞庭', pinyin: ['Jù', 'yě', 'dòng', 'tíng'] },
                { hanzi: '旷远绵邈', pinyin: ['Kuàng', 'yuǎn', 'mián', 'miǎo'] },
                { hanzi: '岩岫杳冥', pinyin: ['Yán', 'xiù', 'yǎo', 'míng'] },
                { hanzi: '治本于农', pinyin: ['Zhì', 'běn', 'yú', 'nóng'] },
                { hanzi: '务兹稼穑', pinyin: ['Wù', 'zī', 'jià', 'sè'] },
                { hanzi: '俶载南亩', pinyin: ['Chù', 'zǎi', 'nán', 'mǔ'] },
                { hanzi: '我艺黍稷', pinyin: ['Wǒ', 'yì', 'shǔ', 'jì'] },
                { hanzi: '税熟贡新', pinyin: ['Shuì', 'shú', 'gòng', 'xīn'] },
                { hanzi: '劝赏黜陟', pinyin: ['Quàn', 'shǎng', 'chù', 'zhì'] },
                { hanzi: '孟轲敦素', pinyin: ['Mèng', 'kē', 'dūn', 'sù'] },
                { hanzi: '史鱼秉直', pinyin: ['Shǐ', 'yú', 'bǐng', 'zhí'] },
                { hanzi: '庶几中庸', pinyin: ['Shù', 'jī', 'zhōng', 'yōng'] },
                { hanzi: '劳谦谨敕', pinyin: ['Láo', 'qiān', 'jǐn', 'chì'] },
                { hanzi: '聆音察理', pinyin: ['Líng', 'yīn', 'chá', 'lǐ'] },
                { hanzi: '鉴貌辨色', pinyin: ['Jiàn', 'mào', 'biàn', 'sè'] },
                { hanzi: '贻厥嘉猷', pinyin: ['Yí', 'jué', 'jiā', 'yóu'] },
                { hanzi: '勉其祗植', pinyin: ['Miǎn', 'qí', 'zhī', 'zhí'] },
                { hanzi: '省躬讥诫', pinyin: ['Xǐng', 'gōng', 'jī', 'jiè'] },
                { hanzi: '宠增抗极', pinyin: ['Chǒng', 'zēng', 'kàng', 'jí'] },
                { hanzi: '殆辱近耻', pinyin: ['Dài', 'rǔ', 'jìn', 'chǐ'] },
                { hanzi: '林皋幸即', pinyin: ['Lín', 'gāo', 'xìng', 'jí'] },
                { hanzi: '两疏见机', pinyin: ['Liǎng', 'shū', 'jiàn', 'jī'] },
                { hanzi: '解组谁逼', pinyin: ['Jiě', 'zǔ', 'shuí', 'bī'] },
                { hanzi: '索居闲处', pinyin: ['Suǒ', 'jū', 'xián', 'chǔ'] },
                { hanzi: '沉默寂寥', pinyin: ['Chén', 'mò', 'jì', 'liáo'] },
                { hanzi: '求古寻论', pinyin: ['Qiú', 'gǔ', 'xún', 'lùn'] },
                { hanzi: '散虑逍遥', pinyin: ['Sàn', 'lǜ', 'xiāo', 'yáo'] },
                { hanzi: '欣奏累遣', pinyin: ['Xīn', 'zòu', 'lèi', 'qiǎn'] },
                { hanzi: '戚谢欢招', pinyin: ['Qī', 'xiè', 'huān', 'zhāo'] },
                { hanzi: '渠荷的历', pinyin: ['Qú', 'hé', 'dì', 'lì'] },
                { hanzi: '园莽抽条', pinyin: ['Yuán', 'mǎng', 'chōu', 'tiáo'] },
                { hanzi: '枇杷晚翠', pinyin: ['Pí', 'pá', 'wǎn', 'cuì'] },
                { hanzi: '梧桐早凋', pinyin: ['Wú', 'tóng', 'zǎo', 'diāo'] },
                { hanzi: '陈根委翳', pinyin: ['Chén', 'gēn', 'wěi', 'yì'] },
                { hanzi: '落叶飘摇', pinyin: ['Luò', 'yè', 'piāo', 'yáo'] },
                { hanzi: '游鹍独运', pinyin: ['Yóu', 'kūn', 'dú', 'yùn'] },
                { hanzi: '凌摩绛霄', pinyin: ['Líng', 'mó', 'jiàng', 'xiāo'] },
                { hanzi: '耽读玩市', pinyin: ['Dān', 'dú', 'wán', 'shì'] },
                { hanzi: '寓目囊箱', pinyin: ['Yù', 'mù', 'náng', 'xiāng'] },
                { hanzi: '易輶攸畏', pinyin: ['Yì', 'yóu', 'yōu', 'wèi'] },
                { hanzi: '属耳垣墙', pinyin: ['Zhǔ', 'ěr', 'yuán', 'qiáng'] },
                { hanzi: '具膳餐饭', pinyin: ['Jù', 'shàn', 'cān', 'fàn'] },
                { hanzi: '适口充肠', pinyin: ['Shì', 'kǒu', 'chōng', 'cháng'] },
                { hanzi: '饱饫烹宰', pinyin: ['Bǎo', 'yù', 'pēng', 'zǎi'] },
                { hanzi: '饥厌糟糠', pinyin: ['Jī', 'yàn', 'zāo', 'kāng'] },
                { hanzi: '亲戚故旧', pinyin: ['Qīn', 'qī', 'gù', 'jiù'] },
                { hanzi: '老少异粮', pinyin: ['Lǎo', 'shào', 'yì', 'liáng'] },
                { hanzi: '妾御绩纺', pinyin: ['Qiè', 'yù', 'jì', 'fǎng'] },
                { hanzi: '侍巾帷房', pinyin: ['Shì', 'jīn', 'wéi', 'fáng'] },
                { hanzi: '纨扇圆洁', pinyin: ['Wán', 'shàn', 'yuán', 'jié'] },
                { hanzi: '银烛炜煌', pinyin: ['Yín', 'zhú', 'wěi', 'huáng'] },
                { hanzi: '昼眠夕寐', pinyin: ['Zhòu', 'mián', 'xī', 'mèi'] },
                { hanzi: '蓝笋象床', pinyin: ['Lán', 'sǔn', 'xiàng', 'chuáng'] },
                { hanzi: '弦歌酒宴', pinyin: ['Xián', 'gē', 'jiǔ', 'yàn'] },
                { hanzi: '接杯举觞', pinyin: ['Jiē', 'bēi', 'jǔ', 'shāng'] },
                { hanzi: '矫手顿足', pinyin: ['Jiǎo', 'shǒu', 'dùn', 'zú'] },
                { hanzi: '悦豫且康', pinyin: ['Yuè', 'yù', 'qiě', 'kāng'] },
                { hanzi: '嫡后嗣续', pinyin: ['Dí', 'hòu', 'sì', 'xù'] },
                { hanzi: '祭祀烝尝', pinyin: ['Jì', 'sì', 'zhēng', 'cháng'] },
                { hanzi: '稽颡再拜', pinyin: ['Qǐ', 'sǎng', 'zài', 'bài'] },
                { hanzi: '悚惧恐惶', pinyin: ['Sǒng', 'jù', 'kǒng', 'huáng'] },
                { hanzi: '笺牒简要', pinyin: ['Jiān', 'dié', 'jiǎn', 'yào'] },
                { hanzi: '顾答审详', pinyin: ['Gù', 'dá', 'shěn', 'xiáng'] },
                { hanzi: '骸垢想浴', pinyin: ['Hái', 'gòu', 'xiǎng', 'yù'] },
                { hanzi: '执热愿凉', pinyin: ['Zhí', 'rè', 'yuàn', 'liáng'] },
                { hanzi: '驴骡犊特', pinyin: ['Lǘ', 'luó', 'dú', 'tè'] },
                { hanzi: '骇跃超骧', pinyin: ['Hài', 'yuè', 'chāo', 'xiāng'] },
                { hanzi: '诛斩贼盗', pinyin: ['Zhū', 'zhǎn', 'zéi', 'dào'] },
                { hanzi: '捕获叛亡', pinyin: ['Bǔ', 'huò', 'pàn', 'wáng'] },
                { hanzi: '布射辽丸', pinyin: ['Bù', 'shè', 'liáo', 'wán'] },
                { hanzi: '嵇琴阮啸', pinyin: ['Jī', 'qín', 'ruǎn', 'xiào'] },
                { hanzi: '恬笔伦纸', pinyin: ['Tián', 'bǐ', 'lún', 'zhǐ'] },
                { hanzi: '钧巧任钓', pinyin: ['Jūn', 'qiǎo', 'rèn', 'diào'] },
                { hanzi: '释纷利俗', pinyin: ['Shì', 'fēn', 'lì', 'sú'] },
                { hanzi: '并皆佳妙', pinyin: ['Bìng', 'jiē', 'jiā', 'miào'] },
                { hanzi: '毛施淑姿', pinyin: ['Máo', 'shī', 'shū', 'zī'] },
                { hanzi: '工颦妍笑', pinyin: ['Gōng', 'pín', 'yán', 'xiào'] },
                { hanzi: '年矢每催', pinyin: ['Nián', 'shǐ', 'měi', 'cuī'] },
                { hanzi: '曦晖朗曜', pinyin: ['Xī', 'huī', 'lǎng', 'yào'] },
                { hanzi: '璇玑悬斡', pinyin: ['Xuán', 'jī', 'xuán', 'wò'] },
                { hanzi: '晦魄环照', pinyin: ['Huì', 'pò', 'huán', 'zhào'] },
                { hanzi: '指薪修祜', pinyin: ['Zhǐ', 'xīn', 'xiū', 'hù'] },
                { hanzi: '永绥吉劭', pinyin: ['Yǒng', 'suí', 'jí', 'shào'] },
                { hanzi: '矩步引领', pinyin: ['Jǔ', 'bù', 'yǐn', 'lǐng'] },
                { hanzi: '俯仰廊庙', pinyin: ['Fǔ', 'yǎng', 'láng', 'miào'] },
                { hanzi: '束带矜庄', pinyin: ['Shù', 'dài', 'jīn', 'zhuāng'] },
                { hanzi: '徘徊瞻眺', pinyin: ['Pái', 'huái', 'zhān', 'tiào'] },
                { hanzi: '孤陋寡闻', pinyin: ['Gū', 'lòu', 'guǎ', 'wén'] },
                { hanzi: '愚蒙等诮', pinyin: ['Yú', 'méng', 'děng', 'qiào'] },
                { hanzi: '谓语助者', pinyin: ['Wèi', 'yǔ', 'zhù', 'zhě'] },
                { hanzi: '焉哉乎也', pinyin: ['Yān', 'zāi', 'hū', 'yě'] }
            ]
        };
        
        // 合并所有韵母（向后兼容）
        pinyinDatabase.yunmuWithTones = [
            ...pinyinDatabase.danyunmu,
            ...pinyinDatabase.shuangyunmu,
            ...pinyinDatabase.biyunmu
        ];
        
        let currentTraining = null;
        let inputResults = {};
        const itemsPerPage = 28; // 7行×4列
        
        // 切换屏幕
        function switchScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            const screenMap = {
                'training': 'trainingScreen',
                'input': 'inputScreen',
                'ocr': 'ocrScreen',
                'history': 'historyScreen',
                'library': 'libraryScreen',
                'dashboard': 'dashboardScreen',
                'settings': 'settingsScreen'
            };
            
            document.getElementById(screenMap[screen]).classList.add('active');
            event.target.classList.add('active');
            
            if (screen === 'history') {
                loadHistory();
            } else if (screen === 'library') {
                loadLibrary();
            } else if (screen === 'settings') {
                loadGitHubConfig();
            } else if (screen === 'dashboard') {
                refreshDashboard();
                startDashboardAutoRefresh();
            } else {
                stopDashboardAutoRefresh();
            }
        }
        
        // 图片和音频存储对象（使用localStorage，按用户隔离）
        let pinyinImages = {};
        let pinyinAudios = {};
        let currentEditingPinyin = null;
        let currentImageData = null;
        let currentAudioData = null;
        
        // 初始化用户数据
        function initUserImages() {
            const userImagesKey = getUserDataKey('pinyinImages');
            const userAudiosKey = getUserDataKey('pinyinAudios');
            pinyinImages = JSON.parse(localStorage.getItem(userImagesKey) || '{}');
            pinyinAudios = JSON.parse(localStorage.getItem(userAudiosKey) || '{}');
        }
        
        // 加载拼音库
        function loadLibrary() {
            // 初始化用户的图片和音频数据
            initUserImages();
            
            // 显示声母
            const shengmuContainer = document.getElementById('shengmuShowcase');
            shengmuContainer.innerHTML = '';
            pinyinDatabase.shengmu.forEach(item => {
                const div = createPinyinItem(item, 'shengmu');
                shengmuContainer.appendChild(div);
            });
            
            // 显示复韵母
            const shuangyunmuContainer = document.getElementById('shuangyunmuShowcase');
            shuangyunmuContainer.innerHTML = '';
            pinyinDatabase.shuangyunmu.forEach(item => {
                const div = createPinyinItem(item, 'shuangyunmu');
                shuangyunmuContainer.appendChild(div);
            });
            
            // 显示前鼻韵母
            const qianbiContainer = document.getElementById('qianbiyunmuShowcase');
            qianbiContainer.innerHTML = '';
            const qianbiYunmu = [
                'ān', 'án', 'ǎn', 'àn',
                'ēn', 'én', 'ěn', 'èn',
                'īn', 'ín', 'ǐn', 'ìn',
                'ūn', 'ún', 'ǔn', 'ùn',
                'ǖn', 'ǘn', 'ǚn', 'ǜn'
            ];
            qianbiYunmu.forEach(item => {
                const div = createPinyinItem(item, 'biyunmu');
                qianbiContainer.appendChild(div);
            });
            
            // 显示后鼻韵母
            const houbiContainer = document.getElementById('houbiyunmuShowcase');
            houbiContainer.innerHTML = '';
            const houbiYunmu = [
                'āng', 'áng', 'ǎng', 'àng',
                'ēng', 'éng', 'ěng', 'èng',
                'īng', 'íng', 'ǐng', 'ìng',
                'ōng', 'óng', 'ǒng', 'òng'
            ];
            houbiYunmu.forEach(item => {
                const div = createPinyinItem(item, 'biyunmu');
                houbiContainer.appendChild(div);
            });
            
            // 显示整体认读音节
            const zhengtiContainer = document.getElementById('zhengtiShowcase');
            zhengtiContainer.innerHTML = '';
            pinyinDatabase.zhengtiWithTones.forEach(item => {
                const div = createPinyinItem(item, 'zhengti');
                zhengtiContainer.appendChild(div);
            });
            
            // 显示千字文音节库 - 每个四字句显示为一个条目
            const qianziwenContainer = document.getElementById('qianziwenShowcase');
            qianziwenContainer.innerHTML = '';
            pinyinDatabase.qianziwen.forEach(sentence => {
                const div = document.createElement('div');
                div.className = 'showcase-item qianziwen';
                div.style.cssText = 'padding: 15px; min-height: 100px; display: flex; flex-direction: column; justify-content: center; grid-column: span 2;';
                div.innerHTML = `
                    <div style="font-size: 24px; font-weight: bold; margin-bottom: 8px; text-align: center;">${sentence.hanzi}</div>
                    <div style="font-size: 16px; text-align: center; opacity: 0.95;">${sentence.pinyin.join(' ')}</div>
                `;
                qianziwenContainer.appendChild(div);
            });
        }
        
        // 创建拼音项（带图片和音频上传功能）
        function createPinyinItem(pinyin, type) {
            const div = document.createElement('div');
            div.className = `showcase-item ${type}`;
            div.onclick = () => openImageModal(pinyin);
            
            // 如果有音频，添加has-audio类
            if (pinyinAudios[pinyin]) {
                div.classList.add('has-audio');
            }
            
            // 如果有图片，显示图片
            if (pinyinImages[pinyin]) {
                const img = document.createElement('img');
                img.src = pinyinImages[pinyin];
                img.className = 'pinyin-image';
                img.alt = pinyin;
                div.appendChild(img);
            }
            
            // 显示拼音文字
            const text = document.createElement('span');
            text.className = 'pinyin-text';
            text.textContent = pinyin;
            div.appendChild(text);
            
            // 添加上传图标
            const uploadIcon = document.createElement('div');
            uploadIcon.className = 'upload-icon';
            uploadIcon.innerHTML = '📷';
            div.appendChild(uploadIcon);
            
            // 如果有音频，添加播放按钮
            if (pinyinAudios[pinyin]) {
                const audioIcon = document.createElement('div');
                audioIcon.className = 'audio-icon';
                audioIcon.innerHTML = '🔊';
                audioIcon.onclick = (e) => {
                    e.stopPropagation(); // 阻止触发打开模态框
                    playPinyinAudio(pinyin, audioIcon);
                };
                div.appendChild(audioIcon);
            }
            
            return div;
        }
        
        // 打开图片和音频上传模态框
        function openImageModal(pinyin) {
            currentEditingPinyin = pinyin;
            currentImageData = null;
            currentAudioData = null;
            
            document.getElementById('modalPinyin').textContent = pinyin;
            document.getElementById('imageModal').classList.add('show');
            
            const preview = document.getElementById('modalPreview');
            const deleteImageBtn = document.getElementById('deleteImageBtn');
            const deleteAudioBtn = document.getElementById('deleteAudioBtn');
            const audioPlayer = document.getElementById('modalAudioPlayer');
            const audioStatus = document.getElementById('audioStatus');
            
            // 如果已有图片，显示预览和删除按钮
            if (pinyinImages[pinyin]) {
                preview.src = pinyinImages[pinyin];
                preview.classList.add('show');
                deleteImageBtn.style.display = 'inline-block';
            } else {
                preview.classList.remove('show');
                deleteImageBtn.style.display = 'none';
            }
            
            // 如果已有音频，显示播放器和删除按钮
            if (pinyinAudios[pinyin]) {
                audioPlayer.src = pinyinAudios[pinyin];
                audioPlayer.classList.add('show');
                deleteAudioBtn.style.display = 'inline-block';
                audioStatus.textContent = '✓ 已有音频';
            } else {
                audioPlayer.classList.remove('show');
                audioPlayer.src = '';
                deleteAudioBtn.style.display = 'none';
                audioStatus.textContent = '';
            }
        }
        
        // 关闭模态框
        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('show');
            document.getElementById('modalFileInput').value = '';
            document.getElementById('modalAudioInput').value = '';
            document.getElementById('modalPreview').classList.remove('show');
            document.getElementById('modalAudioPlayer').classList.remove('show');
            document.getElementById('modalAudioPlayer').pause();
            currentEditingPinyin = null;
            currentImageData = null;
            currentAudioData = null;
        }
        
        // 处理图片选择
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // 检查文件类型
            if (!file.type.startsWith('image/')) {
                alert('请选择图片文件！');
                return;
            }
            
            // 检查文件大小（限制5MB）
            if (file.size > 5 * 1024 * 1024) {
                alert('图片文件不能超过5MB！');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                currentImageData = e.target.result;
                const preview = document.getElementById('modalPreview');
                preview.src = currentImageData;
                preview.classList.add('show');
                document.getElementById('saveImageBtn').style.display = 'inline-block';
            };
            reader.readAsDataURL(file);
        }
        
        // 处理音频选择
        function handleAudioSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // 检查文件类型
            if (!file.type.startsWith('audio/')) {
                alert('请选择音频文件！');
                return;
            }
            
            // 检查文件大小（限制10MB）
            if (file.size > 10 * 1024 * 1024) {
                alert('音频文件不能超过10MB！');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                currentAudioData = e.target.result;
                const audioPlayer = document.getElementById('modalAudioPlayer');
                const audioStatus = document.getElementById('audioStatus');
                audioPlayer.src = currentAudioData;
                audioPlayer.classList.add('show');
                audioStatus.textContent = '✓ 音频已选择';
                audioStatus.style.color = '#27ae60';
            };
            reader.readAsDataURL(file);
        }
        
        // 保存拼音图片和音频
        function savePinyinData() {
            if (!currentEditingPinyin) {
                alert('错误：未选择拼音项！');
                return;
            }
            
            let saved = false;
            
            // 保存图片（如果有新选择）
            if (currentImageData) {
                pinyinImages[currentEditingPinyin] = currentImageData;
                const userImagesKey = getUserDataKey('pinyinImages');
                localStorage.setItem(userImagesKey, JSON.stringify(pinyinImages));
                saved = true;
            }
            
            // 保存音频（如果有新选择）
            if (currentAudioData) {
                pinyinAudios[currentEditingPinyin] = currentAudioData;
                const userAudiosKey = getUserDataKey('pinyinAudios');
                localStorage.setItem(userAudiosKey, JSON.stringify(pinyinAudios));
                saved = true;
            }
            
            if (saved) {
                // 刷新拼音库显示
                loadLibrary();
                closeImageModal();
                alert('✅ 保存成功！');
            } else {
                alert('没有需要保存的内容。请先选择图片或音频。');
            }
        }
        
        // 保存拼音图片（保留向后兼容）
        function savePinyinImage() {
            savePinyinData();
        }
        
        // 删除拼音图片
        function deletePinyinImage() {
            if (!currentEditingPinyin) return;
            
            if (confirm(`确定要删除"${currentEditingPinyin}"的图片吗？`)) {
                delete pinyinImages[currentEditingPinyin];
                const userImagesKey = getUserDataKey('pinyinImages');
                localStorage.setItem(userImagesKey, JSON.stringify(pinyinImages));
                
                // 刷新拼音库显示
                loadLibrary();
                closeImageModal();
                alert('✅ 图片已删除！');
            }
        }
        
        // 删除拼音音频
        function deletePinyinAudio() {
            if (!currentEditingPinyin) return;
            
            if (confirm(`确定要删除"${currentEditingPinyin}"的音频吗？`)) {
                delete pinyinAudios[currentEditingPinyin];
                const userAudiosKey = getUserDataKey('pinyinAudios');
                localStorage.setItem(userAudiosKey, JSON.stringify(pinyinAudios));
                
                // 刷新拼音库显示
                loadLibrary();
                closeImageModal();
                alert('✅ 音频已删除！');
            }
        }
        
        // 播放拼音音频
        let currentPlayingAudio = null;
        let currentPlayingIcon = null;
        
        function playPinyinAudio(pinyin, iconElement) {
            const audioData = pinyinAudios[pinyin];
            if (!audioData) {
                alert('该拼音还没有音频，请先上传！');
                return;
            }
            
            // 如果已经有音频在播放，先停止
            if (currentPlayingAudio) {
                currentPlayingAudio.pause();
                currentPlayingAudio.currentTime = 0;
                if (currentPlayingIcon) {
                    currentPlayingIcon.classList.remove('playing');
                }
            }
            
            // 创建并播放新音频
            const audio = new Audio(audioData);
            currentPlayingAudio = audio;
            currentPlayingIcon = iconElement;
            
            iconElement.classList.add('playing');
            
            audio.onended = () => {
                iconElement.classList.remove('playing');
                currentPlayingAudio = null;
                currentPlayingIcon = null;
            };
            
            audio.onerror = () => {
                alert('音频播放失败！');
                iconElement.classList.remove('playing');
                currentPlayingAudio = null;
                currentPlayingIcon = null;
            };
            
            audio.play().catch(error => {
                console.error('播放错误:', error);
                alert('音频播放失败：' + error.message);
                iconElement.classList.remove('playing');
            });
        }
        
        // 拖拽上传功能
        const modalUploadArea = document.getElementById('modalUploadArea');
        if (modalUploadArea) {
            modalUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                modalUploadArea.classList.add('dragover');
            });
            
            modalUploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                modalUploadArea.classList.remove('dragover');
            });
            
            modalUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                modalUploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type.startsWith('image/')) {
                        // 模拟文件输入
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        document.getElementById('modalFileInput').files = dataTransfer.files;
                        handleImageSelect({ target: { files: [file] } });
                    } else {
                        alert('请拖拽图片文件！');
                    }
                }
            });
        }
        
        // 点击模态框背景关闭
        document.getElementById('imageModal').addEventListener('click', (e) => {
            if (e.target.id === 'imageModal') {
                closeImageModal();
            }
        });
        
        // 开始训练
        function startTraining(mode) {
            let items = [];
            let typeName = '';
            
            switch(mode) {
                case 'shengmu':
                    items = [...pinyinDatabase.shengmu];
                    typeName = '声母训练';
                    break;
                case 'danyunmu':
                    items = [...pinyinDatabase.danyunmu];
                    typeName = '单韵母训练（带声调）';
                    break;
                case 'shuangyunmu':
                    items = [...pinyinDatabase.shuangyunmu];
                    typeName = '复韵母训练（带声调）';
                    break;
                case 'biyunmu':
                    items = [...pinyinDatabase.biyunmu];
                    typeName = '鼻韵母训练（带声调）';
                    break;
                case 'yunmu':
                    items = [...pinyinDatabase.yunmuWithTones];
                    typeName = '韵母训练（带声调）';
                    break;
                case 'zhengti':
                    items = [...pinyinDatabase.zhengtiWithTones];
                    typeName = '整体认读音节训练';
                    break;
                case 'qianziwen':
                    // 千字文是四字句对象，随机选取7句（7句×4字=28个训练项）
                    items = shuffleArray([...pinyinDatabase.qianziwen]).slice(0, 7);
                    typeName = '千字文训练';
                    break;
                case 'random':
                    items = [...pinyinDatabase.shengmu, ...pinyinDatabase.yunmuWithTones, ...pinyinDatabase.zhengtiWithTones];
                    typeName = '随机混合训练';
                    break;
            }
            
            // 千字文已在case中处理，其他类型需要打乱并截取
            if (mode !== 'qianziwen') {
                items = shuffleArray(items).slice(0, itemsPerPage);
            }
            
            currentTraining = {
                id: 'T' + Date.now(),
                mode: mode,
                typeName: typeName,
                items: items,
                date: new Date().toISOString()
            };
            
            generateTrainingSheet();
            document.getElementById('selectionView').style.display = 'none';
            document.getElementById('trainingView').style.display = 'block';
        }
        
        // 生成训练表单
        function generateTrainingSheet() {
            document.getElementById('trainingId').textContent = '训练编号：' + currentTraining.id;
            document.getElementById('trainingType').textContent = currentTraining.typeName;
            const grid = document.getElementById('trainingGrid');
            grid.innerHTML = '';
            
            // 千字文需要特殊处理：每个item是一个四字句对象
            if (currentTraining.mode === 'qianziwen') {
                currentTraining.items.forEach(sentence => {
                    // 每个汉字占一个格子
                    for (let i = 0; i < 4; i++) {
                        const div = document.createElement('div');
                        div.className = 'training-item';
                        div.innerHTML = `
                            <div class="pinyin" style="display: flex; flex-direction: column; gap: 5px;">
                                <span style="font-size: 28px; color: #e74c3c;">${sentence.hanzi[i]}</span>
                                <span style="font-size: 20px;">${sentence.pinyin[i]}</span>
                            </div>
                            <div class="checkboxes">
                                <label class="checkbox-item correct">
                                    <input type="checkbox"> ✓
                                </label>
                                <label class="checkbox-item wrong">
                                    <input type="checkbox"> ✗
                                </label>
                            </div>
                        `;
                        grid.appendChild(div);
                    }
                });
            } else {
                // 其他类型：普通拼音训练
                currentTraining.items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'training-item';
                    div.innerHTML = `
                        <div class="pinyin">${item}</div>
                        <div class="checkboxes">
                            <label class="checkbox-item correct">
                                <input type="checkbox"> ✓
                            </label>
                            <label class="checkbox-item wrong">
                                <input type="checkbox"> ✗
                            </label>
                        </div>
                    `;
                    grid.appendChild(div);
                });
            }
        }
        
        // 前往录入界面
        function goToInput() {
            if (!currentTraining) {
                alert('请先生成训练表单');
                return;
            }
            
            inputResults = {};
            const content = document.getElementById('inputContent');
            content.innerHTML = '';
            
            const header = document.createElement('div');
            header.style.cssText = 'text-align: center; margin-bottom: 20px;';
            header.innerHTML = `
                <div style="color: #3498db; font-weight: bold; font-size: 14px;">${currentTraining.id}</div>
                <div style="color: #2c3e50; font-size: 18px; margin-top: 5px;">${currentTraining.typeName}</div>
            `;
            content.appendChild(header);
            
            const grid = document.createElement('div');
            grid.className = 'input-grid';
            
            currentTraining.items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'input-item';
                div.dataset.index = index;
                div.innerHTML = `
                    <div class="pinyin">${item}</div>
                    <div class="input-status">未选择</div>
                    <div class="mark-buttons">
                        <button type="button" class="mark-btn correct" onclick="markResult(${index}, true)">✓ 正确</button>
                        <button type="button" class="mark-btn wrong" onclick="markResult(${index}, false)">✗ 错误</button>
                    </div>
                `;
                grid.appendChild(div);
            });
            
            content.appendChild(grid);
            document.getElementById('inputActions').style.display = 'flex';
            switchScreen('input');
        }
        
        // 设置某项为正确/错误（显式选择）
        function markResult(index, isCorrect) {
            const item = document.querySelector(`.input-item[data-index="${index}"]`);
            if (!item) return;
            item.classList.remove('correct', 'wrong');
            item.classList.add(isCorrect ? 'correct' : 'wrong');
            item.querySelector('.input-status').textContent = isCorrect ? '✓ 正确' : '✗ 错误';
            inputResults[index] = !!isCorrect;
        }
        
        // 清除录入
        function clearInput() {
            inputResults = {};
            document.querySelectorAll('.input-item').forEach(item => {
                item.classList.remove('correct', 'wrong');
                const st = item.querySelector('.input-status');
                if (st) st.textContent = '未选择';
            });
        }
        
        // 保存结果
        function saveResults() {
            if (Object.keys(inputResults).length !== currentTraining.items.length) {
                if (!confirm('还有未录入的项目，确定要保存吗？')) {
                    return;
                }
            }
            
            const results = currentTraining.items.map((item, index) => ({
                pinyin: item,
                result: inputResults[index] === undefined ? null : inputResults[index]
            }));
            
            const record = {
                ...currentTraining,
                results: results,
                completedDate: new Date().toISOString()
            };
            
            saveToDatabase(record);
            if (isDashboardActive()) refreshDashboard();
            alert('✅ 保存成功！');
            
            if (githubConfig.token) {
                if (confirm('是否立即同步到GitHub？')) {
                    syncToGitHub().then(()=>{ if (isDashboardActive()) refreshDashboard(); });
                }
            }
            
            clearInput();
            switchScreen('history');
        }
        
        // 保存到数据库
        function saveToDatabase(record) {
            let database = JSON.parse(localStorage.getItem('pinyinTrainingDB') || '[]');
            database.push(record);
            localStorage.setItem('pinyinTrainingDB', JSON.stringify(database));
        }
        
        // 加载历史记录
        function loadHistory() {
            const userKey = getUserDataKey('pinyinTrainingDB');
            const database = JSON.parse(localStorage.getItem(userKey) || '[]');
            
            // 统计数据
            let totalTrainings = database.length;
            let totalItems = 0;
            let totalCorrect = 0;
            
            database.forEach(record => {
                if (record.results) {
                    record.results.forEach(r => {
                        if (r.result !== null) {
                            totalItems++;
                            if (r.result) totalCorrect++;
                        }
                    });
                }
            });
            
            document.getElementById('totalTrainings').textContent = totalTrainings;
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('avgAccuracy').textContent = totalItems > 0 ? Math.round(totalCorrect / totalItems * 100) + '%' : '0%';
            
            // 历史列表
            const list = document.getElementById('historyList');
            if (database.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 40px;">暂无训练记录</p>';
                return;
            }
            
            list.innerHTML = '';
            database.reverse().forEach((record, index) => {
                const correctCount = record.results ? record.results.filter(r => r.result === true).length : 0;
                const wrongCount = record.results ? record.results.filter(r => r.result === false).length : 0;
                const total = correctCount + wrongCount;
                const rate = total > 0 ? Math.round(correctCount / total * 100) : 0;
                
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <h3>
                        <span>${record.typeName}</span>
                        <button class="action-btn" style="padding: 5px 15px; font-size: 14px;" onclick="toggleDetails(${database.length - 1 - index})">查看详情</button>
                    </h3>
                    <div class="history-meta">
                        训练编号：${record.id} | 日期：${new Date(record.completedDate || record.date).toLocaleString('zh-CN')}
                    </div>
                    <div class="history-stats">
                        <div class="stat-box correct">✓ 正确：${correctCount}</div>
                        <div class="stat-box wrong">✗ 错误：${wrongCount}</div>
                        <div class="stat-box rate">正确率：${rate}%</div>
                    </div>
                    <div class="history-details" id="details-${database.length - 1 - index}">
                        <div class="detail-grid">
                            ${record.results ? record.results.map(r => `
                                <div class="detail-item ${r.result === true ? 'correct' : (r.result === false ? 'wrong' : '')}">${r.pinyin}</div>
                            `).join('') : ''}
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        // 切换详情显示
        function toggleDetails(index) {
            const details = document.getElementById(`details-${index}`);
            details.classList.toggle('show');
        }
        
        // 文件上传处理
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) processImage(file);
        });
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) processImage(file);
        }
        
        // 处理图像
        function processImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById('previewImage');
                img.src = e.target.result;
                img.style.display = 'block';
                
                document.getElementById('uploadArea').style.display = 'none';
                
                // 对图像进行预处理以提高OCR准确率
                enhanceImageForOCR(e.target.result).then(enhancedImage => {
                    performOCR(enhancedImage);
                }).catch(error => {
                    console.error('图像增强失败，使用原始图像', error);
                    performOCR(e.target.result);
                });
            };
            reader.readAsDataURL(file);
        }
        
        // 图像增强处理（提高OCR识别率）
        function enhanceImageForOCR(imageDataUrl) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    try {
                        // 创建canvas进行图像处理
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // 设置更大的尺寸以提高识别率
                        const scale = Math.min(2, 2000 / Math.max(img.width, img.height));
                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;
                        
                        // 绘制图像
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // 获取图像数据
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;
                        
                        // 转换为灰度并增强对比度
                        for (let i = 0; i < data.length; i += 4) {
                            // 转换为灰度
                            const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                            
                            // 增强对比度（简单的阈值处理）
                            const threshold = 128;
                            const enhanced = gray > threshold ? 255 : gray < threshold * 0.5 ? 0 : gray;
                            
                            data[i] = enhanced;     // R
                            data[i + 1] = enhanced; // G
                            data[i + 2] = enhanced; // B
                            // Alpha通道保持不变
                        }
                        
                        // 将处理后的数据放回canvas
                        ctx.putImageData(imageData, 0, 0);
                        
                        // 转换为DataURL
                        resolve(canvas.toDataURL('image/png'));
                    } catch (error) {
                        reject(error);
                    }
                };
                img.onerror = reject;
                img.src = imageDataUrl;
            });
        }
        
        // 执行OCR识别
        async function performOCR(imageData) {
            const progress = document.getElementById('ocrProgress');
            progress.classList.add('show');
            
            try {
                const worker = await Tesseract.createWorker({
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const percent = Math.round(m.progress * 100);
                            document.getElementById('progressFill').style.width = percent + '%';
                            document.getElementById('progressFill').textContent = percent + '%';
                            document.getElementById('ocrStatus').textContent = '正在识别文字...';
                        }
                    }
                });
                
                document.getElementById('ocrStatus').textContent = '加载OCR引擎...';
                await worker.loadLanguage('chi_sim');
                await worker.initialize('chi_sim');
                
                document.getElementById('ocrStatus').textContent = '正在识别文字...';
                const { data: { text } } = await worker.recognize(imageData);
                await worker.terminate();
                
                document.getElementById('ocrStatus').textContent = '正在智能解析结果...';
                
                // 智能解析训练表单
                setTimeout(() => {
                    const parsedResults = parseTrainingForm(text);
                    showOCRResults(text, parsedResults);
                }, 500);
                
            } catch (error) {
                alert('OCR识别失败：' + error.message + '\n\n建议：\n1. 确保照片清晰\n2. 尝试重新拍照\n3. 或使用手动录入功能');
                resetOCR();
            }
        }
        
        // 智能解析训练表单
        function parseTrainingForm(text) {
            const results = {
                trainingId: null,
                typeName: null,
                items: [],
                rawText: text
            };
            
            // 1. 提取训练ID（格式：T + 数字）
            const idMatch = text.match(/[T|t][\s]*(\d{10,15})/);
            if (idMatch) {
                results.trainingId = 'T' + idMatch[1];
            }
            
            // 2. 识别训练类型
            const typePatterns = [
                { pattern: /声母训练/, name: '声母训练', mode: 'shengmu' },
                { pattern: /单韵母训练/, name: '单韵母训练（带声调）', mode: 'danyunmu' },
                { pattern: /复韵母训练/, name: '复韵母训练（带声调）', mode: 'shuangyunmu' },
                { pattern: /鼻韵母训练/, name: '鼻韵母训练（带声调）', mode: 'biyunmu' },
                { pattern: /整体认读/, name: '整体认读音节训练', mode: 'zhengti' },
                { pattern: /千字文训练/, name: '千字文训练', mode: 'qianziwen' },
                { pattern: /随机.*训练/, name: '随机混合训练', mode: 'random' }
            ];
            
            for (const tp of typePatterns) {
                if (tp.pattern.test(text)) {
                    results.typeName = tp.name;
                    results.mode = tp.mode;
                    break;
                }
            }
            
            // 3. 提取拼音项和勾选状态
            // 创建所有可能的拼音列表
            const allPinyins = [
                ...pinyinDatabase.shengmu,
                ...pinyinDatabase.danyunmu,
                ...pinyinDatabase.shuangyunmu,
                ...pinyinDatabase.biyunmu,
                ...pinyinDatabase.zhengtiWithTones
            ];
            
            // 清理文本，移除多余空格和换行
            const cleanText = text.replace(/\s+/g, ' ');
            
            // 查找文本中出现的拼音
            const foundPinyins = [];
            for (const pinyin of allPinyins) {
                if (cleanText.includes(pinyin)) {
                    // 尝试检测勾选状态
                    const pinyinIndex = cleanText.indexOf(pinyin);
                    const contextBefore = cleanText.substring(Math.max(0, pinyinIndex - 20), pinyinIndex);
                    const contextAfter = cleanText.substring(pinyinIndex + pinyin.length, Math.min(cleanText.length, pinyinIndex + pinyin.length + 20));
                    
                    let result = null;
                    // 检测正确标记
                    if (/[✓√✔☑]/u.test(contextAfter) || /[✓√✔☑]/u.test(contextBefore)) {
                        result = true;
                    }
                    // 检测错误标记
                    else if (/[✗✘×X]/u.test(contextAfter) || /[✗✘×X]/u.test(contextBefore)) {
                        result = false;
                    }
                    
                    foundPinyins.push({
                        pinyin: pinyin,
                        result: result,
                        confidence: result !== null ? 'high' : 'low'
                    });
                }
            }
            
            // 对千字文特殊处理：尝试识别汉字
            if (results.mode === 'qianziwen') {
                // 提取四字句
                const hanziPattern = /[\u4e00-\u9fa5]{4}/g;
                const hanziMatches = text.match(hanziPattern);
                if (hanziMatches) {
                    hanziMatches.forEach(hanzi => {
                        // 在千字文库中查找匹配
                        const match = pinyinDatabase.qianziwen.find(item => item.hanzi === hanzi);
                        if (match) {
                            // 为每个汉字创建训练项
                            for (let i = 0; i < 4; i++) {
                                foundPinyins.push({
                                    pinyin: match.pinyin[i],
                                    hanzi: match.hanzi[i],
                                    result: null,
                                    confidence: 'medium'
                                });
                            }
                        }
                    });
                }
            }
            
            // 如果没有识别到足够的拼音，使用训练ID匹配已有记录
            if (foundPinyins.length < 10 && results.trainingId) {
                const userKey = getUserDataKey('pinyinTrainingDB');
                const database = JSON.parse(localStorage.getItem(userKey) || '[]');
                const existingRecord = database.find(r => r.id === results.trainingId);
                
                if (existingRecord && existingRecord.items) {
                    // 使用已有的训练项
                    foundPinyins.length = 0; // 清空
                    existingRecord.items.forEach(item => {
                        foundPinyins.push({
                            pinyin: typeof item === 'string' ? item : (item.pinyin ? item.pinyin.join(',') : ''),
                            hanzi: item.hanzi || '',
                            result: null,
                            confidence: 'high',
                            fromDatabase: true
                        });
                    });
                    results.typeName = existingRecord.typeName;
                    results.mode = existingRecord.mode;
                }
            }
            
            results.items = foundPinyins;
            
            return results;
        }
        
        // 存储当前OCR识别结果
        let currentOCRResults = null;
        
        // 显示OCR结果
        function showOCRResults(text, parsedResults) {
            currentOCRResults = parsedResults;
            document.getElementById('ocrProgress').classList.remove('show');
            document.getElementById('ocrResults').style.display = 'block';
            
            let html = '';
            
            // 显示识别摘要
            html += `<div style="background: #ecf0f1; padding: 20px; border-radius: 10px; margin-bottom: 20px;">`;
            html += `<h3 style="color: #2c3e50; margin-bottom: 15px;">📋 识别摘要</h3>`;
            
            if (parsedResults.trainingId) {
                html += `<div style="margin: 10px 0;">
                    <strong>训练编号：</strong>
                    <span style="color: #3498db; font-weight: bold;">${parsedResults.trainingId}</span>
                </div>`;
            } else {
                html += `<div style="margin: 10px 0;">
                    <strong>训练编号：</strong>
                    <span style="color: #e74c3c;">未识别到</span>
                    <input type="text" id="manualTrainingId" placeholder="请手动输入训练编号" style="margin-left: 10px; padding: 5px; border: 2px solid #ddd; border-radius: 5px;">
                </div>`;
            }
            
            if (parsedResults.typeName) {
                html += `<div style="margin: 10px 0;">
                    <strong>训练类型：</strong>
                    <span style="color: #27ae60;">${parsedResults.typeName}</span>
                </div>`;
            } else {
                html += `<div style="margin: 10px 0;">
                    <strong>训练类型：</strong>
                    <span style="color: #e74c3c;">未识别到</span>
                </div>`;
            }
            
            html += `<div style="margin: 10px 0;">
                <strong>识别到的训练项：</strong>
                <span style="color: #2c3e50; font-weight: bold;">${parsedResults.items.length} 个</span>
            </div>`;
            
            const withResults = parsedResults.items.filter(item => item.result !== null).length;
            html += `<div style="margin: 10px 0;">
                <strong>识别到勾选状态：</strong>
                <span style="color: ${withResults > 0 ? '#27ae60' : '#e67e22'}; font-weight: bold;">${withResults} 个</span>
                ${withResults === 0 ? '<span style="color: #7f8c8d; font-size: 13px;">（需要手动选择）</span>' : ''}
            </div>`;
            
            html += `</div>`;
            
            // 显示识别结果网格
            if (parsedResults.items.length > 0) {
                html += `<h3 style="color: #2c3e50; margin: 20px 0 10px;">✏️ 请确认并修正识别结果：</h3>`;
                html += `<div class="input-grid">`;
                
                parsedResults.items.forEach((item, index) => {
                    const displayText = item.hanzi ? `${item.hanzi} (${item.pinyin})` : item.pinyin;
                    const resultClass = item.result === true ? 'correct' : (item.result === false ? 'wrong' : '');
                    const statusText = item.result === true ? '✓ 正确' : (item.result === false ? '✗ 错误' : '未选择');
                    const confidenceBadge = item.confidence === 'high' ? '🟢' : (item.confidence === 'medium' ? '🟡' : '🔴');
                    
                    html += `
                        <div class="input-item ${resultClass}" data-index="${index}">
                            <div class="pinyin" style="font-size: 24px;">${displayText}</div>
                            <div class="input-status" style="font-size: 12px;">
                                ${confidenceBadge} ${statusText}
                            </div>
                            <div class="mark-buttons">
                                <button type="button" class="mark-btn correct" onclick="markOCRResult(${index}, true)">✓ 正确</button>
                                <button type="button" class="mark-btn wrong" onclick="markOCRResult(${index}, false)">✗ 错误</button>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                
                // 添加说明
                html += `<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #ffc107;">
                    <p style="color: #856404; margin: 0; line-height: 1.6;">
                        <strong>💡 提示：</strong><br>
                        🟢 高置信度识别 | 🟡 中等置信度识别 | 🔴 低置信度识别（需要确认）<br>
                        请仔细核对每个训练项的识别结果，特别是标记为🔴的项目。
                    </p>
                </div>`;
            } else {
                html += `<div style="padding: 40px; text-align: center; background: #fadbd8; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #e74c3c; margin-bottom: 15px;">❌ 未能识别到训练项</h3>
                    <p style="color: #c0392b;">可能原因：</p>
                    <ul style="text-align: left; max-width: 400px; margin: 15px auto; color: #7f8c8d;">
                        <li>照片不够清晰</li>
                        <li>表单角度倾斜</li>
                        <li>光线不足</li>
                        <li>字体太小或模糊</li>
                    </ul>
                    <p style="margin-top: 20px; color: #2c3e50;">
                        <strong>建议：</strong>重新拍照或使用"📝 录入结果"功能手动录入
                    </p>
                </div>`;
            }
            
            // 显示原始OCR文本（可折叠）
            html += `<details style="margin-top: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <summary style="cursor: pointer; font-weight: bold; color: #2c3e50;">🔍 查看原始OCR文本</summary>
                <pre style="background: #fff; padding: 15px; border-radius: 5px; margin-top: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; font-size: 12px; line-height: 1.5;">${text}</pre>
            </details>`;
            
            document.getElementById('ocrResultGrid').innerHTML = html;
        }
        
        // 标记OCR识别结果
        function markOCRResult(index, isCorrect) {
            if (!currentOCRResults || !currentOCRResults.items[index]) return;
            
            currentOCRResults.items[index].result = isCorrect;
            
            // 更新界面显示
            const item = document.querySelector(`.input-item[data-index="${index}"]`);
            if (item) {
                item.classList.remove('correct', 'wrong');
                item.classList.add(isCorrect ? 'correct' : 'wrong');
                const statusElement = item.querySelector('.input-status');
                if (statusElement) {
                    // 保留置信度标记
                    const confidenceBadge = statusElement.textContent.match(/[🟢🟡🔴]/)?.[0] || '';
                    statusElement.innerHTML = confidenceBadge + ' ' + (isCorrect ? '✓ 正确' : '✗ 错误');
                }
            }
        }
        
        // 批量标记所有OCR结果
        function markAllOCRResults(isCorrect) {
            if (!currentOCRResults || !currentOCRResults.items.length) return;
            
            const action = isCorrect ? '正确' : '错误';
            if (!confirm(`确定要将所有 ${currentOCRResults.items.length} 个训练项标记为"${action}"吗？\n\n标记后仍可以单独修改每个项目。`)) {
                return;
            }
            
            // 批量标记所有项
            currentOCRResults.items.forEach((item, index) => {
                markOCRResult(index, isCorrect);
            });
            
            // 显示提示
            const tip = document.createElement('div');
            tip.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(46, 204, 113, 0.95); color: white; padding: 20px 40px; border-radius: 10px; font-size: 18px; font-weight: bold; z-index: 9999; box-shadow: 0 4px 20px rgba(0,0,0,0.3);';
            tip.textContent = `✅ 已将所有项目标记为"${action}"`;
            document.body.appendChild(tip);
            
            setTimeout(() => {
                tip.style.transition = 'opacity 0.3s';
                tip.style.opacity = '0';
                setTimeout(() => tip.remove(), 300);
            }, 1500);
        }
        
        // 保存OCR结果
        function saveOCRResults() {
            if (!currentOCRResults) {
                alert('没有可保存的识别结果');
                return;
            }
            
            // 检查训练ID
            let trainingId = currentOCRResults.trainingId;
            if (!trainingId) {
                const manualInput = document.getElementById('manualTrainingId');
                if (manualInput) {
                    trainingId = manualInput.value.trim();
                }
            }
            
            if (!trainingId) {
                alert('❌ 缺少训练编号\n\n请输入训练编号后再保存。');
                return;
            }
            
            // 检查是否所有项都已标记
            const unmarkedCount = currentOCRResults.items.filter(item => item.result === null).length;
            if (unmarkedCount > 0) {
                if (!confirm(`还有 ${unmarkedCount} 个训练项未标记结果，确定要保存吗？\n\n未标记的项目将被标记为"跳过"。`)) {
                    return;
                }
            }
            
            // 构建保存记录
            const results = currentOCRResults.items.map(item => ({
                pinyin: item.hanzi ? `${item.hanzi} (${item.pinyin})` : item.pinyin,
                result: item.result
            }));
            
            const record = {
                id: trainingId,
                mode: currentOCRResults.mode || 'unknown',
                typeName: currentOCRResults.typeName || '未知类型',
                items: currentOCRResults.items.map(item => 
                    item.hanzi ? { hanzi: item.hanzi, pinyin: [item.pinyin] } : item.pinyin
                ),
                date: new Date().toISOString(),
                results: results,
                completedDate: new Date().toISOString(),
                source: 'OCR识别'
            };
            
            // 保存到数据库
            saveToDatabase(record);
            
            // 更新驾驶舱（如果打开）
            if (isDashboardActive()) refreshDashboard();
            
            // 显示成功消息
            const correctCount = results.filter(r => r.result === true).length;
            const wrongCount = results.filter(r => r.result === false).length;
            const total = correctCount + wrongCount;
            const rate = total > 0 ? Math.round(correctCount / total * 100) : 0;
            
            alert(`✅ 保存成功！\n\n训练编号：${trainingId}\n训练项数：${currentOCRResults.items.length}\n正确：${correctCount}\n错误：${wrongCount}\n正确率：${rate}%`);
            
            // 询问是否同步到GitHub
            if (githubConfig.token) {
                if (confirm('是否立即同步到GitHub？')) {
                    syncToGitHub().then(() => { 
                        if (isDashboardActive()) refreshDashboard(); 
                    });
                }
            }
            
            // 切换到历史记录页面
            resetOCR();
            switchScreen('history');
        }
        
        // 重置OCR
        function resetOCR() {
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('previewImage').style.display = 'none';
            document.getElementById('ocrProgress').classList.remove('show');
            document.getElementById('ocrResults').style.display = 'none';
            document.getElementById('fileInput').value = '';
        }
        
        // 工具函数
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        
        function regenerate() {
            startTraining(currentTraining.mode);
        }
        
        function backToSelection() {
            document.getElementById('trainingView').style.display = 'none';
            document.getElementById('selectionView').style.display = 'block';
            document.getElementById('singleSheetContainer').style.display = 'block';
            document.getElementById('batchSheetsContainer').style.display = 'none';
            document.getElementById('batchSheetsContainer').innerHTML = '';
        }
        
        // 批量打印功能
        let batchSelection = new Set();
        
        // 切换批量选项
        function toggleBatchOption(mode, element) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            if (checkbox.checked) {
                checkbox.checked = false;
                element.classList.remove('selected');
                batchSelection.delete(mode);
            } else {
                checkbox.checked = true;
                element.classList.add('selected');
                batchSelection.add(mode);
            }
            updateBatchPreview();
        }
        
        // 更新批量打印预览
        function updateBatchPreview() {
            const count = parseInt(document.getElementById('batchCount').value) || 1;
            const preview = document.getElementById('batchPreview');
            const previewList = document.getElementById('batchPreviewList');
            const totalPages = document.getElementById('totalPages');
            const printBtn = document.getElementById('batchPrintBtn');
            
            if (batchSelection.size === 0) {
                preview.style.display = 'none';
                printBtn.disabled = true;
                totalPages.textContent = '0';
                return;
            }
            
            preview.style.display = 'block';
            printBtn.disabled = false;
            
            const typeNames = {
                'shengmu': '声母训练',
                'danyunmu': '单韵母训练',
                'shuangyunmu': '复韵母训练',
                'biyunmu': '鼻韵母训练',
                'zhengti': '整体认读训练',
                'qianziwen': '千字文训练',
                'random': '随机混合训练'
            };
            
            let html = '';
            let total = 0;
            batchSelection.forEach(mode => {
                html += `<div class="batch-preview-item">
                    <span>${typeNames[mode]}</span>
                    <span style="color: #3498db; font-weight: bold;">${count} 份</span>
                </div>`;
                total += count;
            });
            
            previewList.innerHTML = html;
            totalPages.textContent = total;
        }
        
        // 清除批量选择
        function clearBatchSelection() {
            batchSelection.clear();
            document.querySelectorAll('.batch-option').forEach(opt => {
                opt.classList.remove('selected');
                opt.querySelector('input[type="checkbox"]').checked = false;
            });
            updateBatchPreview();
        }
        
        // 生成批量打印表单
        function generateBatchPrint() {
            if (batchSelection.size === 0) {
                alert('请至少选择一种训练类型！');
                return;
            }
            
            const count = parseInt(document.getElementById('batchCount').value) || 1;
            const container = document.getElementById('batchSheetsContainer');
            container.innerHTML = '';
            
            const typeNames = {
                'shengmu': '声母训练',
                'danyunmu': '单韵母训练（带声调）',
                'shuangyunmu': '复韵母训练（带声调）',
                'biyunmu': '鼻韵母训练（带声调）',
                'zhengti': '整体认读音节训练',
                'qianziwen': '千字文训练',
                'random': '随机混合训练'
            };
            
            let sheetIndex = 0;
            const totalSheets = batchSelection.size * count;
            
            batchSelection.forEach(mode => {
                for (let i = 0; i < count; i++) {
                    sheetIndex++;
                    
                    // 获取训练项
                    let items = [];
                    switch(mode) {
                        case 'shengmu':
                            items = [...pinyinDatabase.shengmu];
                            break;
                        case 'danyunmu':
                            items = [...pinyinDatabase.danyunmu];
                            break;
                        case 'shuangyunmu':
                            items = [...pinyinDatabase.shuangyunmu];
                            break;
                        case 'biyunmu':
                            items = [...pinyinDatabase.biyunmu];
                            break;
                        case 'zhengti':
                            items = [...pinyinDatabase.zhengtiWithTones];
                            break;
                        case 'qianziwen':
                            // 千字文：随机选8句四字句
                            items = shuffleArray([...pinyinDatabase.qianziwen]).slice(0, 8);
                            break;
                        case 'random':
                            items = [...pinyinDatabase.shengmu, ...pinyinDatabase.yunmuWithTones, ...pinyinDatabase.zhengtiWithTones];
                            break;
                    }
                    
                    // 千字文已在case中处理，其他类型需要打乱并截取
                    if (mode !== 'qianziwen') {
                        items = shuffleArray(items).slice(0, itemsPerPage);
                    }
                    
                    // 创建表单
                    const trainingId = 'T' + Date.now() + '-' + sheetIndex;
                    const sheetDiv = document.createElement('div');
                    sheetDiv.className = 'training-sheet';
                    
                    // 生成训练项HTML
                    let trainingItemsHTML = '';
                    if (mode === 'qianziwen') {
                        // 千字文：每个sentence是四字句对象，展开为4个训练项
                        items.forEach(sentence => {
                            for (let i = 0; i < 4; i++) {
                                trainingItemsHTML += `
                                    <div class="training-item">
                                        <div class="pinyin" style="display: flex; flex-direction: column; gap: 5px;">
                                            <span style="font-size: 28px; color: #e74c3c;">${sentence.hanzi[i]}</span>
                                            <span style="font-size: 20px;">${sentence.pinyin[i]}</span>
                                        </div>
                                        <div class="checkboxes">
                                            <label class="checkbox-item correct">
                                                <input type="checkbox"> ✓
                                            </label>
                                            <label class="checkbox-item wrong">
                                                <input type="checkbox"> ✗
                                            </label>
                                        </div>
                                    </div>
                                `;
                            }
                        });
                    } else {
                        // 普通拼音训练
                        trainingItemsHTML = items.map(item => `
                            <div class="training-item">
                                <div class="pinyin">${item}</div>
                                <div class="checkboxes">
                                    <label class="checkbox-item correct">
                                        <input type="checkbox"> ✓
                                    </label>
                                    <label class="checkbox-item wrong">
                                        <input type="checkbox"> ✗
                                    </label>
                                </div>
                            </div>
                        `).join('');
                    }
                    
                    sheetDiv.innerHTML = `
                        <div class="training-header">
                            <h2>桐桐拼音训练记录表</h2>
                            <div class="training-info">
                                训练日期：________年____月____日　　训练者：__________
                            </div>
                            <div class="training-id">训练编号：${trainingId}</div>
                            <div class="training-type">${typeNames[mode]}</div>
                        </div>
                        
                        <div class="training-grid">
                            ${trainingItemsHTML}
                        </div>
                    `;
                    
                    container.appendChild(sheetDiv);
                    
                    // 添加分页符（除了最后一页）
                    if (sheetIndex < totalSheets - 1) {
                        const divider = document.createElement('div');
                        divider.className = 'page-divider';
                        container.appendChild(divider);
                    }
                }
            });
            
            // 显示批量打印视图
            document.getElementById('selectionView').style.display = 'none';
            document.getElementById('trainingView').style.display = 'block';
            document.getElementById('singleSheetContainer').style.display = 'none';
            container.style.display = 'block';
            
            // 添加批量打印专用按钮
            const actionDiv = document.createElement('div');
            actionDiv.className = 'action-buttons';
            actionDiv.innerHTML = `
                <button class="action-btn success" onclick="window.print()">🖨️ 打印全部 ${totalSheets} 页</button>
                <button class="action-btn secondary" onclick="backToSelection()">← 返回选择</button>
            `;
            container.appendChild(actionDiv);
            
            alert(`✅ 已生成 ${totalSheets} 张训练表单！\n点击"打印全部"按钮开始打印。`);
        }
        
        // 监听批量数量变化
        document.addEventListener('DOMContentLoaded', function() {
            const batchCountInput = document.getElementById('batchCount');
            if (batchCountInput) {
                batchCountInput.addEventListener('input', updateBatchPreview);
            }
        });
        
        // 打印拼音库（不含图片）
        function printLibrary() {
            // 添加打印专用类，隐藏图片
            document.body.classList.add('print-no-images');
            
            // 提示用户
            alert('💡 打印提示：\n\n' +
                  '1. 建议选择"纵向"方向\n' +
                  '2. 纸张大小：A4\n' +
                  '3. 页边距：默认或窄边距\n' +
                  '4. 不包含图片，仅打印拼音文字\n' +
                  '5. 黑白打印效果更好\n\n' +
                  '点击确定后进入打印预览。');
            
            // 延迟以确保样式生效
            setTimeout(() => {
                window.print();
                // 打印完成后移除类
                setTimeout(() => {
                    document.body.classList.remove('print-no-images');
                }, 1000);
            }, 100);
        }
        
        // 打印拼音库（含图片）
        function printLibraryWithImages() {
            // 检查是否有上传的图片
            const hasImages = Object.keys(pinyinImages).length > 0;
            
            if (!hasImages) {
                if (confirm('当前还没有上传任何图片。\n\n是否继续打印纯文字版本？')) {
                    printLibrary();
                }
                return;
            }
            
            // 提示用户
            alert('💡 打印提示：\n\n' +
                  '1. 建议选择"纵向"方向\n' +
                  '2. 纸张大小：A4\n' +
                  '3. 页边距：默认或窄边距\n' +
                  '4. 包含已上传的图片\n' +
                  '5. 建议彩色打印以显示图片\n' +
                  `6. 当前有 ${Object.keys(pinyinImages).length} 个拼音有图片\n\n` +
                  '点击确定后进入打印预览。');
            
            // 延迟以确保样式生效
            setTimeout(() => {
                window.print();
            }, 100);
        }

        // GitHub配置
        let githubConfig = {
            token: localStorage.getItem('github_token') || '',
            username: localStorage.getItem('github_username') || 'Jiaming-Yi',
            repo: localStorage.getItem('github_repo') || 'pingyinxulian'
        };
        
        // 用户信息同步到GitHub
        async function syncUsersToGitHub() {
            if (!githubConfig.token) {
                console.log('未配置GitHub Token，跳过用户同步');
                return false;
            }
            
            try {
                const usersData = localStorage.getItem('users') || '{}';
                const content = btoa(unescape(encodeURIComponent(usersData)));
                const fileName = 'data/users.json';
                
                let sha = null;
                try {
                    const getResponse = await fetch(
                        `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/${fileName}`,
                        { headers: getGitHubHeaders(false) }
                    );
                    if (getResponse.ok) {
                        const fileData = await getResponse.json();
                        sha = fileData.sha;
                    }
                } catch (e) {}
                
                const uploadData = {
                    message: `更新用户信息 - ${new Date().toLocaleString('zh-CN')}`,
                    content: content,
                    branch: 'main'
                };
                if (sha) uploadData.sha = sha;
                
                const response = await fetch(
                    `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/${fileName}`,
                    {
                        method: 'PUT',
                        headers: getGitHubHeaders(true),
                        body: JSON.stringify(uploadData)
                    }
                );
                
                return response.ok;
            } catch (error) {
                console.error('用户信息同步失败:', error);
                return false;
            }
        }
        
        // 从GitHub下载用户信息
        async function syncUsersFromGitHub() {
            if (!githubConfig.token) {
                return false;
            }
            
            try {
                const fileName = 'data/users.json';
                const response = await fetch(
                    `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/${fileName}`,
                    { headers: getGitHubHeaders(false) }
                );
                
                if (response.ok) {
                    const fileData = await response.json();
                    const content = decodeURIComponent(escape(atob(fileData.content)));
                    
                    // 合并本地和云端用户
                    const cloudUsers = JSON.parse(content);
                    const localUsers = JSON.parse(localStorage.getItem('users') || '{}');
                    
                    // 合并用户（云端优先，但保留本地新用户）
                    const mergedUsers = { ...localUsers, ...cloudUsers };
                    
                    localStorage.setItem('users', JSON.stringify(mergedUsers));
                    users = mergedUsers;
                    
                    return true;
                }
                return false;
            } catch (error) {
                console.error('用户信息下载失败:', error);
                return false;
            }
        }

        // 统一构建GitHub Headers，清洗Token避免非ASCII字符
        function getSanitizedToken() {
            return (githubConfig.token || '').trim().replace(/[^\x00-\x7F]/g, '');
        }
        function getGitHubHeaders(includeJson = false) {
            const token = getSanitizedToken();
            const headers = {
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/vnd.github+json',
                'X-GitHub-Api-Version': '2022-11-28'
            };
            if (includeJson) headers['Content-Type'] = 'application/json';
            return headers;
        }

        // 加载配置
        function loadGitHubConfig() {
            document.getElementById('githubToken').value = githubConfig.token;
            document.getElementById('githubUsername').value = githubConfig.username;
            document.getElementById('githubRepo').value = githubConfig.repo;
            updateLocalDataInfo();
        }

        // 保存GitHub配置
        function saveGitHubConfig() {
            githubConfig.token = document.getElementById('githubToken').value.trim();
            githubConfig.username = document.getElementById('githubUsername').value.trim();
            githubConfig.repo = document.getElementById('githubRepo').value.trim();
            
            if (!githubConfig.token || !githubConfig.username || !githubConfig.repo) {
                showSyncStatus('error', '❌ 请填写完整的GitHub配置信息');
                return;
            }
            
            localStorage.setItem('github_token', githubConfig.token);
            localStorage.setItem('github_username', githubConfig.username);
            localStorage.setItem('github_repo', githubConfig.repo);
            
            showSyncStatus('success', '✅ GitHub配置已保存');
        }
        
        // 手动同步账户信息
        async function syncUsersManually() {
            if (!githubConfig.token) {
                showSyncStatus('error', '❌ 请先配置GitHub Token');
                return;
            }
            
            const action = confirm('选择同步方向：\n\n点击"确定"：上传本地账户到云端\n点击"取消"：从云端下载账户到本地');
            
            if (action) {
                // 上传
                showSyncStatus('info', '⏳ 正在上传账户信息...');
                const success = await syncUsersToGitHub();
                if (success) {
                    showSyncStatus('success', '✅ 账户信息已上传到GitHub');
                } else {
                    showSyncStatus('error', '❌ 上传失败');
                }
            } else {
                // 下载
                showSyncStatus('info', '⏳ 正在下载账户信息...');
                const success = await syncUsersFromGitHub();
                if (success) {
                    showSyncStatus('success', '✅ 账户信息已从GitHub下载');
                    users = JSON.parse(localStorage.getItem('users') || '{}');
                } else {
                    showSyncStatus('error', '❌ 下载失败，可能云端还没有账户数据');
                }
            }
        }

        // 上传数据到GitHub
        async function syncToGitHub() {
            if (!githubConfig.token) {
                showSyncStatus('error', '❌ 请先配置GitHub Token');
                return;
            }
            
            if (!currentUser) {
                showSyncStatus('error', '❌ 请先登录');
                return;
            }
            
            showSyncStatus('info', '⏳ 正在上传数据到GitHub...');
            
            try {
                const userKey = getUserDataKey('pinyinTrainingDB');
                const database = JSON.parse(localStorage.getItem(userKey) || '[]');
                const content = JSON.stringify(database, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(content)));
                
                // 使用用户名创建独立的文件
                const fileName = `data/${currentUser.username}_training_records.json`;
                
                let sha = null;
                try {
                    const getResponse = await fetch(
                        `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/${fileName}`,
                        {
                            headers: getGitHubHeaders(false)
                        }
                    );
                    if (getResponse.ok) {
                        const fileData = await getResponse.json();
                        sha = fileData.sha;
                    }
                } catch (e) {}
                
                const uploadData = {
                    message: `更新训练记录 - ${currentUser.displayName} - ${new Date().toLocaleString('zh-CN')}`,
                    content: encodedContent,
                    branch: 'main'
                };
                if (sha) uploadData.sha = sha;
                
                const response = await fetch(
                    `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/${fileName}`,
                    {
                        method: 'PUT',
                        headers: getGitHubHeaders(true),
                        body: JSON.stringify(uploadData)
                    }
                );
                
                if (response.ok) {
                    showSyncStatus('success', `✅ 数据已成功上传到GitHub（${database.length}条记录）`);
                    localStorage.setItem('last_sync_time', new Date().toISOString());
                    if (isDashboardActive()) refreshDashboard();
                } else {
                    const error = await response.json().catch(()=>({ message: response.statusText }));
                    showSyncStatus('error', `❌ 上传失败: ${error.message}`);
                }
            } catch (error) {
                const msg = (error && error.message) ? error.message : String(error);
                if (/non ISO-8859-1|ISO-8859-1|headers/i.test(msg)) {
                    showSyncStatus('error', '❌ 上传出错：Token或请求头包含非ASCII字符。请在设置中重新粘贴纯英文的Token，并去除空格或全角字符。');
                } else {
                    showSyncStatus('error', `❌ 上传出错: ${msg}`);
                }
            }
        }

        // 从GitHub下载数据
        async function syncFromGitHub() {
            if (!githubConfig.token) {
                showSyncStatus('error', '❌ 请先配置GitHub Token');
                return;
            }
            
            if (!currentUser) {
                showSyncStatus('error', '❌ 请先登录');
                return;
            }
            
            showSyncStatus('info', '⏳ 正在从GitHub下载数据...');
            
            try {
                const fileName = `data/${currentUser.username}_training_records.json`;
                const response = await fetch(
                    `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/${fileName}`,
                    {
                        headers: getGitHubHeaders(false)
                    }
                );
                
                if (response.ok) {
                    const fileData = await response.json();
                    const content = decodeURIComponent(escape(atob(fileData.content)));
                    const database = JSON.parse(content);
                    
                    // 合并本地和云端数据（去重）
                    const userKey = getUserDataKey('pinyinTrainingDB');
                    const localDB = JSON.parse(localStorage.getItem(userKey) || '[]');
                    const mergedDB = mergeTrainingData(localDB, database);
                    
                    localStorage.setItem(userKey, JSON.stringify(mergedDB));
                    localStorage.setItem('last_sync_time', new Date().toISOString());
                    
                    showSyncStatus('success', `✅ 数据已成功从GitHub下载（${database.length}条记录，合并后${mergedDB.length}条）`);
                    updateLocalDataInfo();
                    
                    if (document.getElementById('historyScreen').classList.contains('active')) {
                        loadHistory();
                    }
                } else if (response.status === 404) {
                    showSyncStatus('info', '⚠️ GitHub上还没有数据文件，请先上传数据');
                } else {
                    const error = await response.json().catch(()=>({ message: response.statusText }));
                    showSyncStatus('error', `❌ 下载失败: ${error.message}`);
                }
            } catch (error) {
                const msg = (error && error.message) ? error.message : String(error);
                if (/non ISO-8859-1|ISO-8859-1|headers/i.test(msg)) {
                    showSyncStatus('error', '❌ 下载出错：Token或请求头包含非ASCII字符。请在设置中重新粘贴纯英文的Token，并去除空格或全角字符。');
                } else {
                    showSyncStatus('error', `❌ 下载出错: ${msg}`);
                }
            }
        }

        // 合并训练数据（去重）
        function mergeTrainingData(local, remote) {
            const merged = [...local];
            const existingIds = new Set(local.map(r => r.id));
            
            remote.forEach(record => {
                if (!existingIds.has(record.id)) {
                    merged.push(record);
                    existingIds.add(record.id);
                }
            });
            
            // 按日期排序
            merged.sort((a, b) => new Date(a.date) - new Date(b.date));
            return merged;
        }

        // 显示同步状态
        function showSyncStatus(type, message) {
            const statusDiv = document.getElementById('syncStatus');
            statusDiv.className = `sync-status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'flex';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // 更新本地数据信息
        function updateLocalDataInfo() {
            const userKey = getUserDataKey('pinyinTrainingDB');
            const database = JSON.parse(localStorage.getItem(userKey) || '[]');
            const lastSync = localStorage.getItem('last_sync_time');
            
            let info = `本地共有 ${database.length} 条训练记录`;
            if (lastSync) {
                info += `<br>上次同步: ${new Date(lastSync).toLocaleString('zh-CN')}`;
            }
            
            document.getElementById('localDataInfo').innerHTML = info;
        }

        // 导出本地数据
        function exportLocalData() {
            const userKey = getUserDataKey('pinyinTrainingDB');
            const database = JSON.parse(localStorage.getItem(userKey) || '[]');
            const dataStr = JSON.stringify(database, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pinyin_training_data_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showSyncStatus('success', '✅ 数据已导出');
        }

        // 清除本地数据
        function clearLocalData() {
            if (confirm('确定要清除所有本地训练数据吗？\n\n建议先上传到GitHub或导出备份！')) {
                const userKey = getUserDataKey('pinyinTrainingDB');
                localStorage.removeItem(userKey);
                updateLocalDataInfo();
                showSyncStatus('success', '✅ 本地数据已清除');
            }
        }

        function refreshDashboard() {
            const userKey = getUserDataKey('pinyinTrainingDB');
            const db = JSON.parse(localStorage.getItem(userKey) || '[]');
            // KPI统计
            let totalTrainings = db.length;
            let totalItems = 0;
            let totalCorrect = 0;
            db.forEach(r => {
                if (r.results && Array.isArray(r.results)) {
                    r.results.forEach(x => {
                        if (x.result !== null) {
                            totalItems++;
                            if (x.result) totalCorrect++;
                        }
                    });
                }
            });
            document.getElementById('kpiTotalTimes').textContent = totalTrainings;
            document.getElementById('kpiTotalItems').textContent = totalItems;
            document.getElementById('kpiAvgRate').textContent = totalItems ? Math.round(totalCorrect * 100 / totalItems) + '%' : '0%';
            
            // 近7天趋势（按日期）
            const last7 = Array.from({length: 7}).map((_,i)=>{
                const d = new Date();
                d.setDate(d.getDate() - (6 - i));
                const key = d.toISOString().slice(0,10);
                return { key, items:0, correct:0 };
            });
            const map = new Map(last7.map(x=>[x.key,x]));
            db.forEach(r => {
                const key = (r.completedDate || r.date || '').slice(0,10);
                const bucket = map.get(key);
                if (!bucket) return;
                if (r.results) {
                    r.results.forEach(x=>{
                        if (x.result !== null) {
                            bucket.items++;
                            if (x.result) bucket.correct++;
                        }
                    });
                }
            });
            drawTrendChart(last7);
            
            // 易错Top10
            const mistakeMap = new Map(); // pinyin -> {wrong,total}
            db.forEach(r=>{
                if (!r.results) return;
                r.results.forEach(x=>{
                    if (x.result === null) return;
                    const rec = mistakeMap.get(x.pinyin) || {wrong:0,total:0};
                    rec.total++;
                    if (!x.result) rec.wrong++;
                    mistakeMap.set(x.pinyin, rec);
                });
            });
            const sorted = Array.from(mistakeMap.entries())
                .filter(([p,{total}])=>total>=2)
                .sort((a,b)=> b[1].wrong - a[1].wrong)
                .slice(0,10);
            const list = document.getElementById('topMistakes');
            list.innerHTML = '';
            sorted.forEach(([p,rec])=>{
                const rate = rec.total ? Math.round((rec.total - rec.wrong)*100/rec.total) : 0;
                const rowP = document.createElement('div'); rowP.className='item'; rowP.textContent = p; list.appendChild(rowP);
                const rowW = document.createElement('div'); rowW.className='item'; rowW.textContent = `错${rec.wrong}`; list.appendChild(rowW);
                const rowR = document.createElement('div'); rowR.className='item'; rowR.textContent = `${rate}%`; list.appendChild(rowR);
            });
            
            // 按类型统计
            const typeKeys = [
                { key:'shengmu', label:'声母' },
                { key:'danyunmu', label:'单韵母' },
                { key:'shuangyunmu', label:'复韵母' },
                { key:'biyunmu', label:'鼻韵母' },
                { key:'zhengti', label:'整体认读' },
                { key:'qianziwen', label:'千字文' },
                { key:'random', label:'随机' }
            ];
            const typeAgg = new Map(typeKeys.map(t=>[t.key,{ label:t.label, items:0, correct:0 }]));
            db.forEach(r=>{
                const k = r.mode || 'random';
                const bucket = typeAgg.get(k) || typeAgg.get('random');
                if (!bucket) return;
                if (Array.isArray(r.results)) {
                    r.results.forEach(x=>{
                        if (x.result !== null) {
                            bucket.items++;
                            if (x.result) bucket.correct++;
                        }
                    });
                }
            });
            const typePoints = typeKeys.map(t=>{
                const b = typeAgg.get(t.key) || { items:0, correct:0, label:t.label };
                return { label:t.label, items:b.items, rate: b.items? Math.round(b.correct*100/b.items):0 };
            });
            drawTypeChart(typePoints);
            
            // 逐项统计更新
            buildElementStatsCache(db);
            renderElementTable();
        }
        
        function drawTrendChart(points){
            const canvas = document.getElementById('trendChart');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0,0,canvas.width,canvas.height);
            const W=canvas.width,H=canvas.height, P=40;
            ctx.strokeStyle='#ccc'; ctx.lineWidth=1;
            ctx.beginPath(); ctx.moveTo(P,P); ctx.lineTo(P,H-P); ctx.lineTo(W-P,H-P); ctx.stroke();
            const labels = points.map(p=>p.key.slice(5));
            const maxItems = Math.max(1, ...points.map(p=>p.items));
            const itemsY = v => H-P - (v/maxItems)*(H-2*P);
            const xStep = (W-2*P)/(points.length-1 || 1);
            ctx.fillStyle='rgba(52,152,219,0.25)';
            points.forEach((p,i)=>{
                const x = P + i*xStep - 10;
                const y = itemsY(p.items);
                ctx.fillRect(x, y, 20, (H-P)-y);
            });
            ctx.strokeStyle='#e67e22'; ctx.lineWidth=2; ctx.beginPath();
            points.forEach((p,i)=>{
                const rate = p.items ? p.correct*100/p.items : 0;
                const y = H-P - (rate/100)*(H-2*P);
                const x = P + i*xStep;
                if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            });
            ctx.stroke();
            ctx.fillStyle='#7f8c8d'; ctx.font='12px Arial'; ctx.textAlign='center';
            labels.forEach((lb,i)=>{ const x=P+i*xStep; ctx.fillText(lb,x,H-P+14); });
        }
        
        function drawTypeChart(points){
            const canvas = document.getElementById('typeChart');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0,0,canvas.width,canvas.height);
            const W=canvas.width,H=canvas.height,P=40;
            ctx.strokeStyle='#ccc'; ctx.lineWidth=1;
            ctx.beginPath(); ctx.moveTo(P,P); ctx.lineTo(P,H-P); ctx.lineTo(W-P,H-P); ctx.stroke();
            const maxItems = Math.max(1, ...points.map(p=>p.items));
            const barW = 28;
            const xStep = (W-2*P)/points.length;
            points.forEach((p,i)=>{
                const x = P + i*xStep + (xStep-barW)/2;
                const y = H-P - (p.items/maxItems)*(H-2*P);
                ctx.fillStyle='rgba(46,204,113,0.35)';
                ctx.fillRect(x, y, barW, (H-P)-y);
                ctx.fillStyle='#e67e22'; ctx.font='12px Arial'; ctx.textAlign='center';
                ctx.fillText(p.rate + '%', x+barW/2, y-6);
                ctx.fillStyle='#7f8c8d';
                ctx.fillText(p.label, x+barW/2, H-P+14);
            });
        }
        
        let dashboardTimer = null;
        function startDashboardAutoRefresh(){
            stopDashboardAutoRefresh();
            dashboardTimer = setInterval(()=>{
                if (isDashboardActive()) refreshDashboard();
            }, 60000);
        }
        function stopDashboardAutoRefresh(){
            if (dashboardTimer) { clearInterval(dashboardTimer); dashboardTimer = null; }
        }
        function isDashboardActive(){
            const el = document.getElementById('dashboardScreen');
            return el && el.classList.contains('active');
        }
        
        async function syncFromGitHubAndRefresh(){
            if (typeof syncFromGitHub === 'function') {
                await syncFromGitHub();
                if (isDashboardActive()) refreshDashboard();
            } else {
                alert('当前版本不支持GitHub同步。');
            }
        }
        
        // —— 逐项统计逻辑 ——
        let elemStats = [];
        function detectPinyinType(p){
            if (pinyinDatabase && Array.isArray(pinyinDatabase.shengmu) && pinyinDatabase.shengmu.includes(p)) return '声母';
            if (pinyinDatabase && Array.isArray(pinyinDatabase.danyunmu) && pinyinDatabase.danyunmu.includes(p)) return '单韵母';
            if (pinyinDatabase && Array.isArray(pinyinDatabase.shuangyunmu) && pinyinDatabase.shuangyunmu.includes(p)) return '复韵母';
            if (pinyinDatabase && Array.isArray(pinyinDatabase.biyunmu) && pinyinDatabase.biyunmu.includes(p)) return '鼻韵母';
            if (pinyinDatabase && Array.isArray(pinyinDatabase.zhengtiWithTones) && pinyinDatabase.zhengtiWithTones.includes(p)) return '整体认读';
            if (pinyinDatabase && Array.isArray(pinyinDatabase.qianziwen) && pinyinDatabase.qianziwen.includes(p)) return '千字文';
            return '';
        }
        function buildElementStatsCache(db){
            const map = new Map();
            db.forEach(r=>{
                const dt = new Date(r.completedDate || r.date || '').toISOString();
                (r.results||[]).forEach(x=>{
                    if (x.result === null) return;
                    const key = x.pinyin;
                    const rec = map.get(key) || { pinyin:key, type: detectPinyinType(key), tries:0, correct:0, wrong:0, latest:'' };
                    rec.tries++;
                    if (x.result) rec.correct++; else rec.wrong++;
                    if (!rec.latest || dt > rec.latest) rec.latest = dt;
                    map.set(key, rec);
                });
            });
            elemStats = Array.from(map.values()).map(r=>({
                ...r,
                acc: r.tries ? Math.round(r.correct*100/r.tries) : 0
            }));
        }
        function renderElementTable(){
            const body = document.getElementById('elemTableBody');
            const q = (document.getElementById('elemSearch')?.value || '').trim().toLowerCase();
            const t = document.getElementById('elemTypeFilter')?.value || '';
            const sort = document.getElementById('elemSort')?.value || 'tries_desc';
            let rows = elemStats.slice();
            if (q) rows = rows.filter(r=> r.pinyin.toLowerCase().includes(q));
            if (t) rows = rows.filter(r=> r.type === t);
            switch(sort){
                case 'tries_desc': rows.sort((a,b)=> b.tries-a.tries || a.pinyin.localeCompare(b.pinyin)); break;
                case 'acc_desc': rows.sort((a,b)=> b.acc-a.acc || b.tries-a.tries); break;
                case 'wrong_desc': rows.sort((a,b)=> b.wrong-a.wrong || b.tries-a.tries); break;
                case 'latest_desc': rows.sort((a,b)=> (b.latest||'').localeCompare(a.latest||'') || b.tries-a.tries); break;
                case 'pinyin_asc': rows.sort((a,b)=> a.pinyin.localeCompare(b.pinyin)); break;
            }
            body.innerHTML = rows.map(r=>
                `<tr>
                    <td>${r.pinyin}</td>
                    <td>${r.type||''}</td>
                    <td>${r.tries}</td>
                    <td>${r.correct}</td>
                    <td>${r.wrong}</td>
                    <td>${r.acc}%</td>
                    <td>${r.latest? new Date(r.latest).toLocaleString('zh-CN'):''}</td>
                </tr>`
            ).join('');
            document.getElementById('elemSummary').textContent = `共 ${rows.length} 个拼音条目`;
        }
        function exportElementCsv(){
            // 基于当前筛选渲染数据导出
            const q = (document.getElementById('elemSearch')?.value || '').trim().toLowerCase();
            const t = document.getElementById('elemTypeFilter')?.value || '';
            const sort = document.getElementById('elemSort')?.value || 'tries_desc';
            let rows = elemStats.slice();
            if (q) rows = rows.filter(r=> r.pinyin.toLowerCase().includes(q));
            if (t) rows = rows.filter(r=> r.type === t);
            switch(sort){
                case 'tries_desc': rows.sort((a,b)=> b.tries-a.tries || a.pinyin.localeCompare(b.pinyin)); break;
                case 'acc_desc': rows.sort((a,b)=> b.acc-a.acc || b.tries-a.tries); break;
                case 'wrong_desc': rows.sort((a,b)=> b.wrong-a.wrong || b.tries-a.tries); break;
                case 'latest_desc': rows.sort((a,b)=> (b.latest||'').localeCompare(a.latest||'') || b.tries-a.tries); break;
                case 'pinyin_asc': rows.sort((a,b)=> a.pinyin.localeCompare(b.pinyin)); break;
            }
            const header = ['拼音','类型','尝试','正确','错误','正确率','最近训练'];
            const lines = [header.join(',')].concat(rows.map(r=>[
                r.pinyin,
                r.type||'',
                r.tries,
                r.correct,
                r.wrong,
                r.acc+'%',
                r.latest? new Date(r.latest).toLocaleString('zh-CN'):''
            ].map(v=> `"${String(v).replace(/"/g,'""')}"`).join(',')));
            const blob = new Blob(["\uFEFF"+lines.join('\n')], {type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `pinyin_element_stats_${new Date().toISOString().slice(0,10)}.csv`;
            a.click(); URL.revokeObjectURL(url);
        }
    </script>
</body>
</html> 
